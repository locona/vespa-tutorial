<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Vespaチュートリアル</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Vespaチュートリアル</h1>
<div class="details">
<span id="revnumber">version 1.1.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#setup">1. Vespa 環境の構築</a>
<ul class="sectlevel2">
<li><a href="#setup_install">1.1. Vespa のインストール</a></li>
<li><a href="#setup_boot">1.2. Vespa の起動</a>
<ul class="sectlevel3">
<li><a href="#setup_boot_env">1.2.1. 環境変数の設定</a></li>
<li><a href="#setup_boot_configserver">1.2.2. configserver の起動</a></li>
<li><a href="#setup_boot_configsetinel">1.2.3. vespa-config-sentinel の起動</a></li>
</ul>
</li>
<li><a href="#setup_tutorial">1.3. チュートリアル環境の構築</a></li>
</ul>
</li>
<li><a href="#config">2. Vespa の設定</a>
<ul class="sectlevel2">
<li><a href="#config_file">2.1. 設定ファイル</a>
<ul class="sectlevel3">
<li><a href="#config_file_hosts">2.1.1. hosts.xml</a></li>
<li><a href="#config_file_services">2.1.2. services.xml</a></li>
<li><a href="#config_file_searchdefinitions">2.1.3. searchdefinitions</a></li>
</ul>
</li>
<li><a href="#config_deploy">2.2. Vespa へのデプロイ</a>
<ul class="sectlevel3">
<li><a href="#config_deploy_tokenizer">2.2.1. 日本語トークナイザの配置</a></li>
<li><a href="#config_deploy_prepare">2.2.2. 設定ファイルのアップロード</a></li>
<li><a href="#config_deploy_activate">2.2.3. 設定ファイルの反映</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#update">3. Vespa と更新</a>
<ul class="sectlevel2">
<li><a href="#update_request">3.1. 更新リクエスト</a>
<ul class="sectlevel3">
<li><a href="#update_request_docid">3.1.1. ドキュメント ID</a></li>
<li><a href="#update_request_put">3.1.2. put</a></li>
<li><a href="#update_request_update">3.1.3. update</a></li>
<li><a href="#update_request_remove">3.1.4. remove</a></li>
</ul>
</li>
<li><a href="#update_document">3.2. ドキュメントの更新</a>
<ul class="sectlevel3">
<li><a href="#update_document_client">3.2.1. Client の実行方法</a></li>
<li><a href="#update_document_sample">3.2.2. サンプルデータの登録</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search">4. Vespa と検索</a>
<ul class="sectlevel2">
<li><a href="#search_query">4.1. 検索クエリ</a>
<ul class="sectlevel3">
<li><a href="#search_query_language">4.1.1. language (lang)</a></li>
<li><a href="#search_query_query">4.1.2. query</a></li>
<li><a href="#search_query_hits-offset">4.1.3. hits (count), offset (start)</a></li>
<li><a href="#search_query_sorting">4.1.4. sorting</a></li>
<li><a href="#search_query_filter-recall">4.1.5. filter, recall</a></li>
<li><a href="#search_query_summary">4.1.6. summary</a></li>
<li><a href="#search_query_format">4.1.7. format</a></li>
<li><a href="#search_query_timeout">4.1.8. timeout</a></li>
<li><a href="#search_query_tracelevel">4.1.9. tracelevel</a></li>
</ul>
</li>
<li><a href="#search_grouping">4.2. グルーピング検索</a>
<ul class="sectlevel3">
<li><a href="#search_grouping_syntax">4.2.1. グルーピングの構文</a></li>
<li><a href="#search_grouping_example">4.2.2. グルーピングの具体例</a></li>
</ul>
</li>
<li><a href="#search_other">4.3. その他の検索</a>
<ul class="sectlevel3">
<li><a href="#search_other_spatial">4.3.1. 位置検索</a></li>
<li><a href="#search_other_wand">4.3.2. WAND 検索</a></li>
<li><a href="#search_other_predicate">4.3.3. Predicate フィールド</a></li>
<li><a href="#search_other_streaming">4.3.4. ストリーミング検索</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ranking">5. Vespa とランキング</a>
<ul class="sectlevel2">
<li><a href="#ranking_phase">5.1. ランキングの流れ</a>
<ul class="sectlevel3">
<li><a href="#ranking_phase_match">5.1.1. match-phase</a></li>
<li><a href="#ranking_phase_first">5.1.2. first-phase</a></li>
<li><a href="#ranking_phase_second">5.1.3. second-phase</a></li>
</ul>
</li>
<li><a href="#ranking_profile">5.2. rank-profile</a>
<ul class="sectlevel3">
<li><a href="#ranking_profile_rank-properties">5.2.1. rank-properties</a></li>
<li><a href="#ranking_profile_macro">5.2.2. macro</a></li>
<li><a href="#ranking_profile_first-phase">5.2.3. first-phase</a></li>
<li><a href="#ranking_profile_second-phase">5.2.4. second-phase</a></li>
<li><a href="#ranking_profile_inherits">5.2.5. inherits</a></li>
</ul>
</li>
<li><a href="#ranking_expression">5.3. ランク式</a>
<ul class="sectlevel3">
<li><a href="#ranking_expression_profile">5.3.1. rank-profile上での書き方</a></li>
<li><a href="#ranking_expression_syntax">5.3.2. ランク式の記法</a></li>
<li><a href="#ranking_expression_feature">5.3.3. 組み込み素性</a></li>
</ul>
</li>
<li><a href="#ranking_search">5.4. ランキングと検索</a>
<ul class="sectlevel3">
<li><a href="#ranking_search_model">5.4.1. チュートリアルのモデル</a></li>
<li><a href="#ranking_search_compare">5.4.2. 検索結果の比較</a></li>
</ul>
</li>
<li><a href="#ranking_other">5.5. その他のトピック</a>
<ul class="sectlevel3">
<li><a href="#ranking_other_dump">5.5.1. 素性値のダンプ</a></li>
<li><a href="#ranking_other_tensor">5.5.2. テンソルを用いたスコア計算</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustering">6. Vespa とクラスタリング</a>
<ul class="sectlevel2">
<li><a href="#clustering_setup">6.1. クラスタの構築</a>
<ul class="sectlevel3">
<li><a href="#clustering_setup_tutorial">6.1.1. チュートリアルでの構成</a></li>
<li><a href="#clustering_setup_deploy">6.1.2. クラスタ設定の反映</a></li>
</ul>
</li>
<li><a href="#clustering_state">6.2. クラスタの状態管理</a>
<ul class="sectlevel3">
<li><a href="#clustering_state_howto">6.2.1. 状態管理の仕組み</a></li>
<li><a href="#clustering_state_node">6.2.2. ノードの状態</a></li>
<li><a href="#clustering_state_check">6.2.3. ノード状態の判定</a></li>
</ul>
</li>
<li><a href="#clustering_distrib">6.3. ドキュメントの分散</a>
<ul class="sectlevel3">
<li><a href="#clustering_distrib_process">6.3.1. Distributor と SearchNode</a></li>
<li><a href="#clustering_distrib_bucket">6.3.2. bucket の配置と再分配</a></li>
<li><a href="#clustering_distrib_example">6.3.3. チュートリアル環境での例</a></li>
</ul>
</li>
<li><a href="#clustering_other">6.4. その他のトピック</a>
<ul class="sectlevel3">
<li><a href="#clustering_other_logging">6.4.1. ログの確認</a></li>
<li><a href="#clustering_other_metrics">6.4.2. メトリクスの取得</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#comparing">7. Solr/Elasticsearch との機能比較</a>
<ul class="sectlevel2">
<li><a href="#comparing_update">7.1. スキーマと更新</a>
<ul class="sectlevel3">
<li><a href="#comparing_update_dynamic">7.1.1. 動的フィールド</a></li>
<li><a href="#comparing_update_type">7.1.2. データ型</a></li>
<li><a href="#comparing_update_realtime">7.1.3. リアルタイム性</a></li>
</ul>
</li>
<li><a href="#comparing_search">7.2. 検索周り</a>
<ul class="sectlevel3">
<li><a href="#comparing_search_aggregation">7.2.1. 集約処理</a></li>
<li><a href="#comparing_search_advanced">7.2.2. 高度な検索機能</a></li>
</ul>
</li>
<li><a href="#comparing_ranking">7.3. ランキング</a>
<ul class="sectlevel3">
<li><a href="#comparing_ranking_phase">7.3.1. フェーズ分け</a></li>
<li><a href="#comparing_ranking_dsl">7.3.2. 記述の自由度</a></li>
<li><a href="#comparing_ranking_advanced">7.3.3. 高度なランキング</a></li>
</ul>
</li>
<li><a href="#comparing_scalability">7.4. スケーラビリティ</a>
<ul class="sectlevel3">
<li><a href="#comparing_scalability_distrib">7.4.1. 分散インデクシング</a></li>
<li><a href="#comparing_scalability_node">7.4.2. ノードの追加・削除</a></li>
</ul>
</li>
<li><a href="#comparing_extensibility">7.5. 拡張性</a>
<ul class="sectlevel3">
<li><a href="#comparing_extensibility_language">7.5.1. 多言語対応</a></li>
<li><a href="#comparing_extensibility_plugin">7.5.2. プラグインの追加</a></li>
</ul>
</li>
<li><a href="#comparing_summary">7.6. まとめ</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このドキュメントでは、OSS 検索エンジンである <a href="http://vespa.ai/">Vespa</a> の使い方について紹介します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チュートリアルのコードは以下のリポジトリにあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/yahoojapan/vespa-tutorial" class="bare">https://github.com/yahoojapan/vespa-tutorial</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup">1. Vespa 環境の構築</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、
<a href="http://docs.vespa.ai/documentation/vespa-quick-start.html">QuickStart</a>
の中で利用されている Docker イメージ
<a href="https://github.com/vespa-engine/docker-image">vespaengine/vespa</a>
の処理を追うことで、Vespa の具体的な構築手順について見ていきます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>この構築手順は <span class="red"><strong>CentOS7</strong></span> での実行を想定しています。
また、クラスタまで構築する場合は最低でも <span class="red"><strong>8GB</strong></span> 程度のメモリを持つ環境が必要となります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="setup_install">1.1. Vespa のインストール</h3>
<div class="paragraph">
<p><a href="https://github.com/vespa-engine/docker-image/blob/master/Dockerfile">Dockerfile</a>
を見ると分かるように、Vespa は現在 rpm パッケージとして提供されています。</p>
</div>
<div class="paragraph">
<p>Vespa を <code>yum</code> 経由でインストールするためには、まず Vespa のリポジトリを <code>yum</code> に追加する必要があります。
以下のように <code>yum-config-manager</code> を用いて <code>group_vespa-vespa-epel-7.repo</code> を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># yum-config-manager --add-repo https://copr.fedorainfracloud.org/coprs/g/vespa/vespa/repo/epel-7/group_vespa-vespa-epel-7.repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、Vespa の依存パッケージをインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># yum install epel-release
# yum install centos-release-scl</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に、Vespa 本体をインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># yum install vespa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vespa パッケージは <code>/opt/vespa</code> 配下にインストールされます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ls /opt/vespa
bin  conf  etc  include  lib  lib64  libexec  man  sbin  share</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa 関連のコマンドは <code>/opt/vespa/bin</code> 配下にあるので、そこにパスを通しておくとコマンド実行が楽です。</p>
</div>
<div class="paragraph">
<p>また、Vespa 関連のログは <code>/opt/vespa/logs/vespa/</code> 配下に出力され、
特に Vespa のアプリケーションログは <code>/opt/vespa/logs/vespa/vespa.log</code> に出力されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="setup_boot">1.2. Vespa の起動</h3>
<div class="paragraph">
<p>Vespa の構成を大雑把に図にまとめると以下のようになります
(公式ドキュメントだと <a href="http://docs.vespa.ai/documentation/config-sentinel.html">この辺</a>)。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_overview.jpg" alt="vespa overview" width="700">
</div>
</div>
<div class="paragraph">
<p>Vespa で起動されるプロセスは大きく分けて3つのグループに分けられます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>configserver</code> (図の <span class="blue">青色</span> のプロセス群)</p>
<div class="ulist">
<ul>
<li>
<p>いわゆる ZooKeeper のことで、クラスタ内で参照される設定ファイル群を管理</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>vespa-config-sentinel</code> (図の <span class="red">赤色</span> のプロセス群)</p>
<div class="ulist">
<ul>
<li>
<p>各アプリケーションサーバにて対応するサービスプロセスを管理</p>
</li>
<li>
<p><code>config-proxy</code> を介して <code>configserver</code> から情報を取得します</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>service</code> (図の <span class="green">緑色</span> のプロセス群)</p>
<div class="ulist">
<ul>
<li>
<p>実際の検索処理を担当するプロセス群</p>
</li>
<li>
<p>設定ファイルを元に必要なプロセスが <code>vespa-config-sentinel</code> によって起動されます</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>このうち実際の処理に対応する <code>service</code> は、後述の設定ファイルのデプロイにて起動されるプロセスとなります。
この時点ではまだ設定ファイルが登録されていないため、この節では <code>configserver</code> と <code>config-sentinel</code> の2つが対象となります。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/vespa-engine/docker-image/blob/master/include/start-container.sh">start-container.sh</a>
を見ると分かるように、Vespa の起動は大きくわけて3つのステップに分けられます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>環境変数の設定</p>
</li>
<li>
<p><code>configserver</code> の起動</p>
</li>
<li>
<p><code>vespa-config-sentinel</code> の起動</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以降のコマンドの実行ユーザは各環境の設定に応じて変更してください。
チュートリアルでは <code>root</code> 権限での実行を過程しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="setup_boot_env">1.2.1. 環境変数の設定</h4>
<div class="paragraph">
<p>初めに、各 Vespa ノードで
<a href="http://docs.vespa.ai/documentation/setting-vespa-variables.html">VESPA_CONFIGSERVERS</a>
という環境変数に <code>configserver</code> のアドレスを指定する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># export VESPA_CONFIGSERVERS=${host1},${host2},...</code></pre>
</div>
</div>
<div class="paragraph">
<p>この環境変数が明示的に指定されていない場合、<code>localhost</code> がデフォルト値として利用されます。</p>
</div>
</div>
<div class="sect3">
<h4 id="setup_boot_configserver">1.2.2. configserver の起動</h4>
<div class="paragraph">
<p>次に、<code>VESPA_CONFIGSERVERS</code> にて指定したホスト上で以下のコマンドを実行し、<code>configserver</code> を起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># /opt/vespa/bin/vespa-start-configserver</code></pre>
</div>
</div>
<div class="paragraph">
<p>起動後、以下のように2つのプロセスが起動していることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># ps aux | grep vespa | grep -v grep
vespa      571  0.0  0.4  97620 70704 ?        Ss   07:09   0:00 vespa-runserver -s configserver -r 30 -p /opt/vespa/var/run/configserver.pid -- java -Xms128m -Xmx2048m -XX:+PreserveFramePointer -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/vespa/var/crash -XX:OnOutOfMemoryError=kill -9 %p -Djava.library.path=/opt/vespa/lib64 -Djava.awt.headless=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.net.client.defaultConnectTimeout=5000 -Dsun.net.client.defaultReadTimeout=60000 -Djavax.net.ssl.keyStoreType=JKS -Djdisc.config.file=/opt/vespa/var/jdisc_core/configserver.properties -Djdisc.export.packages= -Djdisc.cache.path=/opt/vespa/var/vespa/bundlecache/configserver -Djdisc.debug.resources=false -Djdisc.bundle.path=/opt/vespa/lib/jars -Djdisc.logger.enabled=true -Djdisc.logger.level=ALL -Djdisc.logger.tag=jdisc/configserver -Dfile.encoding=UTF-8 -Dzookeeperlogfile=/opt/vespa/logs/vespa/zookeeper.configserver.log -cp /opt/vespa/lib/jars/jdisc_core-jar-with-dependencies.jar com.yahoo.jdisc.core.StandaloneMain standalone-container-jar-with-dependencies.jar
vespa      572 55.6  3.9 4110952 655828 ?      Sl   07:09   0:15 java -Xms128m -Xmx2048m -XX:+PreserveFramePointer -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/vespa/var/crash -XX:OnOutOfMemoryError=kill -9 %p -Djava.library.path=/opt/vespa/lib64 -Djava.awt.headless=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.net.client.defaultConnectTimeout=5000 -Dsun.net.client.defaultReadTimeout=60000 -Djavax.net.ssl.keyStoreType=JKS -Djdisc.config.file=/opt/vespa/var/jdisc_core/configserver.properties -Djdisc.export.packages= -Djdisc.cache.path=/opt/vespa/var/vespa/bundlecache/configserver -Djdisc.debug.resources=false -Djdisc.bundle.path=/opt/vespa/lib/jars -Djdisc.logger.enabled=true -Djdisc.logger.level=ALL -Djdisc.logger.tag=jdisc/configserver -Dfile.encoding=UTF-8 -Dzookeeperlogfile=/opt/vespa/logs/vespa/zookeeper.configserver.log -cp /opt/vespa/lib/jars/jdisc_core-jar-with-dependencies.jar com.yahoo.jdisc.core.StandaloneMain standalone-container-jar-with-dependencies.jar</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>この2つのプロセスは以下のように親子関係になっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># pstree -p
bash(1)-+-pstree(827)
        `-vespa-runserver(571)---java(572)-+-{java}(573)
                                           |-{java}(574)
                                           |-{java}(575)
                                           ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vespa のプロセスはこのように
<a href="https://github.com/vespa-engine/vespa/blob/master/vespalog/src/logger/runserver.cpp">vespa-runserver</a>
から fork される形式で起動されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="setup_boot_configsetinel">1.2.3. vespa-config-sentinel の起動</h4>
<div class="paragraph">
<p>最後に、各 Vespa ノードにて 以下のコマンドを実行し、 <code>vespa-config-sentinel</code> を起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># /opt/vespa/bin/vespa-start-services</code></pre>
</div>
</div>
<div class="paragraph">
<p>起動後、以下のように新たに4つのプロセスが起動していることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># ps aux | grep vespa | grep -v configserver | grep -v grep
vespa     1079  0.0  0.0  25604   708 ?        Ss   07:27   0:00 vespa-runserver -r 10 -s configproxy -p var/run/configproxy.pid -- java -Xms32M -Xmx256M -XX:ThreadStackSize=256 -XX:MaxJavaStackTraceDepth=-1 -XX:OnOutOfMemoryError=kill -9 %p -Dproxyconfigsources=tcp/localhost:19070 -cp libexec/vespa/patches/configproxy:lib/jars/config-proxy-jar-with-dependencies.jar com.yahoo.vespa.config.proxy.ProxyServer 19090
vespa     1080  0.8  0.2 1740948 44500 ?       Sl   07:27   0:00 java -Xms32M -Xmx256M -XX:ThreadStackSize=256 -XX:MaxJavaStackTraceDepth=-1 -XX:OnOutOfMemoryError=kill -9 %p -Dproxyconfigsources=tcp/localhost:19070 -cp libexec/vespa/patches/configproxy:lib/jars/config-proxy-jar-with-dependencies.jar com.yahoo.vespa.config.proxy.ProxyServer 19090
vespa     1148  0.0  0.0  25604   700 ?        Ss   07:27   0:00 vespa-runserver -s config-sentinel -r 10 -p var/run/sentinel.pid -- sbin/vespa-config-sentinel -c hosts/76eae592a196
vespa     1149  0.1  0.0  66552  4480 ?        Sl   07:27   0:00 sbin/vespa-config-sentinel -c hosts/76eae592a196</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>この4つのプロセスも <code>configserver</code> と同様に
<a href="https://github.com/vespa-engine/vespa/blob/master/vespalog/src/logger/runserver.cpp">vespa-runserver</a>
経由で起動しているため、実質のプロセス種別は <code>config-proxy</code> と <code>vespa-config-sentinel</code> の2つになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># pstree -p
bash(1)-+-pstree(1199)
        |-vespa-runserver(571)---java(572)-+-{java}(573)
        |                                  |-{java}(574)
        ...
        |-vespa-runserver(1079)---java(1080)-+-{java}(1082)
        |                                    |-{java}(1083)
        ...
        `-vespa-runserver(1148)---vespa-config-se(1191)-+-{vespa-config-se}(1192)
                                                        |-{vespa-config-se}(1193)
                                                        ...</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>もし、<code>vespa-config-sentinel</code> を起動する前に <code>configserver</code> に設定ファイルをアップロードしている場合、
設定ファイルの記述に対応する各種 <code>service</code> もこのタイミングで起動されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup_tutorial">1.3. チュートリアル環境の構築</h3>
<div class="paragraph">
<p>本チュートリアルでは、ここまで見てきた <code>Dockerfile</code> を用いて実際に Docker 上に Vespa を構築します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実行には <code>docker</code> と <code>docker-compose</code> が必要です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>必要な設定はチュートリアルに付属の <code>docker-compose.xml</code> に定義されているため、
以下のように <code>docker-compose</code> を用いてコンテナを起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ git clone https://github.com/yahoojapan/vespa-tutorial
$ cd vespa-tutorial
$ sudo docker-compose up -d</code></pre>
</div>
</div>
<div class="paragraph">
<p>起動が完了したら、付属のスクリプトを用いて環境のステータスを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_status
configuration server ...   [ OK ]
application server (vespa1) ...   [ NG ]
application server (vespa2) ...   [ NG ]
application server (vespa3) ...   [ NG ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>この時点ではまだ設定ファイルがなく、
<code>service</code> が起動していないため <code>configserver</code> のみが <code>OK</code> となります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>utils/vespa_status</code> では以下の URL にアクセスしてステータスを確認しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">// configserverのステータス確認
$ curl -sI 'http://localhost:19071/ApplicationStatus'
HTTP/1.1 200 OK
Date: Tue, 13 Feb 2018 08:27:04 GMT
Content-Type: application/json
Content-Length: 10683

// 各service (container) のステータス確認
$ curl -sI 'http://localhost:8080/ApplicationStatus'
$ curl -sI 'http://localhost:8081/ApplicationStatus'
$ curl -sI 'http://localhost:8082/ApplicationStatus'</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="config">2. Vespa の設定</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、Vespa の具体的な設定方法について見ていきます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>複数ノードを使ったクラスタの構成については
<a href="#clustering">Vespa とクラスタリング</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="config_file">2.1. 設定ファイル</h3>
<div class="paragraph">
<p>Vespa の設定ファイルは以下のようなディレクトリ構成で定義されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">myconfig/
|- hosts.xml
|- services.xml
|- searchdefinitions/
|  |- myindex.sd
|  `- ...
|- components/
|  |- myplugin.jar
|  `- ...
`- search/query-profiles/
   `- myprofile.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>各設定ファイルにはそれぞれ以下のような役割があります。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">設定ファイル</th>
<th class="tableblock halign-center valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.vespa.ai/documentation/reference/hosts.html">hosts.xml</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vespa クラスタに所属する host 名の一覧。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.vespa.ai/documentation/reference/services.html">services.xml</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vespa で起動するサービスの定義。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html">searchdefinitions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vespa で扱うインデックスの定義。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">components</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vespa で利用するプラグイン (<code>jar</code> ファイル)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.vespa.ai/documentation/reference/query-profile-reference.html">query-profiles</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリに付与するデフォルトパラメタの定義。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>このうち最低限必要となるのは <code>hosts.xml</code>、<code>services.xml</code>、<code>searchdefinitions</code> の3つです。</p>
</div>
<div class="sect3">
<h4 id="config_file_hosts">2.1.1. hosts.xml</h4>
<div class="paragraph">
<p><code>hosts.xml</code> には Vespa クラスタに所属するホスト名の定義を記述します。
例えば、チュートリアルの <code>sample-apps/config/basic/hosts.xml</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="tag">&lt;hosts&gt;</span>
  <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vespa1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;alias&gt;</span>node1<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;/host&gt;</span>
<span class="tag">&lt;/hosts&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上記例のように、<code>hosts.xml</code> ではノードのホスト名を <code>name</code> 属性で、
後述の <code>services.xml</code> で参照されるエイリアス名を <code>alias</code> 要素でそれぞれ定義します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>alias</code> は一つのホストに対して複数定義できます。例えば以下のように役割毎に <code>alias</code> を定義することで、
<code>services.xml</code> との対応を明確にできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">---
<span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vespa1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;alias&gt;</span>search1<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;alias&gt;</span>docproc1<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;alias&gt;</span>content1<span class="tag">&lt;/alias&gt;</span>
<span class="tag">&lt;/host&gt;</span>
---</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="config_file_services">2.1.2. services.xml</h4>
<div class="paragraph">
<p><code>services.xml</code> には Vespa の各ノードがどのようなサービスを起動するかの設定を記述します。
Vespa のサービスは
<a href="http://docs.vespa.ai/documentation/reference/services-admin.html">admin</a>、
<a href="http://docs.vespa.ai/documentation/reference/services-container.html">container</a>、
<a href="http://docs.vespa.ai/documentation/reference/services-content.html">content</a>
の3つに大別されます</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_architecture.jpg" alt="vespa architecture" width="900">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>サービスを含めて Vespa で起動されるプロセスの一覧は以下のページに記載されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/files-processes-and-ports.html">Files, processes and ports</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>なお、Vespa は <code>C++</code> と <code>Java</code> の2つの言語で書かれた複数のプロセスが通信し合うことで動作しています。
大雑把に分けると、<code>admin</code> と <code>container</code> は <code>Java</code> のコード、<code>content</code> は <code>C++</code> のコードで実装されています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実際は他にもサービスがいますが、ここでは動作上必要な前述の3つのみに対象を絞って説明します。
他のサービスの設定については
<a href="http://docs.vespa.ai/documentation/reference/services.html">公式ドキュメント</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="config_file_services_admin">admin</h5>
<div class="paragraph">
<p>Vespa クラスタの管理サービスで、
チュートリアルの <code>sample-apps/config/basic/services.xml</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;admin</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;adminserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;configservers&gt;</span>
      <span class="tag">&lt;configserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/configservers&gt;</span>
    <span class="tag">&lt;logserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;slobroks&gt;</span>
      <span class="tag">&lt;slobrok</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/slobroks&gt;</span>
  <span class="tag">&lt;/admin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>それぞれの要素は以下のようなサービスを意味しています。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">要素</th>
<th class="tableblock halign-center valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">adminserver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">管理ノード本体を担当するサーバで、admin コマンドの実行ノードになります (たぶん)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configservers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZooKeeper に対応するサーバ群で、設定ファイルの管理を行います。複数ノードを指定することで冗長化が可能です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">logserver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vespa のログ収集を担当するサーバで、Vespa クラスタ内の全サービスのログをアーカイブします。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">slobroks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>slobrok</code> は Service location broker の略で、各サービスのロケーション情報を管理します。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>これ以外にも ` cluster-controllers`、<code>filedistribution</code> および <code>monitoring</code> という要素があります。
詳しくは <a href="http://docs.vespa.ai/documentation/reference/services-admin.html">公式ドキュメント</a> を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="config_file_services_container">container</h5>
<div class="paragraph">
<p>Vespa のフロントエンドに対応するサービスで、
チュートリアルの <code>sample-apps/config/basic/services.xml</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;container</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;component</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.yahoo.vespa.language.lib.kuromoji.KuromojiLinguistics</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">bundle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kuromoji-linguistics</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;config</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">language.lib.kuromoji.kuromoji</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;mode&gt;</span>search<span class="tag">&lt;/mode&gt;</span>
        <span class="tag">&lt;ignore_case&gt;</span>true<span class="tag">&lt;/ignore_case&gt;</span>
      <span class="tag">&lt;/config&gt;</span>
    <span class="tag">&lt;/component&gt;</span>
    <span class="tag">&lt;document-api</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;document-processing</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;search</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/nodes&gt;</span>
  <span class="tag">&lt;/container&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>container</code> はユーザからの検索リクエストや更新リクエストを受け付ける層に対応しています。
上記の設定の場合、セクションの中身は大きく以下の3つのグループに分解できます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>component</code></p>
</li>
<li>
<p><code>document-api</code>, <code>document-processing</code>, <code>search</code></p>
</li>
<li>
<p><code>nodes</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>component</code> は追加モジュールの定義で、
ここでは日本語の形態素解析器に対応する <code>KuromojiLinguistics</code> というモジュールを追加しています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>より具体的には、<code>component</code> で定義されたクラスのインスタンスが Vespa の DI コンテナにデプロイされるイメージです。
<code>KuromojiLinguistics</code> は言語に対応するインタフェースである <code>Linguistics</code> を継承したクラスであり、
Vespa のコード上で <code>Lingusitics</code> を Inject している箇所に差し込まれます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>KuromojiLinguistics</code> を有効にするには別途 <code>jar</code> ファイルを入手して配置する必要があります。
詳しくは
<a href="#config_deploy_tokenizer">日本語トークナイザの配置</a>
で述べます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>document-api</code>、<code>document-processing</code> および <code>search</code> はコンテナ上に起動する各種サービスに対応しており、
それぞれ以下のような機能を有効化します。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">要素</th>
<th class="tableblock halign-center valign-top">機能</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">document-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新リクエストのための <a href="http://docs.vespa.ai/documentation/document-api.html">Document API</a> を有効にします。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">document-processing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新対象のドキュメントに対する加工処理 (<code>DocumentProcessorChain</code>) を有効にします。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索リクエストのための <a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html">Search API</a> を有効化します。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>デフォルトでは <code>8080</code> ポートにて API が提供されますが、
以下のように <code>http</code> セクションを定義することでポート番号を変更できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;http&gt;</span>
      <span class="tag">&lt;server</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8983</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/http&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa の <a href="https://github.com/vespa-engine/sample-apps/tree/master/basic-search">公式チュートリアル</a> の設定では
<code>document-processing</code> が定義されていませんが、日本語処理を行う場合は <code>document-processing</code> の定義が必須となります。
これは、<code>document-processing</code> が定義されることで Vespa にて
<a href="https://github.com/vespa-engine/vespa/blob/master/docprocs/src/main/java/com/yahoo/docprocs/indexing/IndexingProcessor.java">IndexingProcessor</a>
が有効となり、この中で形態素解析が実行されるため (たぶん)。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>nodes</code> ではこのコンテナ定義を適用するノードの一覧を記述しています。
チュートリアルのサンプルでは全ノードに対して同一の設定を適用していますが、
ノード毎に <code>container</code> セクションを別々に定義することで個別に設定を行うことも可能です。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>container</code> を複数定義する場合は <code>id</code> 属性 (コンテナの識別子) が被らないように注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="config_file_services_content">content</h5>
<div class="paragraph">
<p>Vespa のインデックス本体を持つノードで、
チュートリアルの <code>sample-apps/config/basic/services.xml</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;content</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;redundancy&gt;</span>1<span class="tag">&lt;/redundancy&gt;</span>
    <span class="tag">&lt;documents&gt;</span>
      <span class="tag">&lt;document</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;document-processing</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/documents&gt;</span>
    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/nodes&gt;</span>
  <span class="tag">&lt;/content&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>redundancy</code> はドキュメントの冗長数のことで、インデックス中にドキュメントの複製をいくつ保持するかを指定します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa ではインデックスを <code>bucket</code> という単位に分割し、
それぞれを指定された冗長数に応じてクラスタ内に分配することで冗長性を担保しています。
このため、Solr や Elasticsearch のような shard/replica 方式に比べてデータの分割が細かくなっています。
詳しくは
<a href="#clustering_distrib">ドキュメントの分散</a>
で紹介します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>documents</code> はインデックスの具体的な定義に対応する設定で、参照するスキーマ定義および前処理の参照先を指定しています。
<code>document</code> 要素の <code>type</code> は後述の <code>searchdefitions</code> に記述されたスキーマ定義の識別子を指定しています。
また、<code>mode</code> はインデックスの保持方法を選択しており、通常の全文検索の場合は <code>mode=index</code> となります。
<code>document-processing</code> では対応する前処理が実行される <code>container</code> の識別子を指定します (ここでは前述の "container" が対応)。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>document</code> は複数定義が可能で、複数の異なるインデックスを保持できます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>nodes</code> は <code>container</code> と同じように構築対象のノードを指定しています。
<code>distribution-key</code> はドキュメントを分散させるときの配置先決めに利用される値で、
全てのノードで異なるキーとなるように設定します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ノードの追加・削除で <code>nodes</code> の設定が変わるとき、
既存のノードに割り当てられている <code>distribution-key</code> は変更しないでください。
例えば、</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/nodes&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>という3ノード構成から "node2" を外す場合、新しい設定は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/nodes&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="config_file_searchdefinitions">2.1.3. searchdefinitions</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/search-definitions.html">searchdefinitions</a>
では Vespa の検索に関する定義のことで、<code>.sd</code> という拡張子のファイルとなっています。
<code>searchdefinitions</code> の中身は独自のフォーマットで書かれており、具体的には以下のような情報が記載されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>スキーマ定義 (<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#document">document</a>)</p>
</li>
<li>
<p>検索対象のフィールド群のエイリアス定義 (<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#fieldset">fieldset</a>)</p>
</li>
<li>
<p>リランキングのためのモデル定義 (<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#rank-profile">rank-profile</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ここでは <code>document</code> と <code>fieldset</code> の2つについて説明します (モデル定義については
<a href="#ranking">Vespa とランキング</a>
で説明)。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>searchdefinitions</code> のファイル名は、以下の例のように <code>search</code> セクションの識別子と揃える必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cat book.sd <i class="conum" data-value="1"></i><b>(1)</b>
search book {
  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>search book</code> と揃えて <code>book.sd</code> とします</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html">公式ドキュメント</a>
を見ると分かるように、実際にはもっと色々な定義が可能ですが、ここではよく使う項目に対象を絞っています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="config_file_searchdefinitions_document">document</h5>
<div class="paragraph">
<p><code>document</code> はスキーマ定義に対応する項目で、
チュートリアルの <code>sample-apps/config/basic/searchdefinitions/book.sd</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    document book {

        field language type string {
            indexing: "ja" | set_language
        }

        field title type string {
            indexing: summary | index
            summary-to: simple_set, detail_set
        }

        field desc type string {
            indexing: summary | index
            summary-to: detail_set
        }

        field price type int {
            indexing: summary | attribute
            summary-to: simple_set, detail_set
        }

        field page type int {
            indexing: summary | attribute
        }

        field genres type array&lt;string&gt; {
            indexing: summary | attribute
            summary-to: detail_set
        }

        field reviews type weightedset&lt;string&gt; {
            indexing: summary | attribute
        }

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>各 <code>field</code> 要素はスキーマに存在するフィールドの定義に対応しています。
ただし、一番上の <code>language</code> だけは特殊で、ドキュメントが日本語 (<code>ja</code>) であることを明示的に宣言しています。</p>
</div>
<div class="paragraph">
<p><code>field</code> では以下のように名称 (<code>name</code>)、型 (<code>type</code>)、処理方法 (<code>indexing</code>) の3つの項目でフィールドを定義するのが基本となります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>summary-to</code> については
<a href="#search_query_summary">summary</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>field ${name} type ${type} {
    indexing: ${indexing}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>type</code> には代表的なものとして以下のような型が指定できます (詳細は
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#field_types">こちら</a>
を参照)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">型</th>
<th class="tableblock halign-center valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列型、処理方法によって形態素解析の有無が変わります。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32-bit 整数の数値型、単一の値を保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64-bit 整数の数値型、単一の値を保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8-bit 整数の数値型、単一の値を保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単精度浮動小数点型、単一の値を保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">倍精度浮動小数点型、単一の値を保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">array&lt;element-type&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配列型、<code>element-type</code> で指定された型を複数保持します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">weightedset&lt;element-type&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">辞書型、<code>element-type</code> を key、<code>integer</code> を value とする複数の key-value を保持します。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>indexing</code> には以下の3つが指定できます (詳細は
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#indexing">こちら</a>
を参照)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">処理</th>
<th class="tableblock halign-center valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">値をオンメモリ上に展開します (ソートやグルーピングで用いるフィールドに指定)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">形態素解析してインデックスに登録します (<code>string</code> と組み合わせる)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">summary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンスに指定されたフィールドの値を付与します</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>チュートリアルの例のように、これらの設定は <code>summary | index</code> と組み合わせて利用できます。
ただし、<code>attribute</code> と <code>index</code> は対の関係にあるため、通常は <code>attribute</code> と <code>index</code> を同時に指定することはないです。
基本的に <code>index</code> は文章のような長い文字列型にのみ指定し、
それ以外の数値型やキーワードのような単一文字列については <code>attribute</code> を用います。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>より正確にいうと、<code>indexing</code> は
<a href="http://docs.vespa.ai/documentation/reference/advanced-indexing-language.html">indexing-language</a>
と呼ばれる機能に対応します。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="config_file_searchdefinitions_fieldset">fieldset</h5>
<div class="paragraph">
<p><code>fieldset</code> は複数のフィールドを束ねたエイリアスの定義に利用します。
チュートリアルの <code>sample-apps/config/basic/searchdefinitions/book.sd</code> では以下のように記述されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    fieldset default {
        fields: title, desc
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のように定義した場合、検索時に <code>query=default:foo</code> と検索フィールドとして
<code>fieldset</code> の名称を指定することで、紐付いているフィールド全体に対して検索したのと同じ意味になります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>default</code> という <code>fieldset</code> には
「検索時に明示的にフィールドされなかった場合にデフォルトで参照されるフィールド」
という特別な意味があります。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="config_deploy">2.2. Vespa へのデプロイ</h3>
<div class="paragraph">
<p>設定ファイルの Vespa への反映には <code>vespa-deploy</code> というコマンドを用います。
ここでは、シングルノード用の設定である <code>sample-apps/config/basic</code> を実際にデプロイする手順を追っていきます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>事前に
<a href="#setup_tutorial">チュートリアル環境の構築</a>
の手順に従って Vespa を起動しておいてください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="config_deploy_tokenizer">2.2.1. 日本語トークナイザの配置</h4>
<div class="paragraph">
<p>現在の Vespa は日本語トークナイザを内包していないため、
対応する <code>jar</code> を別途入手して <code>components</code> 配下に配置する必要があります。
<a href="#config_file_services_container">container</a> の節で述べたように、ここでは <code>KuromojiLinguistics</code> を利用します。</p>
</div>
<div class="paragraph">
<p><code>KuromojiLinguistics</code> は
<a href="https://github.com/yahoojapan/vespa-kuromoji-linguistics">vespa-kuromoji-linguistics</a>
にて公開されている Vespa のプラグインで、
文書のトークン分けに <a href="https://www.atilika.com/ja/kuromoji/">Kuromoji</a> を利用する実装となっています。</p>
</div>
<div class="paragraph">
<p><a href="https://www.atilika.com/ja/kuromoji/">Kuromoji</a> はJavaで実装されたオープンソースの日本語形態素解析エンジンで、
<a href="http://lucene.apache.org/solr/">Solr</a>
や
<a href="https://www.elastic.co/jp/products/elasticsearch">Elasticsearch</a>
でも日本語トークナイザとして採用されています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>KuromojiLingusitcs</code> 自体の詳細については
<a href="https://github.com/yahoojapan/vespa-kuromoji-linguistics">vespa-kuromoji-linguistics</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本チュートリアルでは、事前に用意した以下のスクリプトを用いて <code>kuromoji-linguistics.jar</code> をセットアップします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sample-apps/plugin/setup.sh <i class="conum" data-value="1"></i><b>(1)</b>

$ ls sample-apps/plugin/ <i class="conum" data-value="2"></i><b>(2)</b>
kuromoji-linguistics.jar  setup.sh  vespa-kuromoji-linguistics</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>リポジトリからソースをダウンロードし、パッケージをビルド</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>kuromoji-lingustics.jar</code> としてプラグインが配置されます</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チュートリアルでは、<code>config</code> 配下にあるそれぞれの設定の
<code>components/kuromoji-lingusitics.jar</code>
から
<code>sample-apps/plugin/kuromoji-lingusitics.jar</code>
へシンボリックリンクを貼る構成となっています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="config_deploy_prepare">2.2.2. 設定ファイルのアップロード</h4>
<div class="paragraph">
<p>起動した Vespa ノードのうち、<code>vespa1</code> にログインします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose exec vespa1 /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>チュートリアル環境では Docker コンテナの <code>/vespa-sample-apps</code> に <code>sample-apps/</code> がマウントされています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# ls /vespa-sample-apps/
config  feed  plugin</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のコマンドを実行し、<code>/vespa-sample/apps/config/basic</code> を <code>configserver</code> にアップロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-deploy prepare /vespa-sample-apps/config/basic/
Uploading application '/vespa-sample-apps/config/basic/' using http://vespa1:19071/application/v2/tenant/default/session?name=basic
Session 2 for tenant 'default' created.
Preparing session 2 using http://vespa1:19071/application/v2/tenant/default/session/2/prepared
Session 2 for tenant 'default' prepared.</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように、設定ファイルの Vespa へのアップロードは次のコマンドで実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">vespa-deploy prepare ${config}</code></pre>
</div>
</div>
<div class="paragraph">
<p>もし、設定ファイルに不備がある場合、<code>prepare</code> は失敗し、エラーログがコンソールに出力されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記コマンドは、内部的には以下の2つのコマンドを実行しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># vespa-deploy upload /vespa-sample-apps/config/basic/
# vespa-deploy prepare</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="config_deploy_activate">2.2.3. 設定ファイルの反映</h4>
<div class="paragraph">
<p>次に、以下のコマンドを実行し、アップロードした設定を実際に Vespa に反映させます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-deploy activate
Activating session 2 using http://vespa1:19071/application/v2/tenant/default/session/2/active
Session 2 for tenant 'default' activated.
Checksum:   a60feb4256b6f0051b462252b6b398ad
Timestamp:  1518510769258
Generation: 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、各 Vespa に最新の設定が行き渡り、しばらくすると対応するサービスが起動します。
試しに <code>8080</code> ポートから検索を行うと、0件 (<code>"totalCount":0</code>) と結果が返ってきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# curl 'http://localhost:8080/search/?query=foo'
{&quot;root&quot;:{&quot;id&quot;:&quot;toplevel&quot;,&quot;relevance&quot;:1.0,&quot;fields&quot;:{&quot;totalCount&quot;:0},&quot;coverage&quot;:{&quot;coverage&quot;:100,&quot;documents&quot;:0,&quot;full&quot;:true,&quot;nodes&quot;:0,&quot;results&quot;:1,&quot;resultsFull&quot;:1}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Ctrl-D</code> でコンテナを抜けて <code>utils/vespa_status</code> を実行すると、
先程 <code>NG</code> だった vespa1 が <code>OK</code> に変わっていることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_status
configuration server ...   [ OK ]
application server (vespa1) ...   [ OK ]
application server (vespa2) ...   [ NG ]
application server (vespa3) ...   [ NG ]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="update">3. Vespa と更新</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、Vespa にドキュメントを登録する方法について見ていきます。</p>
</div>
<div class="sect2">
<h3 id="update_request">3.1. 更新リクエスト</h3>
<div class="paragraph">
<p>Vespa では更新リクエストは以下のように
<a href="http://docs.vespa.ai/documentation/reference/document-json-format.html">JSON</a>
を用いて記述します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここで紹介しているフォーマットは後述の Client を用いて一括更新を行うケースを想定しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">put</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::foo</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
      <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    }
  },
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::bar</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
      <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    }
  },
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">remove</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::foo</span><span class="delimiter">&quot;</span></span>
  },
  <span class="error">.</span><span class="error">.</span><span class="error">.</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>各ドキュメントの先頭に記載された <code>put</code>、<code>update</code>、`remove`はそれぞれ追加、更新、削除の操作を意味しており、
それぞれ値として対象のドキュメント ID を指定します。</p>
</div>
<div class="sect3">
<h4 id="update_request_docid">3.1.1. ドキュメント ID</h4>
<div class="paragraph">
<p>ドキュメント ID のフォーマットは以下のように定義されています (
<a href="http://docs.vespa.ai/documentation/documents.html">Documents</a>
)。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>id:&lt;namespace&gt;:&lt;document-type&gt;:&lt;key/value-pairs&gt;:&lt;user-specified&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>ドキュメント ID の各要素はそれぞれ以下のような意味があります。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">要素</th>
<th class="tableblock halign-center valign-top">必須?</th>
<th class="tableblock halign-center valign-top">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">namespace</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ドキュメントの名前空間、複数ユーザで Vespa をシェアしていたりするときに混在しないように付与します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">document-type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象のインデックス名、<code>searchdefinitions</code> で定義した <code>document</code> の識別子のこと。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key/value-pairs</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ドキュメントを特定のbucket (i.e., ノード) に偏らせたいときに指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user-specified</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ユーザ指定のユニークな ID を指定します。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>例えば、book インデックスに "foo" という ID で登録する場合は以下のように指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>id:book:book::foo</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>namespace</code> は (おそらく) 任意の値を付けることが可能ですが、
通常の運用では <code>document-type</code> と同じものを指定すればいいかと思います。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>key/value=pairs</code> は <code>id:book:book:n=0:foo</code> もしくは <code>id:book:book:g=bar:foo</code> のように、
<code>n=NUM</code> か <code>g=GROUP</code> のように指定します。
<code>n=NUM</code> と指定した場合は <code>NUM</code> の数値が、
<code>g=GROUP</code> と指定した場合は <code>GROUP</code> の文字列から生成されたハッシュ値がドキュメント分散で利用されます。
より詳細な情報は
<a href="http://docs.vespa.ai/documentation/content/buckets.html#document-to-bucket-distribution">こちら</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="update_request_put">3.1.2. put</h4>
<div class="paragraph">
<p><code>put</code> は新規ドキュメントの追加もしくは上書きを行います。
以下のように対象のフィールドとその値のペアを <code>fields</code> の要素として定義していきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">put</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::foo</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">fizz buzz</span><span class="delimiter">&quot;</span></span>,
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>各フィールドの値の書き方は、対応するフィールドのスキーマ定義によって以下のように変わります(
<a href="http://docs.vespa.ai/documentation/reference/document-json-put-format.html">Document JSON format - Put</a>
)。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">/</span><span class="error">/</span> <span class="error">文</span><span class="error">字</span><span class="error">列</span><span class="error">型</span> <span class="error">(</span><span class="error">s</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">)</span>
<span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">fizz buzz</span><span class="delimiter">&quot;</span></span>

<span class="error">/</span><span class="error">/</span> <span class="error">数</span><span class="error">値</span><span class="error">型</span> <span class="error">(</span><span class="error">i</span><span class="error">n</span><span class="error">t</span><span class="error">e</span><span class="error">g</span><span class="error">e</span><span class="error">r</span>, <span class="error">l</span><span class="error">o</span><span class="error">n</span><span class="error">g</span>, <span class="error">b</span><span class="error">y</span><span class="error">t</span><span class="error">e</span>, <span class="error">f</span><span class="error">l</span><span class="error">o</span><span class="error">a</span><span class="error">t</span>, <span class="error">d</span><span class="error">o</span><span class="error">u</span><span class="error">b</span><span class="error">l</span><span class="error">e</span><span class="error">)</span>
<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">3000</span>

<span class="error">/</span><span class="error">/</span> <span class="error">配</span><span class="error">列</span><span class="error">型</span> <span class="error">(</span><span class="error">こ</span><span class="error">こ</span><span class="error">で</span><span class="error">は</span> <span class="error">a</span><span class="error">r</span><span class="error">r</span><span class="error">a</span><span class="error">y</span><span class="error">&lt;</span><span class="error">s</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">&gt;</span> <span class="error">の</span><span class="error">例</span><span class="error">)</span>
<span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
  <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>
]

<span class="error">/</span><span class="error">/</span> <span class="error">辞</span><span class="error">書</span><span class="error">型</span> <span class="error">(</span><span class="error">こ</span><span class="error">こ</span><span class="error">で</span><span class="error">は</span> <span class="error">w</span><span class="error">e</span><span class="error">i</span><span class="error">g</span><span class="error">h</span><span class="error">t</span><span class="error">e</span><span class="error">d</span><span class="error">s</span><span class="error">e</span><span class="error">t</span><span class="error">&lt;</span><span class="error">s</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">&gt;</span> <span class="error">の</span><span class="error">例</span><span class="error">)</span>
<span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: {
  <span class="key"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa の配列型フィールドでは feed 上での定義順が保持されたままインデックスされます。
上の例の場合、<code>["foo", "bar"]</code> という順序が登録後も記録されており、
グルーピングやスコア計算などで配列への番号アクセスが可能となっています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>weightedset</code> の値は <code>integer</code> で固定なので注意。
この値は各要素の重み (デフォルト値は <code>100</code>) に対応しており、後述するランキングでのスコア計算に影響してきます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="update_request_update">3.1.3. update</h4>
<div class="paragraph">
<p><code>update</code> は既存ドキュメントの部分更新を行います。
以下のように対象のフィールドとそこへの操作のペアを <code>fields</code> の要素として定義していきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::foo</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">assign</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">buzz fizz</span><span class="delimiter">&quot;</span></span>
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記例の <code>assign</code> の部分は更新方法の指定を行っており、以下の3つが指定できます (
<a href="http://docs.vespa.ai/documentation/reference/document-json-update-format.html">Document JSON format - Update</a>
)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">方法</th>
<th class="tableblock halign-center valign-top">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">assign</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールドの値を指定した値で上書きします。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールドに指定した値を追加します (配列型や辞書型で利用可能)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定したフィールドの値を削除します。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="update_request_remove">3.1.4. remove</h4>
<div class="paragraph">
<p><code>remove</code> は既存ドキュメントの削除を行います。
<code>remove</code> ではドキュメント ID のみが必要なため、<code>fields</code> のような追加の要素の定義は不要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">remove</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::foo</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>インデックスから全ドキュメントを削除したい場合は、Vespa のサービスを停止した状態で
<a href="http://docs.vespa.ai/documentation/reference/vespa-cmdline-tools.html#vespa-remove-index">vespa-remove-index</a>
を叩くことで全削除できます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update_document">3.2. ドキュメントの更新</h3>
<div class="paragraph">
<p>Vespa では更新リクエストの投げ方には以下のような2つの方法が用意されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/document-api.html">Document Operation API</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/vespa-http-client.html">Vespa Java Feeding Client</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本ドキュメントでは、後者の Client を用いた方法でドキュメントの登録を行います。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実運用では、一括更新が可能な Client (
<a href="http://docs.vespa.ai/documentation/reference/vespa-feeder.html">vespa-feeder</a>
) を利用する方が一般的かと思います。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="update_document_client">3.2.1. Client の実行方法</h4>
<div class="paragraph">
<p>Vepsa では Client プログラムを実行ラッパーとして
<a href="https://github.com/vespa-engine/vespa/blob/master/vespaclient-java/src/main/sh/vespa-feeder.sh">vespa-feeder</a>
というコマンドが提供されています。</p>
</div>
<div class="paragraph">
<p><code>vespa_feeder</code> では以下のように、引数として更新リクエストの <code>json</code> ファイルをわたすことで Vespa へのドキュメントの登録が行えます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ vespa_feeder documents.json</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="update_document_sample">3.2.2. サンプルデータの登録</h4>
<div class="paragraph">
<p>チュートリアルでは、サンブルデータとして前述の <code>book</code> インデックス向けに以下のようなドキュメントが用意されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ cat sample-apps/feed/book-data-put.json
[
  {
    &quot;put&quot;: &quot;id:foo:book:g=foo:vespa_intro&quot;,
    &quot;fields&quot;: {
      &quot;title&quot;: &quot;ゼロから始めるVespa入門&quot;,
      &quot;desc&quot;: &quot;話題のOSS検索エンジン、Vespaの使い方を初心者にもわかりやすく解説します&quot;,
      &quot;price&quot;: 1500,
      &quot;page&quot;: 200,
      &quot;genres&quot;: [
        &quot;コンピュータ&quot;
        &quot;検索エンジン&quot;,
        &quot;Vespa&quot;
      ],
      &quot;reviews&quot;: {
        &quot;quality&quot;: 40,
        &quot;readability&quot;: 90,
        &quot;cost&quot;: 80
      }
    }
  },
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>まず、前節で起動した <code>vespa1</code> にログインします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose exec vespa1 /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、マウントされている <code>/vespa-sample-apps</code> 配下にあるサンプルデータを <code>vespa-feeder</code> を用いて登録します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-feeder /vespa-sample-apps/feed/book-data-put.json


Messages sent to vespa (route default) :
----------------------------------------
PutDocument:        ok: 13 msgs/sec: 46.93 failed: 0 ignored: 0 latency(min, max, avg): 212, 219, 215</code></pre>
</div>
</div>
<div class="paragraph">
<p>これでドキュメントの登録は完了です。
試しに以下のコマンドで検索を行うと、
<code>"totalCount":13</code> と登録されたドキュメントが返却されることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# curl 'http://localhost:8080/search/?query=sddocname:book'
{&quot;root&quot;:{&quot;id&quot;:&quot;toplevel&quot;,&quot;relevance&quot;:1.0,&quot;fields&quot;:{&quot;totalCount&quot;:13}, ...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>sddocname:book</code> は <code>book</code> インデックスのドキュメント全体について検索することを意味しています。
Solr や Elasticsearch でいうところの <code>q=*:*</code> みたいなイメージです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>feed されたドキュメントはレスポンスが返った時点で検索から見えるようになります。
また、トランザクションログのディスクへの書き出しの周期は OS 依存となっていて、典型的には 30 秒程度で反映されます。
詳しくは
<a href="http://docs.vespa.ai/documentation/content/consistency.html">Vespa consistency model</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="search">4. Vespa と検索</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、Vespa での検索方法について見ていきます。</p>
</div>
<div class="sect2">
<h3 id="search_query">4.1. 検索クエリ</h3>
<div class="paragraph">
<p>Vespa では検索クエリの指定方法として大きく2つのフォーマットが提供されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html">Search API</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/query-language.html">YQL</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本ドキュメントでは、このうち <code>Search API</code> の方に対象を絞って紹介します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>YQL</code> は SQL ライクに検索を行うことができる記法で、<code>Search API</code> を使うのに比べて、
より高度な検索が可能な機能となっています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Search API</code> を用いて検索を行う場合、URL は以下のようなパスとなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://${host]:8080/search/?p1=v1&amp;p2=v2&amp;...</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html">Vespa Search API reference</a>
にあるように、<code>Search API</code> では様々なパラメタが定義されていますが、ここでは基本的なものとして以下のパラメタについて説明します。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">パラメタ</th>
<th class="tableblock halign-center valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">language (lang)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クエリの言語を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hits (count)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返却するドキュメントの件数を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">offset (start)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返却するドキュメントの開始位置を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sorting</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索結果をソートする条件を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索対象を絞り込むためのフィルタ条件を指定します (ランキング計算にも影響)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recall</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索対象を絞り込むためのフィルタ条件を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">summary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンスに含めるフィールドのセットを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンスのフォーマットを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索リクエストのタイムアウト時間 (ms) を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tracelevel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンスに付与するデバッグ情報のレベル (1-9) を指定します。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespaのアクセスログは <code>/opt/vespa/logs/vespa/qrs/</code> に出力されます (時間は <code>UTC</code> です)。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 ~]# ls -l /opt/vespa/logs/vespa/qrs/
total 44
lrwxrwxrwx 1 vespa vespa    65 Feb 23 04:06 QueryAccessLog.container -&gt; /opt/vespa/logs/vespa/qrs/QueryAccessLog.container.20180223040658
-rw-r--r-- 1 vespa vespa   701 Feb 23 04:42 QueryAccessLog.container.20180223040658
lrwxrwxrwx 1 vespa vespa    66 Feb 23 04:07 QueryAccessLog.controller -&gt; /opt/vespa/logs/vespa/qrs/QueryAccessLog.controller.20180223040701
-rw-r--r-- 1 vespa vespa 37528 Feb 23 04:16 QueryAccessLog.controller.20180223040701</code></pre>
</div>
</div>
<div class="paragraph">
<p>後ろの <code>container</code> と <code>controller</code> が対応するコンポーネントを表していて、
検索リクエストのアクセスログは <code>QueryAccessLog.container</code> となります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>ranking</code> などのドキュメントのランキングに関わるパラメタは
<a href="#ranking">Vepsaとランキング</a>
で説明します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="search_query_language">4.1.1. language (lang)</h4>
<div class="paragraph">
<p><code>language</code> はクエリの言語指定を行うためのパラメタで、日本語での検索を行う際に重要です。
Vespa では、デフォルトでは検索クエリは英語 (<code>en</code>) であると解釈され、英語用のクエリ解析が行われます。
日本語で検索を行う場合は、以下のように <code>language</code> パラメタを用いて言語が日本語 (<code>ja</code>) であることを指定する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=ほげ</code></pre>
</div>
</div>
<div class="paragraph">
<p>例えば、今回のサンプルデータの場合、以下の2つのクエリで検索結果に差異があることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// ヒットなし
search/?query=入門書

// 1件ヒット
search/?language=ja&amp;query=入門書</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、前者では言語が英語と認識されているために、"入門書"がトークナイズされずそのまま検索クエリとして投げられているのに対し、
後者では言語が日本語となっているため、"/入門/書/"と2つのトークンに正しく分割されるという違いがあるためです。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>トークナイズされたトークンは内部的には AND 検索として扱われます。
例えば <code>入門書</code> の場合、内部的には <code>入門 AND 書</code> というクエリに展開されています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_query_query">4.1.2. query</h4>
<div class="paragraph">
<p><code>query</code> は実際の検索クエリを指定するパラメタです。
指定できる記法は
<a href="http://docs.vespa.ai/documentation/reference/simple-query-language-reference.html">Simple Query Language Reference</a>
となっていますが、典型的なものをピックアップすると以下のようになります。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 60%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">内容</th>
<th class="tableblock halign-center valign-top">クエリ</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">defaultフィールドに対して"foo"を検索</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">titleフィールドに対して"foo"を検索 (フィールド指定検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=title:foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"foo"かつ"bar"を含むものを検索 (AND検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=foo bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"foo"もしくは"bar"を含むものを検索 (OR検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=(foo bar)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"foo"を含むが"bar"を含まないものを検索 (NOT検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=foo -bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"foo bar"というフレーズを検索 (フレーズ検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query="foo bar"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000&lt;=price&lt;=10000</code> なものを検索 (範囲検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=price:[1000;10000]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"foo"に150%の重みを付与して検索 (重み付き検索)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query=foo!150 bar</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>重み付き検索は Solr や Elasticsearch における <code>Boosting</code> に対応した機能となります。
Vespa では百分率として重みを表現していて、デフォルト値は <code>100</code> です。
この重みは後述のランキングのスコア計算に影響してきます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa では <code>query=*foo*</code> のようなワイルドカード系のクエリは、
Vespa の設定ファイルで <code>mode="streaming"</code> と指定したインデックスにのみ使うことができます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_query_hits-offset">4.1.3. hits (count), offset (start)</h4>
<div class="paragraph">
<p><code>hits</code> と <code>offset</code> は検索結果のうちどの範囲を取得するかを指定します。
例えば、<code>hits=20</code> かつ <code>offset=10</code> と指定した場合、
最終的に得られた検索結果のうち、上から数えて11番目から30番目までの計20件を取得することを意味しています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>この例の場合、内部的には以下のような動きになります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>検索で上位30件 (<code>10+20=30</code>) の結果を取得</p>
</li>
<li>
<p>得られた30件のうち、11番目〜30番目の結果をレスポンスとして返却</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_query_sorting">4.1.4. sorting</h4>
<div class="paragraph">
<p><code>sorting</code> では検索結果をソートするときのルールを指定します。
<code>sorting</code> の記法は
<a href="http://docs.vespa.ai/documentation/reference/sorting.html">Query result sorting</a>
にまとめられていますが、基本的には以下のようにフィールド名に <code>+</code> か <code>-</code> を付けて指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// priceの昇順 ("+") でソート
select/?language=ja&amp;q=入門&amp;sorting=+price

// priceの降順 ("-") でソート
select/?language=ja&amp;q=入門&amp;sorting=-price

// priceの降順 ("-") でソートし、同一priceはpageの昇順 ("+") でソート
select/?language=ja&amp;q=入門&amp;sorting=-price +page

// relevancy (スコア) の降順でソート
select/?language=ja&amp;q=入門&amp;sorting=-[rank]</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記例のように、スペース区切りで複数の条件を並べることで多段にソートを行うことができます。
また、<code>[rank]</code> と指定した場合は特別な意味があり、これは文書の <code>relevancy</code> (ランキングのスコア) が参照されます。
なお、<code>sorting</code> が明示的に指定されていない場合は <code>sorting=-[rank]</code> がデフォルトで指定されます。</p>
</div>
</div>
<div class="sect3">
<h4 id="search_query_filter-recall">4.1.5. filter, recall</h4>
<div class="paragraph">
<p><code>filter</code> と <code>recall</code> は検索クエリ (<code>query</code>) とは別に検索対象を絞る条件を追加する目的で利用されます。
イメージとしては、</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>filter</code> および <code>recall</code> の条件式にマッチするドキュメントの集合を取得</p>
</li>
<li>
<p><code>query</code> の条件にマッチするドキュメントをその集合から選択</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>というような動作となります。</p>
</div>
<div class="paragraph">
<p><code>filter</code> と <code>recall</code> では <code>query</code> で用いたシンタックスがそのまま使えますが、
以下のように各クエリの先頭に <code>+</code> および <code>-</code> を付ける必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// titleに"python"を含む ("+") ドキュメントの中から、"入門"を含むものを選択
select/?language=ja&amp;q=入門&amp;filter=+title:python
select/?language=ja&amp;q=入門&amp;recall=+title:python

// titleに"python"を含まない ("-") ドキュメントの中から、"入門"を含むものを選択
select/?language=ja&amp;q=入門&amp;filter=-title:python
select/?language=ja&amp;q=入門&amp;recall=-title:python</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実際にURLとして指定するときは <code>+</code> を <code>%2b</code> とエンコードする必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>filter</code> と <code>recall</code> は
「<strong><code>filter</code> のフィルタ条件はランキングのスコア計算に影響するが、<code>recall</code> の方は影響しない</strong>」
という点で異なります。
例えば、<code>filter=+title:python</code> と指定した場合、title に <code>python</code> を含むかどうかがスコアに影響を与えます。
一方、<code>recall=+title:python</code> と指定した場合は単純にドキュメントのフィルタとして機能し、スコアには影響を与えません。</p>
</div>
<div class="paragraph">
<p>なお、<code>filter</code> には <code>+</code> と <code>-</code> の指定の他に、以下のように「なにも付けない」という指定も可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// titleに"python"を含むかどうかをスコア計算で考慮
select/?language=ja&amp;q=入門&amp;filter=title:python</code></pre>
</div>
</div>
<div class="paragraph">
<p>この場合、<code>filter</code> で指定した条件はドキュメントのヒット判定には影響しませんが、
ランキングのスコア計算のときに考慮されるようになります。
例えば、特定の単語を含むドキュメントのスコアを底上げしたい、のようなスコア調整をする際にこの記法が有効です。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>filter</code> および <code>recall</code> はSolrの <code>fq</code> のように複数指定することができない点に注意してください。
例えば、以下のように <code>filter</code> を2つ定義した場合、実際には最後のフィルタ条件のみが検索に影響し、それ以外は無視されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// "filter=+title:java"で"filter=+title:python"が上書きされる！
select/?language=ja&amp;q=入門&amp;filter=+title:python&amp;filter=+title:java</code></pre>
</div>
</div>
<div class="paragraph">
<p>このような AND 条件を指定したい場合は、以下のように一つのクエリとして表現する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>select/?language=ja&amp;q=入門&amp;filter=+title:python +title:java</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_query_summary">4.1.6. summary</h4>
<div class="paragraph">
<p><code>summary</code> はレスポンスに含めるフィールドのセットを指定します。
Vespa では、
<a href="#config_file_searchdefinitions">searchdefinitions</a>
の中で各フィールドが所属する
<a href="http://docs.vespa.ai/documentation/document-summaries.html#summary-classes-in-queries">summary-class</a>
を定義することでフィールドのセットを作成できます。</p>
</div>
<div class="paragraph">
<p><code>summary-class</code> の定義の方法は大きく2つあります。
1つ目は各フィールドに以下のような <code>summary-to</code> 属性を付与して所属するセット名を指定する方法です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>field title type string {
    indexing: index | summary
    summary-to: simple_set, detail_set <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>title</code> フィールドを <code>simple_set</code> と <code>full_set</code> というセットに追加</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>2つ目は以下のように <code>document-summary</code> というブロックで所属するフィールド群を指定する方法です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search book {
    ...
    document-sumamry simple-set {

        summary simple_set type string { <i class="conum" data-value="1"></i><b>(1)</b>
            source: title, price
        }

        summary detail_set type string { <i class="conum" data-value="2"></i><b>(2)</b>
            source: title, desc, price, genres
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>title</code> と <code>price</code> を含む <code>simple_set</code> というセットを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>title</code>、<code>desc</code>、<code>price</code>、<code>genres</code> を含む <code>detail_set</code> というセットを定義</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>検索では以下のように定義したセット名を <code>summary</code> として指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=入門&amp;summary=simple_set</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search_query_format">4.1.7. format</h4>
<div class="paragraph">
<p><code>format</code> はレスポンスのフォーマットの指定を行います。
Vespa はデフォルトでは <code>json</code> フォーマットでレスポンスを返しますが、
例えば <code>format=xml</code> と指定すると <code>xml</code> フォーマットでレスポンスが返却されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>レスポンスのフォーマットは独自の <code>Render</code> を実装することで、<code>json</code> や <code>xml</code> 以外のフォーマットにも対応させることができます。
詳しくは
<a href="http://docs.vespa.ai/documentation/result-rendering.html">Search Result Renderers</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_query_timeout">4.1.8. timeout</h4>
<div class="paragraph">
<p><code>timeout</code> では検索リクエストのタイムアウト時間を指定します。
Vespa ではデフォルトで <code>5000</code> ミリ秒のタイムアウトが設定されています。
もし、このタイムアウト時間を変更したい場合は、このパラメタにタイムアウト時間をミリ秒で指定して検索を行います。</p>
</div>
<div class="paragraph">
<p>ちなみに、検索がタイムアウトした場合は以下のように <code>Timed out</code> とレスポンスが返されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[root@vespa1 /]# curl 'http://localhost:8080/search/?query=java&amp;timeout=0'
{"root":{"id":"toplevel","relevance":1.0,"fields":{"totalCount":0},"errors":[{"code":12,"summary":"Timed out","source":"book","message":"The search chain 'book' timed out."}]}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search_query_tracelevel">4.1.9. tracelevel</h4>
<div class="paragraph">
<p><code>tracelevel</code> は検索リクエストのデバッグを行うときに指定するパラメタです。
Vespa では内部でこの <code>tracelevel</code> の値に応じてデバッグログのレスポンスへの付与を制御しています。
<code>tracelevel</code> は <code>1</code> から <code>9</code> までの9段階の指定が可能で、高いほどより詳細なログが出力されるようになります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>tracelevel</code> を有効にした時に出力されるログは、
Vespa が検索クエリを受けてからインデックス (<code>content</code> ノード) にリクエストを実際に投げるまでの区間のコンポーネントが出力します。
実際に実行すると分かりますが、
Vespa では検索クエリを投げてから実際にインデックスに飛ぶまでの間に <code>Searcher</code> と呼ばれるコンポーネントが呼び出され、
検索リクエストおよびレスポンスの加工処理を行っています。</p>
</div>
<div class="paragraph">
<p><code>tracelevel</code> の典型的な使い方の一つに「検索クエリのトークナイズの確認」があります。
例えば、<code>language</code> で紹介したヒット数の異なるクエリに <code>tracelevel=2</code> を付けて検索すると、</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?query=入門書&amp;tracelevel=2
... dispatch: query=[入門書] ...

search/?language=ja&amp;query=入門書&amp;tracelevel=2
... dispatch: query=[SAND 入門 書] ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>のように、最終的に検索されるクエリに差異があることがわかります。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search_grouping">4.2. グルーピング検索</h3>
<div class="paragraph">
<p>Vespa では他の検索エンジンと同様に
<a href="http://docs.vespa.ai/documentation/grouping.html">グルーピング検索</a>
の機能を提供しています。
Vespa のグルーピング機能は他の検索エンジンに比べて高機能で、
これだけで多種多様な集約系の処理が表現可能となっています。</p>
</div>
<div class="sect3">
<h4 id="search_grouping_syntax">4.2.1. グルーピングの構文</h4>
<div class="paragraph">
<p>Vespa のグルーピングの構文は公式ドキュメントの
<a href="http://docs.vespa.ai/documentation/reference/grouping-syntax.html">Query result grouping reference</a>
にまとめられています。
記載されている文法を見ると分かるように、非常に複雑なものとなっています。</p>
</div>
<div class="paragraph">
<p>実際に例を見ながら構文を説明していきます。
まず、サンプルデータに対して「<code>genres</code> の各要素毎にドキュメントを一つ選択して表示」を行う場合、
検索リクエストは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=sddocname:book&amp;select=all(group(genres) each(max(1) each(output(summary()))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>実際に検索すると、レスポンスに <code>"id": "group:root:0"</code> という要素が増えていることが確認できます。
また、 <code>"id": "group:root:0"</code> の <code>children</code> の下に各ジャンルに紐づくドキュメントが1件ずつ出力されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>非常に長い <code>json</code> が返ってくるので <code>jq</code> などの整形ツールを通すことを推奨します。
もしくは <code>format=xml</code> と付けてブラウザから参照すると見やすいかもしれません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:Elasticsearch</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Elasticsearch</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                  {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hitlist:hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:foo:book:g=foo:elasticsearch_science</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Elasticsearchで始めるデータサイエンス</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Elasticsearchとデータサイエンスツールとの連携について紹介します</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">3000</span>,
                          <span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>先程の検索リクエストの中で、グルーピングに関する部分は <code>select</code> パラメタになります。
<code>select</code> パラメタの中身を整形すると以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres)
  each(
    max(1)
    each(
      output(summary())
    )
  )
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>グルーピングの構文を理解するには、まず <code>all</code> と <code>each</code> を理解することが第一歩です。
外側の <code>all</code> は検索結果全体への操作を、内部の <code>each</code> はそれぞれ各グループおよび各ドキュメントへの操作を表しています。
上記の操作を図にすると以下のようなイメージとなります。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_grouping.jpg" alt="vespa grouping" width="900">
</div>
</div>
<div class="paragraph">
<p>Vespa のグルーピングはこのように、</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>all</code> もしくは <code>each</code> を指定して対象を選択する</p>
</li>
<li>
<p>選択対象に対する操作を記述する</p>
</li>
<li>
<p>1.に戻る</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>というように再帰的な手順を踏んで定義していきます。
<code>all</code> は後述の <code>group</code> 操作を行うときに指定が必要で、例えば多段のグルーピングを行うときに複数回出現します (
<a href="#search_grouping_example_nest">具体例</a>
参照)。
<code>each</code> はグルーピングで選ばれた要素に対して操作を行うときに利用します。
定義できる操作は対象がドキュメントの集合 (グループ) なのか、それとも単一のドキュメントなのか、
によって利用可否が決まるため、ルールを記述するときは今の選択範囲がどこなのかを意識することが重要となります。</p>
</div>
<div class="paragraph">
<p>グルーピングの対象は <code>group(field_name)</code> のように定義します。
上記例では <code>genres</code> という配列型のフィールドを対象としています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>グルーピングの対象として配列型のフィールドを指定した場合、
Vespa では配列中の各要素を独立なものとして集約処理が実施されます。</p>
</div>
<div class="paragraph">
<p>配列型要素のうち、特定のインデックスの要素が欲しい場合は、
<code>group(array.at(genres, 0))</code> のように <code>arrays.at(field, idx)</code> を利用することで取得が可能です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記例の中の <code>max(1)</code> はそのグループから最大で1件の結果を取得する事を意味しています。
初めの <code>each</code> の中で定義されているため、この操作の対象は各グループのドキュメント群となります。</p>
</div>
<div class="paragraph">
<p>最後に <code>output(summary())</code> はドキュメントの検索結果を出力することを意味しています。
2つ目の <code>each</code> の中で定義されているため、この操作の対象は各グループの各ドキュメントとなります。
<code>output</code> は検索レスポンスへの情報の付与に対応していて、
例えばグループを対象としている階層なら <code>output(avg(price))</code> のような統計値を指定もできます。
<code>summary</code> はドキュメントを対象としているときに指定できる操作で、前述のようにドキュメントの内容の参照に対応しています。</p>
</div>
</div>
<div class="sect3">
<h4 id="search_grouping_example">4.2.2. グルーピングの具体例</h4>
<div class="paragraph">
<p>前述のように、Vespa のグルーピングは <code>each</code> で対象を絞りつつ、各グループ or ドキュメントに対して操作を定義していくというものでした。
ここでは、実際に具体例を見ながら Vespa のグルーピングでできる機能について紹介していきます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここの具体例は代表的なものだけをピックアップしていますが、
Vespa のグルーピングではより複雑な処理も記述できます。
より詳細な機能を知りたい場合は
<a href="http://docs.vespa.ai/documentation/reference/grouping-syntax.html">Query result grouping reference</a>
に記載されている Example も併せて参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search_grouping_example_order">グループの並び順の変更</h5>
<div class="paragraph">
<p>Vespa のグルーピングでは、<code>order</code> という操作を用いてグループの並び順を制御できます。
例えば、各ジャンルについて所属するドキュメントの価格の最大値が高いものから順に表示したい場合は以下のような式となります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres) <i class="conum" data-value="1"></i><b>(1)</b>
  order(-max(price)) <i class="conum" data-value="2"></i><b>(2)</b>
  each(
    output(max(price)) <i class="conum" data-value="3"></i><b>(3)</b>
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>genres</code> の値についてグルーピング</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>各グループの <code>price</code> の最大値の降順でソート</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>結果がわかりやすいように各グループの <code>price</code> の最大値を出力</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>order</code> は得られたグループをどのように並び替えるかを指定するための式です。
この例では、<code>max(price)</code> から各グループの <code>price</code> 最大値が、
<code>-max(price)</code> と <code>-</code> がついてることから降順であることがわかります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>order</code> はグループの並び替えにのみ使えます。
例えば以下のようにドキュメントのソートに指定するとエラーになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres)
  each(
    order(-price) <i class="conum" data-value="1"></i><b>(1)</b>
    output(max(price))
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>UnsupportedOperationException: Can not order single group content.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これを例えば <code>query=title:入門</code> と組み合わせると、検索クエリは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=title:入門&amp;select=all(group(genres) order(-max(price)) each(output(max(price))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果、以下のようにタイトルに <code>入門</code> が含まれるドキュメントについて、価格の最大値が高い順のジャンルのグループが得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:Python</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.8</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:プログラミング</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.6</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:Vespa</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.4</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Vespa</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:検索エンジン</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.2</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>
                }
              }
            ]
          }
        ]
      },</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search_grouping_stat">各グループの統計情報の取得</h5>
<div class="paragraph">
<p>前述の <code>max(price)</code> のように、Vespa のグルーピングではグループ内の統計情報を取得するための操作が定義されています。
例えば、<code>genres</code> の各グループについて、 <code>price</code> の合計、平均、最小、最大、標準偏差を出力する場合は以下のような式になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres)
  order(-count()) <i class="conum" data-value="1"></i><b>(1)</b>
  each(
    output(sum(price)) <i class="conum" data-value="2"></i><b>(2)</b>
    output(avg(price)) <i class="conum" data-value="3"></i><b>(3)</b>
    output(min(price)) <i class="conum" data-value="4"></i><b>(4)</b>
    output(max(price)) <i class="conum" data-value="5"></i><b>(5)</b>
    output(stddev(price)) <i class="conum" data-value="6"></i><b>(6)</b>
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>グループをヒット件数 (<code>count()</code>) の降順で並び替え</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>price</code> の合計値 (<code>sum</code>) を出力</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>price</code> の平均値 (<code>avg</code>) を出力</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>price</code> の最小値 (<code>min</code>) を出力</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>price</code> の最大値 (<code>max</code>) を出力</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>price</code> の標準偏差 (<code>stddev</code>) を出力</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これを例えば <code>query=title:入門</code> と組み合わせると、検索クエリは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=title:入門&amp;select=all(group(genres) order(-count()) each(output(sum(price)) output(avg(price)) output(min(price)) output(max(price)) output(stddev(price))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果、以下のように各ジャンルでの <code>price</code> の統計値が出力されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">sum(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">3500</span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">avg(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">1750</span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">min(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">max(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">stddev(price)</span><span class="delimiter">&quot;</span></span>: <span class="integer">250</span>
                }
              },
              <span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上の例では、レスポンスのラベルが <code>sum(price)</code> のように式そのままになっていますが、
Vespaでは以下のように <code>as(name)</code> 構文を使うことで出力ラベルを変更する事ができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres)
  order(-count())
  each(
    output(sum(price) as(sum_price)) <i class="conum" data-value="1"></i><b>(1)</b>
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>レスポンスのラベルを <code>sum_price</code> に変更</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search_grouping_facet">各グループに対するヒット数および検索結果を取得</h5>
<div class="paragraph">
<p>いわゆる <code>faceting</code> や <code>result grouping</code> に対応する処理も、
Vespa ではグルーピング式を用いて定義します。</p>
</div>
<div class="paragraph">
<p>例えば、<code>genres</code> の各グループについて、ヒット数と上位3件を表示する場合は以下のような式になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(genres)
  order(-count())
  each(
    max(3) <i class="conum" data-value="1"></i><b>(1)</b>
    output(count() as(total)) <i class="conum" data-value="2"></i><b>(2)</b>
    each(
      output(summary()) <i class="conum" data-value="3"></i><b>(3)</b>
    )
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>各グループから最大で3件を取得</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>各グループのヒット数 (<code>count()</code>) を "total" というラベル (<code>as(total)</code>) で取得</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>各ドキュメントの情報 (<code>summary()</code>) を出力</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これを例えば <code>query=title:入門</code> と組み合わせると、検索クエリは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=title:入門&amp;select=all(group(genres) order(-count()) each(max(3) output(count() as(total)) each(output(summary()))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果、以下のように各ジャンルでのヒット数と検索結果が出力されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                  {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hitlist:hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15974580091895013</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python本格入門</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">今話題のPythonの使い方をわかりやすく説明します</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">450</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">70</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
                            }
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>
                        }
                      },
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15968230614070084</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ゼロから始めるVespa入門</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">話題のOSS検索エンジン、Vespaの使い方を初心者にもわかりやすく解説します</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">Vespa</span><span class="delimiter">&quot;</span></span>
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">40</span>
                            }
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>
                        }
                      }
                    ]
                  }
                ]
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:Python</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.8</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                  {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hitlist:hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15974580091895013</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python本格入門</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">今話題のPythonの使い方をわかりやすく説明します</span><span class="delimiter">&quot;</span></span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">450</span>,
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">70</span>
                            },
                            {
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
                              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
                            }
                          ],
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>
                        }
                      }
                    ]
                  }
                ]
              },
              <span class="error">.</span><span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vespa のグルーピングでは、各グループ内のドキュメント群は <code>relevancy</code> の降順でソートされます。
そのため、<code>max</code> 指定をした場合は <strong>そのグループを <code>relevancy</code> の降順で並べた場合の上位</strong> が選ばれます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記のように、Vespa のグルーピングでは、グループ内のドキュメントは必ず <code>relevancy</code> 順でソートされるという制約があります。
そのため、<code>sorting</code> のように特定のフィールドを指定してソートということがクエリからはできません。</p>
</div>
<div class="paragraph">
<p>幸い、<code>relevancy</code> の計算方法は
<a href="#ranking">次章</a>
で述べるようにカスタマイズが可能なため、
例えば価格の降順に並ぶようなスコア式を定義することで <code>sorting</code> と同じような動作をさせることが可能です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search_grouping_example_bucket">連続値に対するグルーピング</h5>
<div class="paragraph">
<p>Vepsa では連続値のフィールドに対しても、分割の単位 (<code>bucket</code>) を定義することでグルーピングを行うことができます。
例えば、<code>price</code> を 2000円未満、2000円以上4000未満、4000円以上 の3つのバケットでグルーピングする場合の式は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(
    predefined(  <i class="conum" data-value="1"></i><b>(1)</b>
      price,  <i class="conum" data-value="2"></i><b>(2)</b>
      bucket(0, 2000),  <i class="conum" data-value="3"></i><b>(3)</b>
      bucket(2000, 4000),  <i class="conum" data-value="4"></i><b>(4)</b>
      bucket(4000, inf)  <i class="conum" data-value="5"></i><b>(5)</b>
    )
  )
  each(
    output(count())
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>predefined(field, bucket, &#8230;&#8203;)</code> でグルーピング対象のバケットを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>対象フィールドは <code>price</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>0 &lt;= price &lt; 2000</code> のバケットを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>2000 &lt;= price &lt; 4000</code> のバケットを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>4000 &lt;= price</code> のバケットを定義</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>例えば、全ドキュメントに対して上記のグルーピングを組み合わせると以下のような検索クエリになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=sddocname:book&amp;select=all(group(predefined(price, bucket(0, 2000), bucket(2000, 4000), bucket(4000, inf))) each(output(count())))</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果、以下のように各価格帯でのヒット件数が得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:predefined(price, bucket[0, 2000&gt;, bucket[2000, 4000&gt;, bucket[4000, inf&gt;)</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">predefined(price, bucket[0, 2000&gt;, bucket[2000, 4000&gt;, bucket[4000, inf&gt;)</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:long_bucket:0:2000</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">limits</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:long_bucket:2000:4000</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">limits</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">4000</span><span class="delimiter">&quot;</span></span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">6</span>
                }
              },
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:long_bucket:4000:9223372036854775807</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">limits</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">4000</span><span class="delimiter">&quot;</span></span>,
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">9223372036854775807</span><span class="delimiter">&quot;</span></span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>
                }
              }
            ]
          }
        ]
      },
      <span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>bucket(low, high)</code> という記法は、内部的には <code>bucket[low, high&gt;</code> という記法に展開されます。
<code>bucket</code> では括弧で開区間と閉区間を表現しており、
<code>[ ]</code> は閉区間 (<code>bucket[low, high] : low &lt;= val &lt;= high</code>) に、
<code>&lt; &gt;</code> は開区間 (<code>bucket&lt;low, high&gt; : low &lt; val &lt; high</code>) に対応しています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search_grouping_example_nest">多階層グルーピング</h5>
<div class="paragraph">
<p>Vespa ではグルーピングの中でさらにグルーピングを定義する、いわゆる多階層グルーピングをサポートしています。
例えば、<code>genres</code> の第一ジャンルでグルーピングしたのち、さらに第二ジャンルでグルーピングする場合は以下のような式になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(array.at(genres, 0)) <i class="conum" data-value="1"></i><b>(1)</b>
  each(
    output(count()) <i class="conum" data-value="2"></i><b>(2)</b>
    all(
      group(array.at(genres, 1)) <i class="conum" data-value="3"></i><b>(3)</b>
      each(
        output(count()) <i class="conum" data-value="4"></i><b>(4)</b>
      )
    )
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>第一ジャンル (<code>array.at(genres, 0)</code>) でグルーピング</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>第一ジャンルの各グループについてヒット数を出力</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>第二ジャンル (<code>array.at(genres, 1)</code>) でさらにグルーピング</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>第二ジャンルの各グループについてヒット数を出力</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>新しい <code>group</code> を定義する場合、ブロックを <code>all</code> でくくって明示的に全体を対象することを宣言する必要があります。
例えば、以下のように <code>all</code> でくくらなかった場合はエラーとなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>all(
  group(array.at(genres, 0))
  each(
    output(count())
    group(array.at(genres, 1)) <i class="conum" data-value="1"></i><b>(1)</b>
    each(
      output(count())
    )
  )
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>all</code> ではなく <code>each</code> の中で <code>group</code> が宣言されているためエラーとなる</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これを例えば <code>query=title:入門</code> と組み合わせると、検索クエリは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=title:入門&amp;select=all(group(array.at(genres, 0)) each(output(count()) all(group(array.at(genres, 1)) each(output(count())))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果、以下のように第一ジャンルと第二ジャンルでネストしたグルーピング結果が取得されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:root:0</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">continuation</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
          {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:array.at(genres, 0)</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">array.at(genres, 0)</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
              {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15974580091895013</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                  <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>
                },
                <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                  {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">grouplist:array.at(genres, 1)</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">array.at(genres, 1)</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:プログラミング</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15974580091895013</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
                        }
                      },
                      {
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">group:string:検索エンジン</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.15968230614070084</span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
                        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
                          <span class="key"><span class="delimiter">&quot;</span><span class="content">count()</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      <span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search_other">4.3. その他の検索</h3>
<div class="paragraph">
<p>Vespa ではここまでで紹介した検索以外にも、次のような機能が提供されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/geo-search.html">位置検索</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/wand-operator.html">WAND 検索</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/predicate-fields.html">Predicate フィールド</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/streaming-search.html">ストリーミング検索</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>この節では、これら機能の概要について簡単に紹介します (詳細は公式ドキュメントを参照してください)。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>WAND 検索と Predicate フィールドでは検索クエリとして
<a href="http://docs.vespa.ai/documentation/query-language.html">YQL</a>
を用いる必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="search_other_spatial">4.3.1. 位置検索</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/geo-search.html">位置検索</a>
では、スキーマ定義の時に <code>position</code> 型という緯度・経度を保持するフィールドを定義して利用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// schema
field latlong type position { <i class="conum" data-value="1"></i><b>(1)</b>
  indexing: attribute
}

// feed
"fields": {
  "latlong": "N35.680;W139.737" <i class="conum" data-value="2"></i><b>(2)</b>
}

// search
search/?query=yahoo&amp;pos.ll=N35.680%3BW139.737&amp;pos.radius=1km <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>position</code> 型としてフィールドを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>北緯32.680度、東経139.737を登録</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>北緯32.680度、東経139.737の地点から半径1km圏内</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上の例のように、位置検索では緯度・経度に基づく範囲検索が可能となっています。</p>
</div>
</div>
<div class="sect3">
<h4 id="search_other_wand">4.3.2. WAND 検索</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/wand-operator.html">WAND 検索</a>
は
<a href="http://cis.poly.edu/westlab/papers/cntdstrb/p426-broder.pdf">Broder 等の論文</a>
で発表された <code>WAND</code> (<code>Weak AND</code> or <code>Weighted AND</code> の略) と呼ばれる手法を用いた検索機能です。
WAND 検索は、イメージとして以下のようにクエリとドキュメントの各単語に重みを付け、
その内積のスコアを元に Top Nを検索するような手法です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>query : {"foo": 2, "bar": 4}

doc1 : {"foo": 0.6, "fizz": 0.1} -&gt; 2 * 0.6 = 1.2
doc2 : {"foo": 0.3, "bar": 0.5}  -&gt; 2 * 0.3 + 4 * 0.5 = 2.6
doc3 : {"bar": 0.2, "buzz": 0.8} -&gt; 4 * 0.2 = 0.8</code></pre>
</div>
</div>
<div class="paragraph">
<p>WAND 検索では、ドキュメントの各単語について全ドキュメント中での上限スコアを予め計算し、
それを用いて候補ドキュメントを効率的に枝刈りしていきます。
なお、WAND 検索を行う場合、対象のフィールドは <code>weightedset</code> として定義されている必要があります。</p>
</div>
<div class="paragraph">
<p>WAND 検索は、特に非常に多くの OR 条件があるようなクエリを扱う場合に効果的です。
典型的な例としては「ユーザの行動履歴に基いてレコメンドを行うシステム」が考えられます。
レコメンドシステムでは、ユーザが行動履歴から推定されたユーザのタグ情報と、
ドキュメントが持つタグ情報との類似度を計算して、ユーザが興味を持ちそうなドキュメントを選択します。
この類似度は2つのタグ集合 (ベクトル) の内積として表現できるため、
先程の例の "単語" を "タグ"、"重み" を "関連度" に置き換えれば実現できることがわかります。
このタグ情報は非常に種類が多くなるはずで、普通にユーザの興味タグを OR 検索すると計算コストがとても大きくなります。
それに対して、WAND 検索の場合は前述のように検索の過程で効率的に枝刈りを行うため、計算コストを劇的に抑えることができます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa のドキュメントでは WAND 検索として <code>Parallel Wand</code> と <code>Vespa Wand</code> の2つがありますが、
ここでの例は <code>Parallel Wand</code> について記述しています。</p>
</div>
<div class="paragraph">
<p><code>Parallel Wand</code> はいわゆる <code>WAND</code> アルゴリズムを実装したものとなっており、
Top N の結果が実際のスコアの大小と一致することが保障されていますが、
検索対象として1つのフィールドしか指定できず、スコア計算も内積限定となっています。
一方、<code>Vespa Wand</code> では複数のフィールドを指定したり、独自のスコア計算を利用したりできますが、
枝刈りのスコア計算にヒューリスティックな手法が利用されるため、
最終スコアが高いドキュメントでも検索の途中で枝刈りされてしまう可能性があります。</p>
</div>
<div class="paragraph">
<p>個人的な見解としては、
WAND 検索を行うならば理論保障がしっかりしている <code>Parallel Wand</code> をまずは検討するのが無難かと思います。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search_other_predicate">4.3.3. Predicate フィールド</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/predicate-fields.html">Predicate フィールド</a>
はドキュメント側に条件式を埋め込み、検索クエリで指定された属性値にマッチしたドキュメントを返却する機能です。
通常の検索の場合は検索クエリ側で条件式を書きますが、
Predicate フィールドではインデックス側にその構造を埋め込む、というのが特徴です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// schema
field target type predicate { <i class="conum" data-value="1"></i><b>(1)</b>
  indexing: attribute
}

// feed
"fields": {
  "target": "gender in [Female] and age in [20..30]" <i class="conum" data-value="2"></i><b>(2)</b>
}

// query
select/?yql=select * from sources * where predicate(target, {"gender":"Female"}, {"age": 20L}) <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>predicate</code> 型としてフィールドを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ドキュメントのターゲットを女性 (<code>gender in [Female]</code>) で20-30歳 (<code>age in [20..30]</code>) に設定</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>女性 (<code>{"gender":"Female"}</code>) かつ 20歳 (<code>{"age":20L}</code>) にマッチするドキュメントを検索</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>クエリ中の <code>predicate</code> は、
第一引数にフィールド名、第二引数にカテゴリ条件、第三引数に範囲条件を指定します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Predicate フィールドの典型的な利用例としては、広告のターゲティングが考えられます。
広告のターゲティングの場合、ドキュメントは広告本体であり、
そこに Predicate フィールドとして広告のターゲット層の条件式を指定することになります。
検索時はユーザの属性情報をクエリに指定することで、対応する広告が取得できます。</p>
</div>
</div>
<div class="sect3">
<h4 id="search_other_streaming">4.3.4. ストリーミング検索</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/streaming-search.html">ストリーミング検索</a>
はドキュメントを <code>grep</code> で検索するような機能に相当します。
ストリーミング検索ではインデックス構造が通常とは異なり、転置インデックスを構築せずに生データのみを保持します。
このため、ストリーミング検索を有効にするためには、
インデックス構築時に以下のような明示的に <code>streaming</code> を指定する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;content id="mycluster" version="1.0"&gt;
  &lt;documents&gt;
    &lt;document type="mytype" mode="streaming" /&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>インデックス構造が変わるため、設定を変更する場合は再インデックスが必須です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ストリーミング検索では、全てのドキュメントを検索するのは非常にコストがかかるためで、
検索時に検索対象のドキュメントのブロックを指定する必要があります。
このブロックは
<a href="#update_request_docid">ドキュメントID</a>
の TIP の中で説明した <code>n=NUM</code> および <code>g=GROUP</code> の指定が対応します。</p>
</div>
<div class="paragraph">
<p>ストリーミング検索では、以下のようにワイルドカードを用いた検索が可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?q=*ytho*&amp;streaming.userid=12345678</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで、<code>streaming.userid</code> はドキュメント ID の <code>n=NUM</code> に相当する番号です。
<code>g=GRUOP</code> と指定して登録した場合は <code>streaming.groupname</code> を用います。</p>
</div>
<div class="paragraph">
<p>ストリーミング検索は非常に限定的な範囲を検索するときに選択肢の一つとなります。
具体例としては、ユーザが自分自身のデータを検索するようなケース (メールとか) が考えられます。
このユースケースの場合、ユーザが参照するドキュメントは非常に限定的であり、
その配置は前述のドキュメント ID の指定で制御が可能なため、ストリーミング検索の適用できます。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ranking">5. Vespa とランキング</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、
<a href="http://docs.vespa.ai/documentation/ranking.html">Vespa のランキング</a>
について見ていきます。</p>
</div>
<div class="sect2">
<h3 id="ranking_phase">5.1. ランキングの流れ</h3>
<div class="paragraph">
<p>Vespa のランキングは以下の図のように大きく3つのフェーズで構成されます。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_ranking_phase.jpg" alt="vespa ranking phase" width="900">
</div>
</div>
<div class="sect3">
<h4 id="ranking_phase_match">5.1.1. match-phase</h4>
<div class="paragraph">
<p><code>match-phase</code> は実際のランキング計算の前に存在するフェーズで、
特定のフィールド値に基いて候補文書を選択します。
選択の基準には、例えば最終スコアと相関のあるフィールド値 (ex. クリック数とか) や、
事前にフィード時に計算した静的スコアなどが一般的に利用されます。</p>
</div>
<div class="paragraph">
<p>Vespa ではこれに加え、特定のフィールド値について候補文書を多様化 (<code>diversity</code>) する機能もこのフェーズで実行できます。
これは、例えば「<code>match-phase</code> で選択された文書には最低でも10個の異なるカテゴリの文書を含める」のように、
検索候補のバリエーションを担保する操作のことです。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>match-phase</code> は候補文書が非常に多い、もしくは <code>first-phase</code> のスコア式のコストが高い、
などの理由で次段の <code>first-phase</code> の計算コストが問題となる場合のフィルタリングとして利用されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ranking_phase_first">5.1.2. first-phase</h4>
<div class="paragraph">
<p><code>first-phase</code> では計算コストの相対的に小さいスコア計算 (検索モデル) を用いて、
次段の <code>second-phase</code> で評価対象となる候補文書を絞り込みます。
最終的なソートは次段の <code>second-phase</code> が担当するため、
<code>first-phase</code> では 「文書群の中からいかに上位候補を網羅して選択するか (再現率、<code>recall</code> の最大化)」
が重要となります。</p>
</div>
<div class="paragraph">
<p><code>first-phase</code> で利用するスコア計算は、
一般的には <code>second-phase</code> で用いるスコア計算と相関があるような式を選びます。
Vespaでは、クエリと文書との関連度をざっくり計算するヒューリスティックな軽量関数 (
<a href="http://docs.vespa.ai/documentation/reference/nativerank.html">nativeRank</a>
) が提供されており、
デフォルトではそれが <code>first-phase</code> のスコア計算で利用されます。</p>
</div>
<div class="paragraph">
<p>なお、多くの場合、<code>first-phase</code> で絞り込まれる件数は <code>100-1000</code> 程度のオーダとなります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このように軽量モデルと重量モデルの2段階でランキングを行う手法は <code>two-phase ranking</code> とVespaでは呼ばれています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ranking_phase_second">5.1.3. second-phase</h4>
<div class="paragraph">
<p><code>second-phase</code> では <code>first-phase</code> で選ばれた候補文書を再度スコア計算し、最終的な順位付けを行います。
このフェーズで選ばれた上位の文書が実際にユーザに返却されるレスポンスとなるため、
<code>second-phase</code> では「文書群の中からいかに真に関連する文書を選択するか (適合率、<code>precision</code> の最大化)」
が重要となります。</p>
</div>
<div class="paragraph">
<p><code>second-phase</code> は前述の通りその精度がユーザのレスポンスに直結するため、
一般的に機械学習を用いた複雑で高精度なモデルがスコア計算で利用されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>検索でよく使われるモデルとしては
<a href="http://xgboost.readthedocs.io/en/latest/model.html">アンサンブル木</a>
があげられます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ranking_profile">5.2. rank-profile</h3>
<div class="paragraph">
<p>Vespa ではランキングは
<a href="#config_file_searchdefinitions">searchdifinitions</a>
の中に
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#rank-profile">rank-profile</a>
として定義します。
例えば、チュートリアルの
<code>sample-apps/config/ranking/searchdefinitions/book.sd</code>
では以下のように3つのランキングが定義されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile basic inherits default {

        first-phase {
            expression: nativeRank
        }

    }

    rank-profile price_boost inherits basic {

        rank-properties {
            query(bias) : 0.1
        }

        macro price_boost() {
            expression: file:price_boost.expression
        }

        macro boosted_score(bias) {
            expression {
                (1.0 - bias) * firstPhase
                + bias * price_boost
            }
        }

        second-phase {
            expression: boosted_score(query(bias))
            rerank-count: 3
        }

    }

    rank-profile reviews_prefer inherits default {

        first-phase {
            expression: dotProduct(reviews, prefer)
        }

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>rank-profile</code> で定義される代表的な要素として以下のようなものがあります。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">要素</th>
<th class="tableblock halign-center valign-top">役割</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rank-properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ランク計算で利用する種々のパラメタを定義します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">macro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">計算式を一つにまとめたマクロを定義します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">first-phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>first-phase</code> で利用するスコア計算を定義します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">second-phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>second-phase</code> で利用するスコア計算を定義します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inherits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">他の <code>rank-profile</code> の定義を継承します。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本チュートリアルでは <code>match-phase</code> については説明しません。
興味のある人は公式ドキュメントの
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#match-phase">match-phase</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ranking_profile_rank-properties">5.2.1. rank-properties</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#rankproperties">rank-properties</a>
には各種組み込み素性の設定を以下のフォーマットで指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>rank-properties {
    &lt;featurename&gt;.&lt;configuration-property&gt;: &lt;value&gt;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>rank-properties</code> で指定可能なパラメタは公式ドキュメントの以下のページに記載があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/ranking.html#using-query-variables">Ranking</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/nativerank.html">nativeRank reference</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/rank-feature-configuration.html">Rank feature configuration</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>指定可能な <code>rank-properties</code> を1ページでまとめた公式ドキュメントがどうもないように見えます。。。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>チュートリアルの例では、以下のように <code>query</code> という検索クエリから動的に値を指定する素性について、
そのデフォルト値の定義が書かれています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        rank-properties {
            query(bias) : 0.1 <i class="conum" data-value="1"></i><b>(1)</b>
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>query(bias)</code> という素性のデフォルト値を <code>0.1</code> に設定</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ranking_profile_macro">5.2.2. macro</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#macro-rank">macro</a>
ではスコア計算をまとめたマクロを定義します。
共通ロジックをマクロとして切り出して使いまわすことで、<code>rank-profile</code> の見通しがよくなります。
また、後述の継承機能を利用することで、ベースの <code>rank-profile</code> に共通ロジックのマクロをまとめておき、
継承先の <code>rank-profile</code> でそれらを参照する、といった使い方も可能です。</p>
</div>
<div class="paragraph">
<p>チュートリアルの例では、以下のように <code>price_boost</code> と <code>boosted_score</code> という2つのマクロが定義されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        macro price_boost() { <i class="conum" data-value="1"></i><b>(1)</b>
            expression: file:price_boost.expression
        }

        macro boosted_score(bias) { <i class="conum" data-value="2"></i><b>(2)</b>
            expression {
                (1.0 - bias) * firstPhase
                + bias * price_boost
            }
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>引数なしマクロとして <code>price_boost</code> を定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>引数ありマクロとして <code>boosted_score(bias)</code> を定義</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>なお、上記例の <code>boosted_score</code> のように、マクロには引数を定義することも可能です。</p>
</div>
</div>
<div class="sect3">
<h4 id="ranking_profile_first-phase">5.2.3. first-phase</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#firstphase-rank">first-phase</a>
では前述の <code>first-phase</code> での具体的なスコア計算を定義します。</p>
</div>
<div class="paragraph">
<p>チュートリアルの例では、以下のよう <code>expression</code> として数式の定義がされています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        first-phase {
            expression: nativeRank <i class="conum" data-value="1"></i><b>(1)</b>
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>first-phase</code> のスコアとして <code>nativeRank</code> を用いる。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>なお、<code>first-phase</code> を明示的に指定しなかった場合、デフォルトでは <code>nativeRank</code> がスコア計算として利用されます。</p>
</div>
</div>
<div class="sect3">
<h4 id="ranking_profile_second-phase">5.2.4. second-phase</h4>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#secondphase-rank">second-phase</a>
では前述の <code>second-phase</code> での具体的なスコア計算を定義します。</p>
</div>
<div class="paragraph">
<p>チュートリアルの例では、以下のように <code>first-phase</code> とほぼ同じ見た目で定義がされています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        second-phase {
            expression: boosted_score(query(bias)) <i class="conum" data-value="1"></i><b>(1)</b>
            rerank-count: 3 <i class="conum" data-value="2"></i><b>(2)</b>
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>second-phase</code> のスコアとして <code>boosted_score(query(bias))</code> を用いる。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>first-phase</code> の返却値のうち上位3件を <code>second-phase</code> の対象とする。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>second-phase</code> で指定される <code>rerank-count</code> は、
<code>first-phase</code> のスコアでソートされたドキュメントの上位何件を <code>second-phase</code> の評価対象とするかを指定しています。
<code>rerank-count</code> のデフォルト値は <code>100</code> で、<code>100-1000</code> 程度の値が使われる印象です (計算コストと相談)。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>もし、<code>rerank-count: 100</code> に対して <code>count=200</code> のようにレスポンスの要求件数が多かった場合、
最終的に返却されるレスポンスは、</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1-100</code> : <code>second-phase</code> でリランキングされた結果</p>
</li>
<li>
<p><code>101-200</code> : <code>first-phase</code> でソートされた結果</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>という順番となり、足りない分は <code>first-phase</code> のスコアを用いて補填されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ranking_profile_inherits">5.2.5. inherits</h4>
<div class="paragraph">
<p><code>inherits</code> は <code>rank-profile</code> を定義するときに指定する要素で、別の <code>rank-profile</code> からの継承を指定します。</p>
</div>
<div class="paragraph">
<p>チュートリアルの例では、以下のように継承が定義されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile basic inherits default { <i class="conum" data-value="1"></i><b>(1)</b>
        ...
    }

    rank-profile price_boost inherits basic { <i class="conum" data-value="2"></i><b>(2)</b>
        ...
    }

    rank-profile reviews_prefer inherits default { <i class="conum" data-value="3"></i><b>(3)</b>
        ...
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>default</code> を継承して <code>basic</code> を定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>basic</code> を継承して <code>price_boost</code> を定義</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>default</code> を継承して <code>reviews_prefer</code> を定義</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記例で出てくる <code>default</code> は Vespa がデフォルトで定義している <code>rank-profile</code> です。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa の継承はいわゆる <code>override</code> の方式で行われます。
例えば、以下のような継承関係があった場合 (<code>properties</code> はテキトーです)、</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile profile_A inherit default {
        rank-properties {
            "foo" : 1.0
        }
    }

    rank-profile profile_B inherit profile_A {
        rank-properties {
            "bar" : 0.5
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>最終的な <code>profile_B</code> の見た目は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile profile_B inherit default {
        rank-properties {
            "bar" : 0.5
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記例のように、<code>profile_A</code> が持っていた <code>"foo" : 1.0</code> という設定は <code>profile_B</code> には継承されず、
<code>rank-properties</code> 全体が上書き (<code>orveride</code>) されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ranking_expression">5.3. ランク式</h3>
<div class="paragraph">
<p>Vespaでは上記例の中でもでてきたように、
スコア式を数式 (ランク式) として記述できます。</p>
</div>
<div class="sect3">
<h4 id="ranking_expression_profile">5.3.1. rank-profile上での書き方</h4>
<div class="paragraph">
<p><code>rank-profile</code> 上では、<code>expression</code> というキーの後に数式を書きます。
書き方としては以下の3種類があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>expression: 1+2 <i class="conum" data-value="1"></i><b>(1)</b>

expression { <i class="conum" data-value="2"></i><b>(2)</b>
  1
  +
  2
}

expression: file: myfunc.expression <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ワンライナーでランク式を記述</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>複数行に分けてランク式を記述</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ランク式を外部ファイル (<code>myfunc.expression</code>) に書いて読み込み</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3つ目の外部ファイルを利用する場合、<code>myfunc.expression</code> は以下のように <code>searchdefitions</code> の階層に配置する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>myconfig/
`- searchdefinitions/
   |- myindex.sd
   |- myfunc.expression
   `- ...

$ cat myconfig/searchdefinitions/myfunc.expression
1+2</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa 内部では
<a href="https://llvm.org/">LLVM</a>
を用いてランク式をコンパイルしています。そのため、実行時は高速にスコア計算が可能です (コード的にはたぶん
<a href="https://github.com/vespa-engine/vespa/tree/master/eval/src/vespa/eval/eval">この辺</a>
)。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa は外部ファイルも <code>configserver</code> にアップロードして配布します。
そのため、非常に大きなモデルファイルを上げる場合は
<code>configserver</code> (i.e., <code>ZooKeeper</code>) のバッファサイズ上限に引っかかる可能性があるので注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ranking_expression_syntax">5.3.2. ランク式の記法</h4>
<div class="paragraph">
<p>Vespa では、
<a href="http://docs.vespa.ai/documentation/reference/ranking-expressions.html">Ranking Expressions</a>
にあるように、</p>
</div>
<div class="ulist">
<ul>
<li>
<p>四則演算 (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>)</p>
</li>
<li>
<p>数学関数 (<code>cos</code>, <code>sin</code>, <code>tan</code>, etc&#8230;&#8203;)</p>
</li>
<li>
<p>条件式 (<code>if(cond, true, false)</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>といった記法を使うことができます。</p>
</div>
<div class="sect4">
<h5 id="ranking_expression_syntax_arithmetic">四則演算</h5>
<div class="paragraph">
<p>以下のように通常のプログラミングのように記述します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>a + b - c * d / (e + f)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>剰余算は <code>fmod(x,y)</code> という数学関数を用いて書きます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_syntax_math">数学関数</h5>
<div class="paragraph">
<p>Vespa のランク式では以下のような数学関数が利用できます (意味は通常のプログラミングでの関数と同じです)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">関数</th>
<th class="tableblock halign-center valign-top">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cosh(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>cosh</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sinh(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>sinh</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tanh(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>sinh</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cos(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>cos</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sin(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>sin</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tan(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>tan</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">acos(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>acos</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">asin(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>asin</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">atan2(y, x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>y/x</code> に対する <code>atan</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">atan(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>atan</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exp(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する <code>exp</code> の値 (<code>e^x</code>) を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldexp(x, exp)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x * 2^exp</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log10(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する常用対数 (基底が <code>10</code>) の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する自然対数 (基底が <code>e</code>) の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pow(x, y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x^y</code> の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqrt(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> に対する平方根の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ceil(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> より大きい最小の整数の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fabs(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> の絶対値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">floor(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> より小さい最大の整数の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isNan(x)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>NaN</code> の場合に <code>1.0</code> を、それ以外の場合に <code>0.0</code> を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmod(x, y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x / y</code> の余り (<code>x % y</code>) の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min(x, y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> と <code>y</code> のうち小さい方の値を返します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max(x, y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> と <code>y</code> のうち大きい方の値を返します。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="ranking_expression_syntax_condition">条件式</h5>
<div class="paragraph">
<p>Vespa のランク式では条件式は以下のような3項演算子として記述します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>if (expression1 operator expression2, trueExpression, falseExpression)</code></pre>
</div>
</div>
<div class="paragraph">
<p>第一項は条件式が入り、以下のような条件演算子が使えます。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">演算子</th>
<th class="tableblock halign-center valign-top">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x &lt;= y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>y</code> 以下の場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x &lt; y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>y</code> 未満の場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x == y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> と <code>y</code> が等しい場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x ~= y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> と <code>y</code> がほぼ等しい場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x &gt;= y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>y</code> 以上の場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x &gt; y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>y</code> より大きい場合に <code>true</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x in [a,b,c,&#8230;&#8203;]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code> が <code>[a,b,c,&#8230;&#8203;]</code> のセットの中のいずれかと等しい場合に <code>true</code>。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>~=</code> は2つの値が単精度浮動小数点数 (<code>float</code>) の精度で等しいかを判定します (
<a href="https://github.com/vespa-engine/vespa/blob/master/vespalib/src/vespa/vespalib/util/approx.h">コード</a>)。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>第二項は条件式が <code>true</code> の時に実行されるランク式が、
第三項は条件式が <code>false</code> の時に実行されるランク式がそれぞれ入ります。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ranking_expression_feature">5.3.3. 組み込み素性</h4>
<div class="paragraph">
<p>Vespa では以下のドキュメントのようにランク式を記述するときに役に立つ様々な組み込み素性 (ランク素性) が定義されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/rank-features.html">Rank feature reference</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ここでは代表的なものをピックアップして簡単に紹介します。</p>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_nativeRank">nativeRank</h5>
<div class="paragraph">
<p><code>nativeRank</code> は Vespa の中でよく用いられるヒューリスティックなスコア計算式で、
後述の <code>nativeFieldMatch</code>、<code>nativeProximity</code>、および <code>nativeAttributeMatch</code> の加重平均として計算されます (
<a href="http://docs.vespa.ai/documentation/reference/nativerank.html#nativeRank">数式</a>
)。</p>
</div>
<div class="paragraph">
<p>加重平均で用いる各素性の重みは <code>rank-properties</code> で調整可能で、デフォルト値は以下のようになっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>rank-properties {
    nativeRank.fieldMatchWeight: 100.0
    natievRank.proximityWeight: 25.0
    nativeRank.attributeMatchWeight: 100.0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、<code>nativeRank</code> はデフォルトでは検索クエリで指定された全てのフィールドが評価対象となります。
特定のフィールドに限定した結果が欲しい場合は、
<code>nativeRank(title, desc)</code> のように引数に対象のフィールド名を列挙します。</p>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_nativeFieldMatch">nativeFieldMatch</h5>
<div class="paragraph">
<p><code>nativeFieldMatch</code> は、
トークナイズされるフィールド (<code>indexing: index</code>) を対象に、
検索クエリとフィールドのマッチ具合を計算するヒューリスティック手法です (
<a href="http://docs.vespa.ai/documentation/reference/nativerank.html#nativeFieldMatch">数式</a>
)。</p>
</div>
<div class="paragraph">
<p><code>nativeFieldMatch</code> は以下の2つのポイントでスコアが決まります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>検索ワードがフィールド上でどれだけ先頭に出現したか (<code>firstOccBoost</code>)</p>
</li>
<li>
<p>検索ワードがフィールド上でどれだけ多く出現したか (<code>numOccBoost</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>最終スコアはこれら2つのスコアの加重平均を <code>0.0-1.0</code> に正規化した値となります。
デフォルトでは2つのスコアは単純に同じ比重 (<code>0.5</code>) で結合されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>rank-properties {
    nativeFieldMatch.firstOccurrenceImportance: 0.5
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、<code>nativeFieldMatch</code> も <code>nativeRank</code> と同じように、引数にフィールド名を指定できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa ではスコア計算時に各単語 (<code>term</code>) 自体の重みも考慮されます。
単語の重みには以下の2種類の重みが存在しまう。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">種類</th>
<th class="tableblock halign-center valign-top">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">significance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">インデックス全体での単語の文書頻度の基づく重み。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">weight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クエリで付与された重みで、<code>query=title:入門!150</code> の <code>150</code> のこと。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>significance</code> は
<a href="https://github.com/vespa-engine/vespa/blob/master/searchlib/src/vespa/searchlib/features/documenttestutils.cpp#L78-L89">このコード</a>
のように、
<code>min_df=0.0000001</code> を最小文書頻度として <code>significance=0.5 + 0.5 * log(df)/log(min_df)</code> のように計算されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_nativeProximity">nativeProximity</h5>
<div class="paragraph">
<p><code>nativeProximity</code> は、
トークナイズされるフィールド (<code>indexing: index</code>) を対象に、
検索クエリでの単語群がどの程度隣接して出現するかを計算するヒューリスティック手法です (
<a href="http://docs.vespa.ai/documentation/reference/nativerank.html#nativeProximity">数式</a>
)。</p>
</div>
<div class="paragraph">
<p><code>nativeProximity</code> では以下の2つのポイントでスコアが決まります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>検索ワードのセットがフィールド上で順方向にどれだけ隣接していたか</p>
</li>
<li>
<p>検索ワードのセットがフィールド上で逆方向にどれだけ隣接していたか</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>基本的に順方向で隣接していた方がスコアが高くなるように設計されています。
最終スコアは2つのスコアの加重平均を <code>0.0-1.0</code> に正規化した値となります。
デフォルトでは2つのスコアは単純に同じ比重 (<code>0.5</code>) で結合されます。</p>
</div>
<div class="paragraph">
<p>また、検索クエリの単語群のうち、どこまでの範囲のペアを評価対象にするか
(<code>window</code> 幅、 <code>slidingWindowSize</code>)
も <code>rank-properties</code> で指定ができます。
デフォルトは <code>4</code> で、例えば <code>a b c d e</code> という5単語場合、<code>window</code> 幅が <code>4</code> を超える <code>a e</code> のペアは評価対象外となります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>rank-properties {
    nativeProximity.proximityImportance: 0.5
    nativeProximity.slidingWindowSize: 4
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>なお、<code>nativeProximity</code> も <code>nativeRank</code> と同じように、引数にフィールド名を指定できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>単語ペアの重みは前述の <code>significance</code> および <code>weight</code> 以外に、
2つのペアの接続性 (<code>connectedness</code>) が考慮されます。
<code>connectedness</code> はデフォルトは全て <code>0.1</code> で固定となっており、
値を変更した場合は Vespa 用のプラグインを作って検索リクエストの変換処理で変更する、といった手順が必要です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_nativeAttributeMatch">nativeAttributeMatch</h5>
<div class="paragraph">
<p><code>nativeAttributeMatch</code> は
トークナイズされないフィールド (<code>indexing: attribute</code>) を対象に、
検索クエリとフィールドのマッチ具合を計算するヒューリスティック手法です (
<a href="http://docs.vespa.ai/documentation/reference/nativerank.html#nativeAttributeMatch">数式</a>
)。</p>
</div>
<div class="paragraph">
<p><code>nativeAttributeMatch</code> のスコア計算では、単純に対象の単語のフィールドでの出現数がスコアに影響します。
出現数の算出方法は、対象フィールドのタイプによって以下のように変化します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>weightedset : マッチした単語の重みの合計値</p>
</li>
<li>
<p>array : マッチした単語の数</p>
</li>
<li>
<p>single : マッチした単語の数 (つまり、<code>0</code> か <code>1</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>最終的なスコアは単語に重みを元に <code>0.0-1.0</code> に正規化されます。</p>
</div>
<div class="paragraph">
<p>なお、<code>nativeAttributeMatch</code> も <code>nativeRank</code> と同じように、引数にフィールド名を指定できます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>nativeAttributeMatch</code> では出現数は <code>0-255</code> の範囲を取ることを想定しており、
そのため数回程度の出現回数ではスコアが非常に小さくなりがち (<code>0.1</code> 未満) なので注意。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_attribute">attribute</h5>
<div class="paragraph">
<p><code>attribute</code> は
フィールド値を参照するときに利用する素性です。
名前のように、<code>attribute</code> で指定できるフィールドは <code>indexing: attribute</code> と指定されたものに限定されます。</p>
</div>
<div class="paragraph">
<p><code>attribute</code> ではフィールドの型によって以下のような呼び出し方ができます。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">素性</th>
<th class="tableblock halign-center valign-top">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code> フィールドの値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute(name, n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>array</code> なフィールドの <code>n</code> 番目の値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute(name, key).weight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>weightedset</code> なフィールドの <code>key</code> に対応する重み。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute(name, key).contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>weightedset</code> なフィールドが <code>key</code> を含む場合は <code>1</code>、それ以外は <code>0</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attribute(name).count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>array</code> 及び <code>weightedset</code> なフィールドの要素数。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>attribute(name)</code> は対応するフィールドの値がドキュメントで設定されていない場合は <code>NaN</code> を返します。
そのため、スコア計算で利用するときは <strong>対象のフィールドの値がどのドキュメントにも必ず存在する</strong> ように注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_fieldMatch">fieldMatch</h5>
<div class="paragraph">
<p><code>fieldMatch</code> は
一つのトークナイズされたフィールド (<code>indexing: index</code>) を対象に、
<a href="http://docs.vespa.ai/documentation/reference/string-segment-match.html">segment match</a>
と呼ばれるマッチング手法によって、クエリとフィールドのマッチ具合を評価する素性です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>fieldMatch</code> は <code>fieldMatch(title)</code> のように必ず一つのフィールドを指定する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>segment match</code> では、
<a href="http://docs.vespa.ai/documentation/img/reference/relevance/segment-example.png">公式ドキュメントの図</a>
のようにフィールド全体から検索クエリの単語群が最も密に集まったところ (セグメント) を探索します。</p>
</div>
<div class="paragraph">
<p><code>fieldMatch</code> では以下のような要素がスコア計算に加味されます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>各セグメントがどれだけ隣接しているか</p>
</li>
<li>
<p>同一セグメント内でどれだけ単語が密に集まっているか</p>
</li>
<li>
<p>選択されたセグメントの中での単語の出現順がクエリでの順番と揃っているか</p>
</li>
<li>
<p>フィールド全体で検索クエリの単語がどれだけ多く出現したか</p>
</li>
<li>
<p>検索クエリの単語がフィールド全体の何割をカバーしたか</p>
</li>
<li>
<p>検索クエリの単語のうち何割がフィールドに出現したか</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、<code>fieldMatch</code> では評価の過程で計算された以下のような中間データも参照できます
(以下は一部の例で、これ以外にもあります)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">素性</th>
<th class="tableblock halign-center valign-top">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fieldMatch</code> の最終スコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).proximity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">セグメント内での単語の隣接度合いのスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).completeness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索単語のクエリ及びフィールドのカバー率のスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).orderness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリと実際のフィールド上での出現順のスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).relatedness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリがどれだけ同一のセグメントに出現したかのスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).earliness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリがどれだけ先頭の方に出現したかのスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).segmentProximity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">異なるセグメントがどれだけ隣接しているかのスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).occurrence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索クエリの単語の出現数に基づくスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).weight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の <code>weight</code> の総和。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).significance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の <code>significance</code> の総和。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldMatch(name).matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の出現数 (種類数かも)。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>fieldMatch</code> はその動作を制御する様々なパラメタも定義されています。
詳しくは
<a href="http://docs.vespa.ai/documentation/reference/rank-feature-configuration.html">Rank feature configuration</a>
を参照してください。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>segment match</code> でのセグメント分けはヒューリスティックな方法によって実行されており、
必ずしも最適解になるわけではないです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>fieldMatch</code> の処理は相対的に複雑で、<code>nativeRank</code> などに比べると計算コストが大きいため、
特に <code>first-phase</code> で使用するときは注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_attributeMatch">attributeMatch</h5>
<div class="paragraph">
<p><code>attributeMatch</code>
は一つのトークナイズされていないフィールド (<code>indexing: attribute</code>) を対象に、
検索クエリの単語とフィールドの値がどれだけ一致したかを評価する素性です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>attributeMatch</code> も <code>attributeMatch(genres)</code> のように必ず一つのフィールドを指定する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>attributeMatch</code> は <code>fieldMatch</code> と名称が似ていますが、
こちらは単純にマッチした単語の全体に対するカバー率のみがスコア計算に加味されます。
また、<code>attributeMatch</code> では以下のような中間データも参照できます
(以下は一部の例で、これ以外にもあります)。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">素性</th>
<th class="tableblock halign-center valign-top">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>attributeMatch</code> の最終スコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).completeness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索単語のクエリおよびフィールドのカバー率のスコア。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).weight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の <code>weight</code> の総和。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).significance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の <code>significance</code> の総和。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィールド中に出現した検索単語の出現数 (種類数かも)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).totalWeight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>weightedset</code> でマッチした値の重みの合計。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attributeMatch(name).averageWeight</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>weightedset</code> でマッチした値の重みの平均。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_query">query</h5>
<div class="paragraph">
<p><code>query</code>
は検索クエリから動的に値を指定するときに使用する素性です。
<code>query</code> を利用する場合は、<code>rank-properties</code> に指定がない場合のデフォルト値を一緒に定義します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>rank-properties {
    query(gender): male
    query(age) : 30
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>検索クエリからは、以下の例のように
<a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html#ranking.features">ranking.features.featurename [rankfeature.featurename]</a>
というパラメタで指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search?language=ja&amp;query=foo&amp;rankfeature.query(gender)=female&amp;rankfeature.query(age)=25</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ranking_expression_feature_dotProduct">dotProduct</h5>
<div class="paragraph">
<p><code>dotProduct</code>
は <code>weightedest</code> なフィールドと内積を計算するときに利用する素性です。
<code>dotProduct</code> は以下のように第1引数に対象のフィールドを、第2引数に検索クエリから与えるベクトルの名称を指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>dotProduct(reviews, prefer) <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>weightedset</code> な <code>reviews</code> フィールドに対して適用</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>prefer</code> というベクトルとの内積を計算</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>検索クエリでは以下のように
<a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html#ranking.properties">ranking.properties.propertyname [rankproperty.propertyname]</a>
というパラメタで指定します。値のベクトルは <code>json</code> 形式で指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search?language=ja&amp;query=入門&amp;rankproperty.dotProduct.prefer={quality:0.2, readability:0.5, cost:0.3}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>似たような素性として <code>nativeDotProduct</code> というものがあります。
こちらは引数として対象のフィールドのみをとり、
内積計算のクエリ側の重みには <code>query</code> パラメタで指定された単語毎の重み (<code>foo!50</code> の <code>50</code>) が利用されます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>rankproperty.dotProduct.NAME=JSON</code> で指定する <code>JSON</code> は、
一般的な <code>json</code> 形式と異なりkeyをダブルクオートでくくらないでそのまま記述します。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ranking_search">5.4. ランキングと検索</h3>
<div class="paragraph">
<p>Vespaでは検索クエリの
<a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html#ranking.profile">ranking.profile [ranking]</a>
というオプションを用いて、実際に適用する <code>rank-profile</code> を指定します。
実際にチュートリアルデータを用いてその動作について見ていきます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespaではデフォルトで利用できる <code>ranking</code> として <code>default</code> と <code>unrank</code> の2つがあります。
<code>default</code> は <code>first-phase</code> に <code>nativeRank</code> を用いるランキングで、<code>ranking</code> の指定がない場合のデフォルト値です。
<code>unrank</code> は明示的にスコア計算をしないときに指定するプロファイルです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#config_deploy">Vespaへのデプロイ</a>
で説明した手順に従って新しい設定をVespaにデプロイします。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>事前に
<a href="#setup_tutorial">チュートリアル環境の構築</a>
の手順に従ってVespaを起動して、
<a href="#update_document_sample">サンプルデータの登録</a>
まで完了している必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose exec vespa1 /bin/bash <i class="conum" data-value="1"></i><b>(1)</b>

[root@vespa1 /]# vespa-deploy prepare /vespa-sample-apps/config/ranking/ <i class="conum" data-value="2"></i><b>(2)</b>
Uploading application '/vespa-sample-apps/config/ranking/' using http://vespa1:19071/application/v2/tenant/default/session?name=ranking
Session 3 for tenant 'default' created.
Preparing session 3 using http://vespa1:19071/application/v2/tenant/default/session/3/prepared
Session 3 for tenant 'default' prepared.

[root@vespa1 /]# vespa-deploy activate <i class="conum" data-value="3"></i><b>(3)</b>
Activating session 3 using http://vespa1:19071/application/v2/tenant/default/session/3/active
Session 3 for tenant 'default' activated.
Checksum:   5d15aa7ef48459f19057915f1f8096dc
Timestamp:  1519187200940
Generation: 3</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa1</code> のdockerコンテナにログイン</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/vespa-sample-apps/config/ranking/</code> をVespaにアップロード</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>最新の設定をVespaに反映</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ranking_search_model">5.4.1. チュートリアルのモデル</h4>
<div class="paragraph">
<p>ランキングを含む Vespa の設定は
<code>sample-apps/config/ranking</code> に配置されています。
<code>serchdefinitions/book.sd</code> では以下のような3つのプロファイルが定義されています。</p>
</div>
<div class="sect4">
<h5 id="ranking_search_model_basic">basic</h5>
<div class="paragraph">
<p>継承の例のために切り出した基底の <code>rank-profile</code> で、後述の <code>price_boost</code> のベースとなっています。
中身は <code>default</code> と同じで、<code>first-phase</code> に <code>nativeRank</code> を指定しただけです。</p>
</div>
</div>
<div class="sect4">
<h5 id="ranking_search_model_priceboost">price_boost</h5>
<div class="paragraph">
<p><code>first-phase</code> で得られた結果のうち、上位3位の結果を <code>price</code> の値でブーストしてリランキングする <code>rank-profile</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile price_boost inherits basic {

        rank-properties {
            query(bias) : 0.1
        }

        macro price_boost() {
            expression: file:price_boost.expression
        }

        macro boosted_score(bias) {
            expression {
                (1.0 - bias) * firstPhase
                + bias * price_boost
            }
        }

        second-phase {
            expression: boosted_score(query(bias))
            rerank-count: 3
        }

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>price-boost</code> では、<code>boosted_score(bias)</code> マクロの中で
<code>first-phase</code> のスコア (<code>firstPhase</code>) と価格ブースト値の <code>bias</code> に基づく加重平均を計算しています。
<code>bias</code> の値は <code>query</code> 素性として検索時に変更できるようにしています。
価格ブースト値は <code>price_boost()</code> マクロで定義されており、実際の定義は以下のように外部ファイルに記載されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cat sample-apps/config/ranking/searchdefinitions/price_boost.expression
1.0 - tanh(log10(attribute(price)/1000))</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>price_boost.expression</code> で書かれている数式は、グラフにすると以下のような形になります。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_example_price_boost.jpg" alt="vespa example price boost" width="500">
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_search_model_reviewsprefer">reviews_prefer</h5>
<div class="paragraph">
<p>ユーザの嗜好とドキュメントのレビュースコアの内積値を用いてリランキングをする <code>rank-profile</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    rank-profile reviews_prefer inherits default {

        first-phase {
            expression: dotProduct(reviews, prefer)
        }

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>このプロファイルは、ユーザの嗜好を <code>rankproperty.dotProduct.perfer=JSON</code> として検索時に与えることを想定しており、
簡単なパーソナライズのような例となっています。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ranking_search_compare">5.4.2. 検索結果の比較</h4>
<div class="paragraph">
<p>まず、ベース設定 (<code>ranking=basic</code>) で検索をした場合、検索結果の上位3件は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">s</span><span class="error">e</span><span class="error">a</span><span class="error">r</span><span class="error">c</span><span class="error">h</span><span class="error">/</span><span class="error">?</span><span class="error">l</span><span class="error">a</span><span class="error">n</span><span class="error">g</span><span class="error">u</span><span class="error">a</span><span class="error">g</span><span class="error">e</span><span class="error">=</span><span class="error">j</span><span class="error">a</span><span class="error">&amp;</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span><span class="error">=</span><span class="error">入</span><span class="error">門</span><span class="error">&amp;</span><span class="error">c</span><span class="error">o</span><span class="error">u</span><span class="error">n</span><span class="error">t</span><span class="error">=</span><span class="integer">3</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">=</span><span class="error">b</span><span class="error">a</span><span class="error">s</span><span class="error">i</span><span class="error">c</span>

{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">toplevel</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">totalCount</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">documents</span><span class="delimiter">&quot;</span></span>: <span class="integer">13</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">full</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">nodes</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">results</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">resultsFull</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.07987290045947507</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python本格入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">今話題のPythonの使い方をわかりやすく説明します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">450</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">70</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.07984115307035042</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ゼロから始めるVespa入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">話題のOSS検索エンジン、Vespaの使い方を初心者にもわかりやすく解説します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Vespa</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">40</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.06998285745781</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">サルでも分かるJava言語</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Java超初心者におすすめのJava言語の入門書です</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">150</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Java</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">30</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>
        }
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これを <code>price_boost</code> をランキングに指定して検索すると、以下のように価格の安いものが上位にくるように検索結果が変化します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">s</span><span class="error">e</span><span class="error">a</span><span class="error">r</span><span class="error">c</span><span class="error">h</span><span class="error">/</span><span class="error">?</span><span class="error">l</span><span class="error">a</span><span class="error">n</span><span class="error">g</span><span class="error">u</span><span class="error">a</span><span class="error">g</span><span class="error">e</span><span class="error">=</span><span class="error">j</span><span class="error">a</span><span class="error">&amp;</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span><span class="error">=</span><span class="error">入</span><span class="error">門</span><span class="error">&amp;</span><span class="error">c</span><span class="error">o</span><span class="error">u</span><span class="error">n</span><span class="error">t</span><span class="error">=</span><span class="integer">3</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">=</span><span class="error">p</span><span class="error">r</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">_</span><span class="error">b</span><span class="error">o</span><span class="error">o</span><span class="error">s</span><span class="error">t</span>

{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">toplevel</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">totalCount</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">documents</span><span class="delimiter">&quot;</span></span>: <span class="integer">13</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">full</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">nodes</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">results</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">resultsFull</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.162984571712029</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">サルでも分かるJava言語</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Java超初心者におすすめのJava言語の入門書です</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">150</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Java</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">30</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.1544276910372906</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ゼロから始めるVespa入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">話題のOSS検索エンジン、Vespaの使い方を初心者にもわかりやすく解説します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Vespa</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">40</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="float">0.14266011876532916</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python本格入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">今話題のPythonの使い方をわかりやすく説明します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">450</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">70</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>
        }
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>1件目のスコア (<code>relevance</code>) は <code>0.162984571712029</code> となっていますが、
これは以下のように定義した式で計算した結果になっていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>price_boost() = 1.0 - tanh(log10(1000/1000))
              = 1.0
query(bias) = 0.1 (default)
boosted_score(query(bias)) = boosted_score(0.1)
                           = (1.0 - 0.1) * 0.06998285745781 + 0.1 * 1.0
                           = 0.162984571712029</code></pre>
</div>
</div>
<div class="paragraph">
<p>例えば、以下のクエリのように <code>query(bias) = 0.0</code> とすると、価格ブーストの値が無視され、
初めの結果と同じになることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">s</span><span class="error">e</span><span class="error">a</span><span class="error">r</span><span class="error">c</span><span class="error">h</span><span class="error">/</span><span class="error">?</span><span class="error">l</span><span class="error">a</span><span class="error">n</span><span class="error">g</span><span class="error">u</span><span class="error">a</span><span class="error">g</span><span class="error">e</span><span class="error">=</span><span class="error">j</span><span class="error">a</span><span class="error">&amp;</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span><span class="error">=</span><span class="error">入</span><span class="error">門</span><span class="error">&amp;</span><span class="error">c</span><span class="error">o</span><span class="error">u</span><span class="error">n</span><span class="error">t</span><span class="error">=</span><span class="integer">3</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">=</span><span class="error">p</span><span class="error">r</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">_</span><span class="error">b</span><span class="error">o</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">f</span><span class="error">e</span><span class="error">a</span><span class="error">t</span><span class="error">u</span><span class="error">r</span><span class="error">e</span><span class="error">.</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span><span class="error">(</span><span class="error">b</span><span class="error">i</span><span class="error">a</span><span class="error">s</span><span class="error">)</span><span class="error">=</span><span class="float">0.0</span>

<span class="error">(</span><span class="error">`</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">=</span><span class="error">b</span><span class="error">a</span><span class="error">s</span><span class="error">i</span><span class="error">c</span><span class="error">`</span> <span class="error">の</span><span class="error">場</span><span class="error">合</span><span class="error">と</span><span class="error">同</span><span class="error">じ</span><span class="error">検</span><span class="error">索</span><span class="error">結</span><span class="error">果</span><span class="error">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、以下のようにユーザの嗜好を <code>{quality:0.2, readability:0.5, cost:0.3}</code> として、
<code>reviews_prefer</code> で検索すると以下のような結果が得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">s</span><span class="error">e</span><span class="error">a</span><span class="error">r</span><span class="error">c</span><span class="error">h</span><span class="error">/</span><span class="error">?</span><span class="error">l</span><span class="error">a</span><span class="error">n</span><span class="error">g</span><span class="error">u</span><span class="error">a</span><span class="error">g</span><span class="error">e</span><span class="error">=</span><span class="error">j</span><span class="error">a</span><span class="error">&amp;</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span><span class="error">=</span><span class="error">入</span><span class="error">門</span><span class="error">&amp;</span><span class="error">c</span><span class="error">o</span><span class="error">u</span><span class="error">n</span><span class="error">t</span><span class="error">=</span><span class="integer">3</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">=</span><span class="error">r</span><span class="error">e</span><span class="error">v</span><span class="error">i</span><span class="error">e</span><span class="error">w</span><span class="error">s</span><span class="error">_</span><span class="error">p</span><span class="error">r</span><span class="error">e</span><span class="error">f</span><span class="error">e</span><span class="error">r</span><span class="error">&amp;</span><span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">p</span><span class="error">r</span><span class="error">o</span><span class="error">p</span><span class="error">e</span><span class="error">r</span><span class="error">t</span><span class="error">y</span><span class="error">.</span><span class="error">d</span><span class="error">o</span><span class="error">t</span><span class="error">P</span><span class="error">r</span><span class="error">o</span><span class="error">d</span><span class="error">u</span><span class="error">c</span><span class="error">t</span><span class="error">.</span><span class="error">p</span><span class="error">r</span><span class="error">e</span><span class="error">f</span><span class="error">e</span><span class="error">r</span><span class="error">=</span>{<span class="error">q</span><span class="error">u</span><span class="error">a</span><span class="error">l</span><span class="error">i</span><span class="error">t</span><span class="error">y</span>:<span class="float">0.2</span>, <span class="error">r</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">a</span><span class="error">b</span><span class="error">i</span><span class="error">l</span><span class="error">i</span><span class="error">t</span><span class="error">y</span>:<span class="float">0.5</span>, <span class="error">c</span><span class="error">o</span><span class="error">s</span><span class="error">t</span>:<span class="float">0.3</span>}

{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">toplevel</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">totalCount</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">documents</span><span class="delimiter">&quot;</span></span>: <span class="integer">13</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">full</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">nodes</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">results</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">resultsFull</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">78</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">サルでも分かるJava言語</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Java超初心者におすすめのJava言語の入門書です</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">150</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Java</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">30</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::java_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">77</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ゼロから始めるVespa入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">話題のOSS検索エンジン、Vespaの使い方を初心者にもわかりやすく解説します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">1500</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">検索エンジン</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Vespa</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">90</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">40</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::vespa_intro</span><span class="delimiter">&quot;</span></span>
        }
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">relevance</span><span class="delimiter">&quot;</span></span>: <span class="integer">71</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">fields</span><span class="delimiter">&quot;</span></span>: {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">sddocname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Python本格入門</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">今話題のPythonの使い方をわかりやすく説明します</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="integer">2000</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>: <span class="integer">450</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>: [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">コンピュータ</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">プログラミング</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">reviews</span><span class="delimiter">&quot;</span></span>: [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">readability</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">80</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cost</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">70</span>
            },
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quality</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">weight</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>
            }
          ],
          <span class="key"><span class="delimiter">&quot;</span><span class="content">documentid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id:book:book::python_intro</span><span class="delimiter">&quot;</span></span>
        }
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例の場合、トップのドキュメントのスコア (<code>relevance</code>) は以下のように <code>reviews</code> の内積となっていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>dotProduct(reivews, prefer) = {quality: 30, readability: 90, cost: 90}
                              * {quality:0.2, readability:0.5, cost:0.3}
                            = 30 * 0.2 + 90 * 0.5 + 90 * 0.3
                            = 6 + 45 + 27
                            = 78</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ranking_other">5.5. その他のトピック</h3>
<div class="sect3">
<h4 id="ranking_other_dump">5.5.1. 素性値のダンプ</h4>
<div class="paragraph">
<p>検索の精度改善を行う場合、
実際にユーザから得られたフィードバック (ex. クリック) と検索結果に表示されたドキュメントの情報を組み合わせて訓練データを作り、
そこから機械学習を用いて新しいランキングモデルを学習する、
といったサイクルを回すのが一般的です。
このとき、検索結果のドキュメントについて、モデルで利用する素性が実際にどのような値であったかをログに残す必要があります。</p>
</div>
<div class="paragraph">
<p>Vespa では、検索結果のレスポンスに素性の計算結果を付与する機能として
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#rankfeatures">rank-features</a>
と
<a href="http://docs.vespa.ai/documentation/reference/search-definitions-reference.html#summaryfeatures">summary-features</a>
という2つが提供されています。</p>
</div>
<div class="sect4">
<h5 id="ranking_other_dump_rankfeatures">rank-features</h5>
<div class="paragraph">
<p><code>rank-features</code> は素性のフルダンプを行う時に利用する機能です。検索クエリに以下のように
<a href="http://docs.vespa.ai/documentation/reference/search-api-reference.html#ranking.listFeatures">ranking.listFeatures [rankfeatures]</a>
を指定すると有効になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>search/?language=ja&amp;query=入門&amp;count=3&amp;ranking=price_boost&amp;rankfeatures=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記クエリで検索をすると、レスポンスの各ドキュメントに <code>rankfeatures</code> という要素が新たに追加され、
そこに Vespa で利用可能な全ての素性のダンプ情報が出力されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">          <span class="key"><span class="delimiter">&quot;</span><span class="content">rankfeatures</span><span class="delimiter">&quot;</span></span>: {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres)</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres).averageWeight</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres).completeness</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres).fieldCompleteness</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres).importance</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">attributeMatch(genres).matches</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="error">.</span><span class="error">.</span><span class="error">.</span>
          }</code></pre>
</div>
</div>
<div class="paragraph">
<p>マクロ定義のような自分で定義した素性を追加で出力したい場合は、
以下のように <code>rank-profile</code> に <code>rank-features</code> という項目で出力したい素性の名前を列挙します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        rank-features {
            rankingExpression(price_boost)
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のように定義すると、<code>rankfeatures</code> の出力に上記の項目が追加されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">          <span class="key"><span class="delimiter">&quot;</span><span class="content">rankfeatures</span><span class="delimiter">&quot;</span></span>: {
            <span class="error">.</span><span class="error">.</span><span class="error">.</span>
            <span class="error">r</span><span class="error">a</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">n</span><span class="error">g</span><span class="error">E</span><span class="error">x</span><span class="error">p</span><span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">(</span><span class="error">p</span><span class="error">r</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">_</span><span class="error">b</span><span class="error">o</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">)</span><span class="string"><span class="delimiter">&quot;</span><span class="content">: 1,
            ...
          }</span></span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>rank-features</code> や後述の <code>summary-features</code> でマクロ定義を指定したい場合は、
上記例のように <code>rankingExpression</code> でマクロをくくる必要があります。</p>
</div>
<div class="paragraph">
<p>また、引数付きマクロについては指定できないようで、
もし実際に検索で使った値をダンプしたい場合は引数なしマクロでくくるなどの工夫が必要です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>rank-features</code> では動的に決まる <code>query</code> 素性が反映されないように見えます。
後述の <code>summary-features</code> だと <code>query</code> 素性は出力されます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>rank-features</code> は上記の通り全ての可能な素性を計算してダンプするため、計算コストが非常に大きくレイテンシが悪化します。
そのため、<span class="red"><strong>サービスインしているような環境ではrank-featuresは使用しないでください。</strong></span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="ranking_other_dump_summaryfeatures">summary-features</h5>
<div class="paragraph">
<p><code>summary-features</code> は <code>rank-features</code> と同じようにレスポンスに素性の値を付与する機能ですが、
こちらは指定された素性のみをレスポンスに付与する機能となります。</p>
</div>
<div class="paragraph">
<p><code>summary-features</code> は <code>rank-profile</code> に <code>summaryfeatures</code> という要素を追加することで有効になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        summary-features {
            nativeRank
            query(bias)
            rankingExpression(price_boost)
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>summaryfeatures</code> が定義された <code>rank-profile</code> を指定して検索を行うと、
以下のような項目がレスポンスに追加されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>          "summaryfeatures": {
            "nativeRank": 0.06998285745781,
            "query(bias)": 0.1,
            "rankingExpression(price_boost)": 1,
            "vespa.summaryFeatures.cached": 0
          },</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ranking_other_tensor">5.5.2. テンソルを用いたスコア計算</h4>
<div class="paragraph">
<p>Vespa ではスコア計算の方法の一つとしてテンソル (ex. 行列) を用いた演算をサポートしています。
テンソル演算はより複雑なランキングモデルを用いるときに必要となる概念で、
代表的なユースケースとして
<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%83%A9%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0">ディープラーニング</a>
を用いたモデルがあげられます。
ここでは Vespa でのテンソル機能の概要について紹介します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>テンソルに関するドキュメントとして以下があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/tensor-intro.html">Introduction to working with tensors in Vespa</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/tensor-user-guide.html">Tensor User Guide</a></p>
</li>
<li>
<p><a href="http://docs.vespa.ai/documentation/reference/tensor.html">Tensor Evaluation Reference</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vespa では、テンソルは以下のようなフォーマットで表現します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{ {x:0, y:0}:5.0, {x:1, y:1}:7.0 }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>x</code> と <code>y</code> はテンソルの次元を表す識別子で、上の例は具体的には以下のような行列を表現しています。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_tensor_example.jpg" alt="vespa tensor example" width="300">
</div>
</div>
<div class="paragraph">
<p>フィールド型としてテンソルを定義するときは、この次元の識別子を用いて以下のように定義します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>field sparse_tensor type tensor(x{}, y{}) {  <i class="conum" data-value="1"></i><b>(1)</b>
    indexing: attribute | summary
    attribute: tensor(x{}, y{})
}

field dense_tensor type tensor(x[], y[]) { <i class="conum" data-value="2"></i><b>(2)</b>
    indexing: attribute | summary
    attribute: tensor(x[], y[])
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>疎行列としてテンソルを定義</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>密行列としてテンソルを定義</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>次元の識別子は任意の名前を使用できます。
そのため、例えば <code>input</code>、<code>hidden</code>、<code>output</code> のようにレイヤーにあわせた名称を付けることで、
各次元の役割を明確にすることが可能です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vespa のテンソル演算は大きくわけて以下の5つの基本操作によって構成されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/tensor.html">公式ドキュメント</a>
では基本操作として <code>rename</code> もありますが、これは次元の識別子の変更だけで、
<code>relu</code> といった拡張操作から参照されないため除外しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="ranking_other_tensor_map">map</h5>
<div class="paragraph">
<p><code>map</code> は <code>map(tensor, f(x)(expr))</code> のように2つの引数をとり、
第1引数で与えられたテンソルの各要素に対して、第2引数のラムダ式で与えられた操作を適用する、という動作をします。</p>
</div>
<div class="paragraph">
<p>例えば、行列の各要素を2倍するような操作は <code>map</code> を用いて以下のように記述します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>t = {{x:0,y:0}: 3.0, {x:0,y:1}: 4.0, {x:1,y:0}: 5.0, {x:1,y:1}: 6.0}

map(t, f(x)(x * 2)) = {{x:0,y:0}: 6.0, {x:0,y:1}: 8.0, {x:1,y:0}: 10.0, {x:1,y:1}: 12.0}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ranking_other_tensor_reduce">reduce</h5>
<div class="paragraph">
<p><code>reduce</code> は <code>reduce(tensor, aggregator, dim1, dim2, &#8230;&#8203;)</code> のような引数をとり、
第1引数で与えられたテンソルについて、第2引数で与えられた <code>aggregator</code> を第3引数以降で与えられた成分方向に対して適用する、
という動作をします (第3引数以降がない場合は全要素に対して適用)。</p>
</div>
<div class="paragraph">
<p>例えば、先程の <code>x</code> と <code>y</code> の2つの次元を持つ行列に対して、 <code>x</code> 方向に総和を取ったベクトルを得る場合、
以下のような式となります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>t = {{x:0,y:0}: 3.0, {x:0,y:1}: 4.0, {x:1,y:0}: 5.0, {x:1,y:1}: 6.0}

reduce(t, sum, x) = {{y:0}: 8.0, {y:1}: 10.0}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ranking_other_tensor_join">join</h5>
<div class="paragraph">
<p><code>join</code> は <code>join(tensor1, tensor2, f(x,y)(expr))</code> のように3つの引数を取り、
第1引数と第2引数で与えられた2つのテンソルを、第3引数のラムダ式に基いて結合する、という動作をします。</p>
</div>
<div class="paragraph">
<p>例えば、同一次元数の2つの行列に対して <code>join(matrix1, matrix2, f(x,y)(x * y))</code> とすると、
これは
<a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%80%E3%83%9E%E3%83%BC%E3%83%AB%E7%A9%8D">アダマール積</a>
を計算することを意味します。</p>
</div>
<div class="paragraph">
<p><code>reduce</code> は2つのテンソルがベクトルと行列のように次元数が異なる場合でも動作します。
例えばベクトルと行列に対して <code>join</code> を適用すると、
以下の例のようにベクトル側の不足している次元がワイルドカードとして扱われたような動作をします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>t1 = {{x:0}: 1.0, {x:1}: 2.0}
t2 = {{x:0,y:0}: 3.0, {x:0,y:1}: 4.0, {x:1,y:0}: 5.0, {x:1,y:1}: 6.0}

join(t1, t2, f(x,y)(x * y)) = {{x:0,y:0}: 3.0, {x:0,y:1}: 4.0, {x:1,y:0}: 10.0, {x:1,y:1}: 12.0}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ranking_other_tensor_tensor">tensor</h5>
<div class="paragraph">
<p><code>tensor</code> は <code>tensor(tensor-type-spec)(expr)</code> のような形式で利用され、
<code>tensor-type-spec</code> で指定された型のテンソルを、<code>expr</code> で指定された式に基いて初期化した新しいテンソルを生成する、という動作をします。</p>
</div>
<div class="paragraph">
<p><code>expr</code> は具体的には各次元のインデックス番号を引数とした式を記述し、例えば以下のような使い方をします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>tensor(x[3])(x) = {{x:0}: 0.0, {x:1}: 1.0, {x:2}: 2.0}
tensor(x[2],y[2])(x == y) = {{x:0,y:0}: 1.0, {x:0,y:1}: 0.0, {x:1,y:0}: 0.0, {x:1,y:1}: 1.0}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ranking_other_tensor_concat">concat</h5>
<div class="paragraph">
<p><code>concat</code> は <code>concat(tensor1, tensor2, dim)</code> のように3つの引数を取り、
第1引数と第2引数で与えられた2つのテンソルを、第3引数の次元方向に結合する、という動作をします。</p>
</div>
<div class="paragraph">
<p>イメージとしては第3引数の次元方向に2つのテンソルを並べる感じで、例えばベクトル同士の場合は以下のような結果となります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>t1 = {{x:0}: 0.0, {x:1}: 1.0}
t2 = {{x:0}: 2.0, {x:1}: 3.0}

concat(t1,t2,x) = {{x:0}: 0.0, {x:1}: 1.0}, {x:2}: 2.0, {x:3}: 3.0}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<br></p>
</div>
<div class="paragraph">
<p>Vespa ではこれら基本操作に加え、<code>sum</code>、<code>relu</code>、<code>sigmoid</code>、<code>softmax</code> といった典型的な演算が拡張操作として定義されています。
拡張操作の詳細は
<a href="http://docs.vespa.ai/documentation/reference/tensor.html">Tensor Evaluation Reference</a>
を参照してください (これら拡張操作は全て前述の基本操作を組み合わせで表現できます)。</p>
</div>
<div class="paragraph">
<p>実際の例として、以下のような単純な3層ニューラルネットワークを考えてみます。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_nn_example.jpg" alt="vespa nn example" width="700">
</div>
</div>
<div class="paragraph">
<p>Vespa の拡張操作も組み合わせると、上記ニューラルネットワークの計算は以下のような雰囲気のランク式で記述できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>macro h() {
    expression: relu( sum(x * constant(W_ih), input) + constant(b_ih) )
}

macro y() {
    expression: sigmoid( sum(h * constant(W_ho), hidden) + constant(b_ho) )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように、Vespa ではニューラルネットワークを用いたランク式も非常に直感的に記述できます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記ランク式では <code>constant</code> などここでは説明していない要素が含まれており、
また <code>W_ih</code> といった定数値の宣言が省略されています。
そのため、ここでは <em>"以下のような雰囲気のランク式"</em> とお茶を濁した言い回しとしています。</p>
</div>
<div class="paragraph">
<p>上記例は、具体的には Vespa の公式チュートリアルを元に記述しています。
実際の完全な設定については、以下の公式チュートリアルを参照してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.vespa.ai/documentation/tutorials/blog-recommendation-nn.html">Vespa tutorial pt. 3: Blog recommendation with Neural Network models</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustering">6. Vespa とクラスタリング</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、複数ノードを用いて Vespa をクラスタリングする方法について見ていきます。</p>
</div>
<div class="sect2">
<h3 id="clustering_setup">6.1. クラスタの構築</h3>
<div class="paragraph">
<p>本チュートリアルでは、実際に3つのノードを用いた Vespa クラスタを構築します。
対応する設定は
<code>sample-apps/config/cluster</code>
にあります。</p>
</div>
<div class="sect3">
<h4 id="clustering_setup_tutorial">6.1.1. チュートリアルでの構成</h4>
<div class="paragraph">
<p>構築する Vespa クラスタの構成を図にすると以下のようになります。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_tutorial_cluster.jpg" alt="vespa tutorial cluster" width="900">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上図は役割軸でコンポーネントをざっくり書いたもので、ブロックと実際のプロセスが対応しているわけではない点に注意してください。</p>
</div>
<div class="paragraph">
<p>なお、実際にどのノードで何のプロセスが起動するかは
<a href="http://docs.vespa.ai/documentation/reference/files-processes-and-ports.html">Files, processes and ports</a>
にまとめられています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vespa クラスタの構築で修正が必要となるのは <code>hosts.xml</code> と <code>services.xml</code> の2つです。</p>
</div>
<div class="sect4">
<h5 id="clustering_setup_tutorial_hosts">hosts.xml</h5>
<div class="paragraph">
<p><code>hosts.xml</code> の具体的な中身は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="tag">&lt;hosts&gt;</span>
  <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vespa1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;alias&gt;</span>node1<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;/host&gt;</span>

  <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vespa2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;alias&gt;</span>node2<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;/host&gt;</span>

  <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vespa3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;alias&gt;</span>node3<span class="tag">&lt;/alias&gt;</span>
  <span class="tag">&lt;/host&gt;</span>
<span class="tag">&lt;/hosts&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa2</code> のホストを追加</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa3</code> のホストを追加</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#config">Vespa の設定</a>
で用いたシングル構成と比べて、指定されているホスト名が増えています。</p>
</div>
</div>
<div class="sect4">
<h5 id="clustering_setup_tutorial_services">services.xml</h5>
<div class="paragraph">
<p><code>services.xml</code> の具体的な中身は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="tag">&lt;services</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;admin</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;adminserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;configservers&gt;</span>
      <span class="tag">&lt;configserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/configservers&gt;</span>
    <span class="tag">&lt;logserver</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;slobroks&gt;</span>
      <span class="tag">&lt;slobrok</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/slobroks&gt;</span>
  <span class="tag">&lt;/admin&gt;</span>

  <span class="tag">&lt;container</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;component</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.co.yahoo.vespa.language.lib.kuromoji.KuromojiLinguistics</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">bundle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kuromoji-linguistics</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;config</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">language.lib.kuromoji.kuromoji</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;mode&gt;</span>search<span class="tag">&lt;/mode&gt;</span>
        <span class="tag">&lt;ignore_case&gt;</span>true<span class="tag">&lt;/ignore_case&gt;</span>
      <span class="tag">&lt;/config&gt;</span>
    <span class="tag">&lt;/component&gt;</span>
    <span class="tag">&lt;document-api</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;document-processing</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;search</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/nodes&gt;</span>
  <span class="tag">&lt;/container&gt;</span>

  <span class="tag">&lt;content</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;redundancy&gt;</span>2<span class="tag">&lt;/redundancy&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;documents&gt;</span>
      <span class="tag">&lt;document</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;document-processing</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/documents&gt;</span>
    <span class="tag">&lt;nodes&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tag">&lt;node</span> <span class="attribute-name">hostalias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">distribution-key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;/nodes&gt;</span>
  <span class="tag">&lt;/content&gt;</span>

<span class="tag">&lt;/services&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ドキュメントの冗長数を <code>2</code> に変更</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa2</code> のホストを追加</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>vespa3</code> のホストを追加</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>こちらもシングル構成に比べて、<code>container</code> と <code>content</code> の <code>nodes</code> セクションの定義が増えていることがわかります。
今回は3つのノードで同じ設定を利用するため、定義の追加はこれだけで OK です。
また、それに加えて、クラスタ設定ではドキュメントの冗長数を <code>1</code> から <code>2</code> に増やしています。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#config_file_services_content">content</a>
で述べたように、<code>content</code> セクションに追加した <code>node</code> は全て異なる <code>distribution-key</code> を設定する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clustering_setup_deploy">6.1.2. クラスタ設定の反映</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>すでにシングル構成での Vespa が起動して、データまで投入されていることを前提としています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>シングル構成では、<code>vespa1</code> のノードに13件のドキュメントが登録されているという状態でした。
チュートリアルで用意している <code>utils/vespa_cluster_status</code> を以下のように実行すると、
<code>vespa1</code> (<code>node=0</code>) に13件のドキュメントがいることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_cluster_status -t storage book
=== status of storage ===

| node | status      | bucket-count | uniq-doc-count | uniq-doc-size |
|------|-------------|--------------|----------------|---------------|
|    0 | up          |           13 |             13 |          9008 |</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>utils/vespa_cluster_status</code> は
<a href="http://docs.vespa.ai/documentation/content/api-state-rest-api.html">State Rest API</a>
を用いて <code>content</code> ノードの状態を確認しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、以下のコマンドでクラスタの設定を Vespa にデプロイします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose exec vespa1 /bin/bash <i class="conum" data-value="1"></i><b>(1)</b>

[root@vespa1 /]# vespa-deploy prepare /vespa-sample-apps/config/cluster/ <i class="conum" data-value="2"></i><b>(2)</b>
Uploading application '/vespa-sample-apps/config/cluster/' using http://vespa1:19071/application/v2/tenant/default/session?name=cluster
Session 4 for tenant 'default' created.
Preparing session 4 using http://vespa1:19071/application/v2/tenant/default/session/4/prepared
WARNING: Host named 'vespa2' may not receive any config since it does not match its canonical hostname: vespa2.vespatutorial_vespa-nw
WARNING: Host named 'vespa3' may not receive any config since it does not match its canonical hostname: vespa3.vespatutorial_vespa-nw
Session 4 for tenant 'default' prepared.

[root@vespa1 /]# vespa-deploy activate <i class="conum" data-value="3"></i><b>(3)</b>
Activating session 4 using http://vespa1:19071/application/v2/tenant/default/session/4/active
Session 4 for tenant 'default' activated.
Checksum:   c170db03dc38f7f53d9b98aa89d782de
Timestamp:  1519282647370
Generation: 4</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa1</code> の Docker コンテナにログイン</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/vespa-sample-apps/config/cluster/</code> を Vespa にアップロード</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>最新の設定を Vespa に反映</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チュートリアルでは <code>hosts.xml</code> のホスト名が若干雑なので <code>WARNING</code> がでていますが、
ノード間で通信はできているため動作上は問題ありません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>チュートリアル付属の <code>utils/vespa_status</code> を実行すると、
<code>vespa2</code> と <code>vepsa3</code> も <code>OK</code> になっていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_status
configuration server ...   [ OK ]
application server (vespa1) ...   [ OK ]
application server (vespa2) ...   [ OK ]
application server (vespa3) ...   [ OK ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、先程の <code>utils/vespa_cluster_status</code> を実行すると、
ドキュメントが3つのノードに分散され、
さらに冗長数が <code>2</code> になるようにコピーが行われている (総数が26件になっている) ことが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_cluster_status -t storage book
=== status of storage ===

| node | status      | bucket-count | uniq-doc-count | uniq-doc-size |
|------|-------------|--------------|----------------|---------------|
|    0 | up          |            7 |              7 |          5079 |
|    1 | up          |           11 |             11 |          7665 |
|    2 | up          |            8 |              8 |          5272 |</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実際にドキュメントの情報が <code>State REST API</code> の結果に反映されるまで少し時間がかかります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>実際に検索すると、初めに登録していた13件のドキュメントが取得できることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ curl 'http://localhost:8080/search/?query=sddocname:book'
{&quot;root&quot;:{&quot;id&quot;:&quot;toplevel&quot;,&quot;relevance&quot;:1.0,&quot;fields&quot;:{&quot;totalCount&quot;:13}, ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustering_state">6.2. クラスタの状態管理</h3>
<div class="paragraph">
<p>Vespa のクラスタを運用する上で、クラスタ内の各ノードの状態を把握することが重要です。
ここでは、Vespa で提供されているコマンドを用いてクラスタの状態を管理する手順について説明します。</p>
</div>
<div class="sect3">
<h4 id="clustering_state_howto">6.2.1. 状態管理の仕組み</h4>
<div class="paragraph">
<p>Vespa では
<a href="http://docs.vespa.ai/documentation/clustercontroller.html">Cluster Controller</a>
と呼ばれるコンポーネントが各ノードの状態を管理しています。
<code>Cluster Controller</code> は <code>services.xml</code> の
<a href="#config_file_services_admin">admin</a> セクションの <code>cluster-controllers</code> で定義していたサーバのことで、
Vespa クラスタ全体の状態管理を担当しています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>実際にはチュートリアルの設定では <code>cluster-controllers</code> を明示的に定義していません。
<code>cluster-controllers</code> の定義が無い場合は <code>configservers</code> のノードが <code>Cluster Controller</code> を兼務します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/img/design/clustercontroller-overview.png">公式ドキュメントの図</a>
のように、<code>Cluster Controller</code> の動作の流れは以下の通りです。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>slobrok</code> (Service Location Broker) からノードのリストを取得</p>
</li>
<li>
<p>各ノードに対して現在の状態を問い合わせ (<code>u/d/m/r</code> は後述のノード状態に対応)</p>
</li>
<li>
<p>得られた情報から最終的なクラスタの状態を更新して全体に通知</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>チュートリアルの例では <code>Cluster Controller</code> は一つのみ指定していますが、
複数指定して冗長構成を取ることも可能です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/slobrok.html">slobrok</a>
は各サービスがどこのホストのどのポートで動作しているかを管理するコンポーネントです。</p>
</div>
<div class="paragraph">
<p><a href="http://docs.vespa.ai/documentation/reference/vespa-cmdline-tools.html#vespa-model-inspect">vespa-model-inspect</a>
コマンドを用いると <code>slobrok</code> に問い合わせることができ、
以下のように指定したサービスのホストと対応するポート番号を取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-model-inspect service container
container @ vespa1 :
container/container.0
    tcp/vespa1:8080 (STATE EXTERNAL QUERY HTTP)
    tcp/vespa1:19100 (EXTERNAL HTTP)
    tcp/vespa1:19101 (MESSAGING RPC)
    tcp/vespa1:19102 (ADMIN RPC)
container @ vespa2 :
container/container.1
    tcp/vespa2:8080 (STATE EXTERNAL QUERY HTTP)
    tcp/vespa2:19100 (EXTERNAL HTTP)
    tcp/vespa2:19101 (MESSAGING RPC)
    tcp/vespa2:19102 (ADMIN RPC)
container @ vespa3 :
container/container.2
    tcp/vespa3:8080 (STATE EXTERNAL QUERY HTTP)
    tcp/vespa3:19100 (EXTERNAL HTTP)
    tcp/vespa3:19101 (MESSAGING RPC)
    tcp/vespa3:19102 (ADMIN RPC)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Cluster Controller</code> を冗長構成にした場合、
内部では <code>Cluster Controller</code> のどれか一つがマスターとなって状態管理を行います。</p>
</div>
<div class="paragraph">
<p>マスターの選別は <code>Cluster Controller</code> 全体での投票により行われ、
過半数以上の票を集めた <code>Cluster Controller</code> がマスターとなります。
このため、例えば <code>N</code> プロセスまでのダウンを許容するようにシステムを構築する場合、
 過半数を担保するため <code>Cluster Controller</code> の総数は <code>2 * N + 1</code> プロセスとする必要があるので注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="clustering_state_node">6.2.2. ノードの状態</h4>
<div class="paragraph">
<p>Vespa クラスタのノードは
<a href="http://docs.vespa.ai/documentation/content/admin-states.html">Cluster and node states</a>
にあるように6つの状態を取りますが、運用上で使うのは起動処理中と停止処理中を除いた以下の4つです。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 16.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">状態</th>
<th class="tableblock halign-center valign-top">意味</th>
<th class="tableblock halign-center valign-top">分散検索の対象?</th>
<th class="tableblock halign-center valign-top">分散配置の対象?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">up</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サービスが提供可能。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">down</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サービスが提供不可能。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maintenance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">メンテナンス中。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retired</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">退役済み。</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>4つと言いましたが、実運用では <code>up</code> と <code>down</code> の2つだけあればだいたいなんとかなります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>表のように、4つはドキュメントの分散検索および分散配置の対象となるかどうか、という観点で動作が異なります。</p>
</div>
<div class="paragraph">
<p><code>up</code> と <code>down</code> は非常にシンプルで、それぞれ全ての対象となるか完全に除外されるかに対応します。</p>
</div>
<div class="paragraph">
<p><code>maintenance</code> は分散検索の対象からは外れますが、分散配置の対象にはなる、という動作をします。
<code>maintenance</code> はソフトウェアの更新作業など、比較的短いメンテナンス作業を行うときの指定が想定された状態で、
少しの間だけなので状態更新に伴うドキュメント再分散の負荷を避けたい、というときに利用します。</p>
</div>
<div class="paragraph">
<p><code>retired</code> は分散検索の対象は維持しますが、分散配置の対象から外れる、という動作をします。
<code>retired</code> では分散配置の対象から外れるため、
状態更新後にノード上にあるドキュメントは0件になるまで (低優先度で) クラスタ内の他のノードへの再分配されていきます。
一方で、<code>retired</code> では分散検索の対象にはなるため、
サービスは提供しながら徐々に担当ドキュメントを別ノードへ逃がしていき、
最終的に0件となったところで役割を終えて引退させる、というような使い方をします。</p>
</div>
<div class="paragraph">
<p>各ノードの状態は <code>vespa-get-node-state</code> というコマンドを用いて取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-get-node-state -i 0 <i class="conum" data-value="1"></i><b>(1)</b>
Shows the various states of one or more nodes in a Vespa Storage cluster. There
exist three different type of node states. They are:

  Unit state      - The state of the node seen from the cluster controller.
  User state      - The state we want the node to be in. By default up. Can be
                    set by administrators or by cluster controller when it
                    detects nodes that are behaving badly.
  Generated state - The state of a given node in the current cluster state.
                    This is the state all the other nodes know about. This
                    state is a product of the other two states and cluster
                    controller logic to keep the cluster stable.

book/distributor.0: <i class="conum" data-value="2"></i><b>(2)</b>
Unit: up:
Generated: up:
User: up:

book/storage.0: <i class="conum" data-value="3"></i><b>(3)</b>
Unit: up:
Generated: up:
User: up:</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>distribution-key=0</code> のノード (<code>-i 0</code>) の状態を取得</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>distributor</code> (ドキュメント分散を行うコンポーネント) の状態</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>storage</code> (ドキュメント保持を行うコンポーネント) の状態</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、クラスタ全体の状態は <code>vepsa-get-cluster-state</code> というコマンドで確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-get-cluster-state

Cluster book:
book/distributor/0: up
book/distributor/1: up
book/distributor/2: up
book/storage/0: up
book/storage/1: up
book/storage/2: up</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clustering_state_check">6.2.3. ノード状態の判定</h4>
<div class="paragraph">
<p>Vespa では、ノードの状態は</p>
</div>
<div class="ulist">
<ul>
<li>
<p>システム的に判断した状態 (<code>Unit state</code>)</p>
</li>
<li>
<p>ユーザが明示的に指定した状態 (<code>User state</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>の2つの情報から最終状態 (<code>Generated state</code>) が判断されます。</p>
</div>
<div class="sect4">
<h5 id="clustering_state_check_unit">Unit state</h5>
<div class="paragraph">
<p><code>Unit state</code> はプロセスの状態から機械的に判断される状態のことです。</p>
</div>
<div class="paragraph">
<p>例えば以下のように <code>vespa2</code> の Docker コンテナを停止されると、
<code>vespa2</code> に対応する <code>distribution-key=1</code> のノードの <code>Unit</code> が <code>down</code> に更新されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose stop vespa2 <i class="conum" data-value="1"></i><b>(1)</b>
Stopping vespa2 ... done

$ sudo docker-compose exec vespa1 /bin/bash <i class="conum" data-value="2"></i><b>(2)</b>

[root@vespa1 /]# vespa-get-node-state -i 1 <i class="conum" data-value="3"></i><b>(3)</b>
...
book/distributor.1:
Unit: down: Connection error: Closed at other end. (Node or switch likely shutdown) <i class="conum" data-value="4"></i><b>(4)</b>
Generated: down: Connection error: Closed at other end. (Node or switch likely
shut down)
User: up:

book/storage.1:
Unit: down: Connection error: Closed at other end. (Node or switch likely shutdown) <i class="conum" data-value="5"></i><b>(5)</b>
Generated: down: Connection error: Closed at other end. (Node or switch likely
shut down)
User: up:</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa2</code> の Docker コンテナを停止</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa1</code> の Docker コンテナにログイン</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>vespa2</code> (<code>distribution-key=1</code>) の状態を確認</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>distributor</code> の <code>Unit state</code> が <code>down</code> に変化</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>storage</code> の <code>Unit state</code> が <code>down</code> に変化</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="clustering_state_check_user">User state</h5>
<div class="paragraph">
<p><code>User state</code> はユーザが明示的に指定したノードの状態のことで、
<code>vespa-set-node-state</code> コマンドを利用して指定します。</p>
</div>
<div class="paragraph">
<p>例えば、<code>vespa3</code> ノードのハードウェアが不調で、Vespa クラスタから明示的に外す (<code>down</code> にする) 場合は、
以下のようなコマンドとなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[root@vespa1 /]# vespa-set-node-state -i 2 down "hardware trouble" <i class="conum" data-value="1"></i><b>(1)</b>
{"wasModified":true,"reason":"ok"}OK
{"wasModified":true,"reason":"ok"}OK

[root@vespa1 /]# vespa-get-node-state -i 2 <i class="conum" data-value="2"></i><b>(2)</b>
...
book/distributor.2:
Unit: up:
Generated: down: hardware trouble
User: down: hardware trouble <i class="conum" data-value="3"></i><b>(3)</b>

book/storage.2:
Unit: up:
Generated: down: hardware trouble
User: down: hardware trouble <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa3</code> (<code>distribution-key=2</code>) の状態を <code>hardware trouble</code> という理由で <code>down</code> に変更</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa3</code> (<code>distribution-key=2</code>) の状態を確認</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>distributor</code> の <code>User state</code> が <code>down</code> に変化</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>storage</code> の <code>User state</code> が <code>down</code> に変化</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>なお、<code>vespa-set-node-state</code> では上記例のように、第2引数でメモを付けることができます (省略も可)。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ノードの状態を明示的に変更することは、
例えば不調なノードが意図せず起動してしまったときに Vespa クラスタに参加させないようにする、
といった意図しない状態更新を抑止する効果があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>maintenance</code> の状態は <code>storage</code> にしか指定できません。
これは、<code>distributor</code> を <code>maintenance</code> にすると、ドキュメント分散自体が止まる可能性があるためです。</p>
</div>
<div class="paragraph">
<p><code>vespa-set-node-state</code> で特定のコンポーネントを指定する場合は、
以下のように <code>-t</code> オプションで指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[root@vespa1 /]# vespa-get-node-state -i 2 -t storage maintenance "update software"</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustering_distrib">6.3. ドキュメントの分散</h3>
<div class="paragraph">
<p>Vespa ではドキュメントを
<a href="http://docs.vespa.ai/documentation/content/buckets.html">bucket</a>
と呼ばれる単位に分割されて管理されます。
<code>bucket</code> という細かい粒度でドキュメントの冗長性を管理することで、
Vespa ではノード増減に対する高い柔軟性を担保しています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>公式ドキュメントでは
<a href="http://docs.vespa.ai/documentation/elastic-vespa.html">Vespa elasticity</a>
にVespaの柔軟性に関する情報がまとめられています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="clustering_distrib_process">6.3.1. Distributor と SearchNode</h4>
<div class="paragraph">
<p>ドキュメントの分散は、ノード状態の話で名前のでてきた <code>Distributor</code> と <code>Storage</code> という2つのコンポーネントが関わってきます。
なお、
<a href="http://docs.vespa.ai/documentation/elastic-vespa.html">公式ドキュメント</a>
では <code>Storage</code> は <code>SearchNode</code> と呼ばれているため、
ここでは <code>SearchNode</code> と呼んでいきます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>より具体的なプロセス名だと、
<code>Distributor</code> は <code>vespa-distributord-bin</code> に、
<code>SearchNode</code> は <code>vespa-proton-bin</code> に対応します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Distributor</code> はドキュメントの分散を担当するコンポーネントで、
各 <code>bucket</code> のチェックサムや割り振り先などのクラスタ全体での <code>bucket</code> の一貫性の担保に関わる情報を管理しています。
<code>Distributor</code> は <code>services.xml</code> で指定された冗長数と <code>Cluster Controller</code> から得られるクラスタの状態を元に、
各 <code>bucket</code> がどこに配置されるべきか、再分配が必要なのか、といったことを判断します。</p>
</div>
<div class="paragraph">
<p><code>SearchNode</code> は実際にインデックスへのアクセスを担当するコンポーネントで、
<code>bucket</code> の本体を保持しています。
<code>SearchNode</code> では Vespa の永続化や検索といった検索エンジンのコア実装が含まれています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>SearchNode</code> のより細かい話は
<a href="http://docs.vespa.ai/documentation/proton.html">Proton</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="clustering_distrib_bucket">6.3.2. bucket の配置と再分配</h4>
<div class="paragraph">
<p><code>bucket</code> の配置は、以下のように各ノードに対して乱数を生成し、
それをソートした順番をもとに優先順位を決めることで行われます。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_bucket_distrib.jpg" alt="vespa bucket distrib" width="700">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>分散アルゴリズムのより詳しい話は
<a href="http://docs.vespa.ai/documentation/content/idealstate.html">Distribution algorithm</a>
を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>得られたノード番号 (<code>distribution-key</code>) 列のうち、一番先頭のノードに <code>bucket</code> のプライマリコピーが、
冗長数に応じてそれ以降のノードに <code>bucket</code> のセカンダリコピーが配置されます。
Vespa ではこのルールに従い、ノードが増減したときの <code>bucket</code> の再分配が行われます。
例えば、冗長数が <code>2</code> の状態でノードが増減したときに <code>bucket</code> の動きは以下のようになります。</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/vespa_bucket_redistrib.jpg" alt="vespa bucket redistrib" width="800">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>各 <code>bucket</code> に割り当てられるシーケンスは常に同じ結果になります。
そのため、
<a href="#config_file_services_content">content</a>
にある「各ノードに割り振られた <code>distribution-key</code> が変わらないようにすること」が重要となるわけです。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="clustering_distrib_example">6.3.3. チュートリアル環境での例</h4>
<div class="paragraph">
<p>チュートリアルの Vespa クラスタを用いて、
実際にノードを増減させた場合にどのような動作をするか見ていきます。
クラスタにドキュメントを全件追加したときの状態は以下のようになっていました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ utils/vespa_cluster_status -t storage book
=== status of storage ===

| node | status      | bucket-count | uniq-doc-count | uniq-doc-size |
|------|-------------|--------------|----------------|---------------|
|    0 | up          |            7 |              7 |          5079 |
|    1 | up          |           11 |             11 |          7665 |
|    2 | up          |            8 |              8 |          5272 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで、試しに <code>vespa2</code> (上図の <code>node=1</code>) の Docker コンテナを停止させると、
<code>vespa2</code> のドキュメントが他の2つのノードに分配されることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose stop vespa2 <i class="conum" data-value="1"></i><b>(1)</b>
Stopping vespa2 ... done

$ utils/vespa_cluster_status -t storage book <i class="conum" data-value="2"></i><b>(2)</b>
=== status of storage ===

| node | status      | bucket-count | uniq-doc-count | uniq-doc-size |
|------|-------------|--------------|----------------|---------------|
|    0 | up          |           13 |             13 |          9008 |
|    1 | down        |            0 |              0 |             0 |
|    2 | up          |           13 |             13 |          9008 |</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa2</code> の Docker コンテナを停止</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa2</code> (<code>node=1</code>) が担当していた11件が他の2ノードに再分配</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>停止させた直後は <code>node=1</code> の状態が <code>maintenance</code> に代わり、
しばらくして <code>down</code> になります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、停止させた <code>vepsa2</code> を再び起動させると、
3つのノードに再分配されて元の状態に戻ることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ sudo docker-compose start vespa2 <i class="conum" data-value="1"></i><b>(1)</b>
Starting vespa2 ... done

$ utils/vespa_cluster_status -t storage book <i class="conum" data-value="2"></i><b>(2)</b>
=== status of storage ===

| node | status      | bucket-count | uniq-doc-count | uniq-doc-size |
|------|-------------|--------------|----------------|---------------|
|    0 | up          |            7 |              7 |          5079 |
|    1 | up          |           11 |             11 |          7665 |
|    2 | up          |            8 |              8 |          5272 |</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vespa2</code> の Docker コンテナを起動</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>3ノードに再分配されて初めの状態に戻る</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustering_other">6.4. その他のトピック</h3>
<div class="sect3">
<h4 id="clustering_other_logging">6.4.1. ログの確認</h4>
<div class="paragraph">
<p><a href="#setup_boot">Vespa の起動</a>
で紹介した構成図のように、
Vespa では各サービスのログは <code>log server</code> に集約されます。
そのため、<code>log server</code> のログを参照することで、クラスタ全体のログを確認できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>log_server</code> は
<a href="#config_file_services_admin">admin</a> セクションの <code>logserver</code> で定義していたサーバのことです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>log server</code> では、以下のように <code>/opt/vespa/logs/vespa/logarchive/</code> の下にログが集約されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# tree /opt/vespa/logs/vespa/logarchive/
/opt/vespa/logs/vespa/logarchive/
└── 2018
    └── 02
        └── 23
            └── 04-0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vespa のログを見るときは
<a href="http://docs.vespa.ai/documentation/reference/logfmt.html">vespa-logfmt</a>
を使うと便利です。
<code>vespa-logfmt</code> は、以下のようにオプションとして多数のログのフィルタが提供されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-logfmt -h
Usage: /opt/vespa/bin/vespa-logfmt [options] [inputfile ...]
Options:
  -l LEVELLIST  --level=LEVELLIST   select levels to include
  -s FIELDLIST  --show=FIELDLIST    select fields to print
  -p PID        --pid=PID           select messages from given PID
  -S SERVICE    --service=SERVICE   select messages from given SERVICE
  -H HOST       --host=HOST                select messages from given HOST
  -c REGEX      --component=REGEX   select components matching REGEX
  -m REGEX      --message=REGEX     select message text matching REGEX
  -f            --follow            invoke tail -F to follow input file
  -L            --livestream        follow log stream from logserver
  -N            --nldequote         dequote newlines in message text field
  -t    --tc    --truncatecomponent chop component to 15 chars
  --ts          --truncateservice   chop service to 9 chars

FIELDLIST is comma separated, available fields:
     time fmttime msecs usecs host level pid service component message
Available levels for LEVELLIST:
     fatal error warning info event debug spam
for both lists, use 'all' for all possible values, and -xxx to disable xxx.</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>vespa-logfmt</code> を引数なしで実行すると、
デフォルトではノードで起動しているサービスのアプリケーションログに対応する
<code>/opt/vespa/logs/vespa/vespa.log</code> が参照されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-logfmt | tail -3
[2018-02-23 04:14:48.700] INFO    : container-clustercontroller Container.com.yahoo.vespa.clustercontroller.core.database.ZooKeeperDatabase        Fleetcontroller 0: Storing new cluster state version in ZooKeeper: 10
[2018-02-23 04:14:58.612] INFO    : container-clustercontroller Container.com.yahoo.vespa.clustercontroller.core.SystemStateBroadcaster        Publishing cluster state version 10
[2018-02-23 04:46:40.991] INFO    : container-clustercontroller stdout        [GC (Allocation Failure)  232656K-&gt;16316K(498112K), 0.0054783 secs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vespa クラスタ全体のログを見る場合は、引数の <code>inputfile</code> として先程のアーカイブログを指定する必要があります。
例えば、<code>vespa2</code> ノードの <code>warning</code> レベルのログが見たい場合は以下のようなコマンドとなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-logfmt -l warning -H vespa2 /opt/vespa/logs/vespa/logarchive/2018/02/23/04-0 | tail -3
[2018-02-23 04:14:35.944] WARNING : searchnode       proton.searchlib.docstore.logdatastore        We detected an empty idx file for part '/opt/vespa/var/db/vespa/search/cluster.book/n1/documents/book/2.notready/summary/1519358811014181000'. Erasing it.
[2018-02-23 04:14:35.944] WARNING : searchnode       proton.searchlib.docstore.logdatastore        Removing dangling file '/opt/vespa/var/db/vespa/search/cluster.book/n1/documents/book/1.removed/summary/1519358811013672000.dat'
[2018-02-23 04:14:35.944] WARNING : searchnode       proton.searchlib.docstore.logdatastore        Removing dangling file '/opt/vespa/var/db/vespa/search/cluster.book/n1/documents/book/2.notready/summary/1519358811014181000.dat'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チュートリアルの例では時間が標準時間となっていますが、
これは起動している環境のタイムゾーンが <code>UTC</code> のためです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# date
Fri Feb 23 04:56:06 UTC 2018</code></pre>
</div>
</div>
<div class="paragraph">
<p>タイムゾーンを <code>JST</code> で実行すれば、ログのタイムスタンプも日本時間になります (なるはず)。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="clustering_other_metrics">6.4.2. メトリクスの取得</h4>
<div class="paragraph">
<p>Vespa では、検索レイテンシなどのメトリクスを取得するための
<a href="http://docs.vespa.ai/documentation/reference/metrics-health-format.html">Metrics API</a>
が提供されています。</p>
</div>
<div class="paragraph">
<p><code>Metrics API</code> が提供されているポートはサービスによって異なります。
各サービスで提供されているポートは
<a href="http://docs.vespa.ai/documentation/reference/vespa-cmdline-tools.html#vespa-model-inspect">vespa-model-inspect</a>
コマンドを使うことで確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[root@vespa1 /]# vespa-model-inspect service container <i class="conum" data-value="1"></i><b>(1)</b>
container @ vespa1 :
container/container.0
    tcp/vespa1:8080 (STATE EXTERNAL QUERY HTTP) <i class="conum" data-value="2"></i><b>(2)</b>
    tcp/vespa1:19100 (EXTERNAL HTTP)
    tcp/vespa1:19101 (MESSAGING RPC)
    tcp/vespa1:19102 (ADMIN RPC)
container @ vespa2 :
container/container.1
    tcp/vespa2:8080 (STATE EXTERNAL QUERY HTTP)
    tcp/vespa2:19100 (EXTERNAL HTTP)
    tcp/vespa2:19101 (MESSAGING RPC)
    tcp/vespa2:19102 (ADMIN RPC)
container @ vespa3 :
container/container.2
    tcp/vespa3:8080 (STATE EXTERNAL QUERY HTTP)
    tcp/vespa3:19100 (EXTERNAL HTTP)
    tcp/vespa3:19101 (MESSAGING RPC)
    tcp/vespa3:19102 (ADMIN RPC)

[root@vespa1 /]# vespa-model-inspect service searchnode <i class="conum" data-value="3"></i><b>(3)</b>
searchnode @ vespa1 : search
book/search/cluster.book/0
    tcp/vespa1:19109 (STATUS ADMIN RTC RPC)
    tcp/vespa1:19110 (FS4)
    tcp/vespa1:19111 (UNUSED)
    tcp/vespa1:19112 (UNUSED)
    tcp/vespa1:19113 (STATE HEALTH JSON HTTP) <i class="conum" data-value="4"></i><b>(4)</b>
searchnode @ vespa2 : search
book/search/cluster.book/1
    tcp/vespa2:19108 (STATUS ADMIN RTC RPC)
    tcp/vespa2:19109 (FS4)
    tcp/vespa2:19110 (UNUSED)
    tcp/vespa2:19111 (UNUSED)
    tcp/vespa2:19112 (STATE HEALTH JSON HTTP)
searchnode @ vespa3 : search
book/search/cluster.book/2
    tcp/vespa3:19108 (STATUS ADMIN RTC RPC)
    tcp/vespa3:19109 (FS4)
    tcp/vespa3:19110 (UNUSED)
    tcp/vespa3:19111 (UNUSED)
    tcp/vespa3:19112 (STATE HEALTH JSON HTTP)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>container</code> サービス (検索リクエストを受けるところ) のポートを確認</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>vespa1</code> ノードでは <code>8080</code> ポート</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>searchnode</code> サービス (インデックスを管理してるところ) のポートを確認</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>vespa1</code> ノードでは <code>19113</code> ポート</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>実際に <code>Metrics API</code> を用いると、以下のように <code>json</code> 形式でメトリクスが取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[<span class="error">r</span><span class="error">o</span><span class="error">o</span><span class="error">t</span><span class="error">@</span><span class="error">v</span><span class="error">e</span><span class="error">s</span><span class="error">p</span><span class="error">a</span><span class="integer">1</span> <span class="error">/</span>]<span class="error">#</span> <span class="error">c</span><span class="error">u</span><span class="error">r</span><span class="error">l</span> <span class="error">'</span><span class="error">h</span><span class="error">t</span><span class="error">t</span><span class="error">p</span>:<span class="error">/</span><span class="error">/</span><span class="error">l</span><span class="error">o</span><span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">h</span><span class="error">o</span><span class="error">s</span><span class="error">t</span>:<span class="integer">8080</span><span class="error">/</span><span class="error">s</span><span class="error">t</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">/</span><span class="error">v</span><span class="integer">1</span><span class="error">/</span><span class="error">m</span><span class="error">e</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">c</span><span class="error">s</span><span class="error">'</span>
{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">metrics</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">snapshot</span><span class="delimiter">&quot;</span></span>: {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="float">1.519363748005E9</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>: <span class="float">1.519363808005E9</span>
        },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: [
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">search_connections</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">average</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">last</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">max</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">min</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">rate</span><span class="delimiter">&quot;</span></span>: <span class="float">0.016666666666666666</span>
                }
            },
            <span class="error">.</span><span class="error">.</span><span class="error">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>返却されるメトリクスは <code>snapshot</code> に書かれた期間でのスナップショットに対応しており、
デフォルトのインターバルは <code>container</code> ノードが <code>300秒</code> が、
<code>searchnode</code> ノードが <code>60秒</code> (たぶん) となっています。
各メトリクスは <code>values</code> として複数の値を返しますが、共通の項目は以下のように定義されます。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">項目</th>
<th class="tableblock halign-center valign-top">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">期間中にメトリクスが計測された回数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">average</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">期間中のメトリクスの平均値 (<code>sum/count</code>)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1秒あたりの計測回数 (<code>count/s</code>)。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">期間中の最小値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">期間中の最大値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">期間中のメトリクスの総和。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>各サービスで色々なメトリクスが出力されますが、例えば以下のようなメトリクスがとれます。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">項目</th>
<th class="tableblock halign-center valign-top">サービス</th>
<th class="tableblock halign-center valign-top">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クエリの処理数、<code>rate</code> がいわゆるQPS。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">query_latency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検索レイテンシの統計値。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">proton.numdocs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchnode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">インデックスされているドキュメント数。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>具体的なメトリクス周り公式ドキュメントが
<a href="http://docs.vespa.ai/documentation/jdisc/metrics.html#metrics-from-custom-components">このあたり</a>
しかなく、正直どれがどれに対応しているかはコードを確認する必要があるのが現状です。。。</p>
</div>
<div class="paragraph">
<p>実際のサービスだとこれに加えて更新リクエストの方もチェックしていましたが、
それは投げる側でモニタリングしていたため、Vespa の <code>Metrics API</code> は経由していませんでした。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>container</code> から返されるメトリクスで
<code>query_latency</code>、<code>mean_query_latency</code>、<code>max_query_latency</code>
の3つは、Vespa側の実装のバグっぽくて全て同じ値になります (<code>query_latency</code> と同じ挙動)。</p>
</div>
<div class="paragraph">
<p>ただ、実際のところ <code>query_latency</code> の統計値で3つともわかるため、
残りの2つは冗長な出力に見えます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="comparing">7. Solr/Elasticsearch との機能比較</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、Vespa と他の検索エンジンを比べて、
具体的にどのような差異があるのか見ていきます。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>著者の個人的な見解がかなり含まれます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://vespa.ai/">Vespaの公式ページ</a>
の下の方にも機能比較表があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでは、比較対象として
<a href="http://lucene.apache.org/solr/">Solr</a>
と
<a href="https://www.elastic.co/jp/products/elasticsearch">Elasticsearch</a>
の2つを取り上げます。
Solr と Elasticsearch は共に Lucene をコアとする検索エンジンで、
世界的にも多くの利用実績がある代表的な OSS の一つです。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>チュートリアルには <code>appendix</code> に Solr と Elasticsearch の Docker コンテナの設定があります。
それぞれのディレクトリに配置された <code>boot.sh</code> を実行することで Vespa と同じドキュメントを含む Solr および Elasticsearch を起動できます。
詳しいコマンドは <code>appendix</code> にある <code>README.md</code> を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="comparing_update">7.1. スキーマと更新</h3>
<div class="sect3">
<h4 id="comparing_update_dynamic">7.1.1. 動的フィールド</h4>
<div class="paragraph">
<p>Solr/Elasticsearch と Vespa のスキーマ定義を比較したとき、
大きな違いの一つとして動的フィールドのサポートの有無があります。</p>
</div>
<div class="paragraph">
<p>Solr では <code>dynamic fields</code> を、
Elasticsearch では <code>dynamic templates</code> を使ってインデックスされたフィールド名に応じて動的にフィールドを追加することができます。
この機能によって、Solr/Elasticsearch ではスキーマに縛られにくい柔軟なインデクシングを可能としています。
特に、Elasticsearch では
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/object.html">Object datetype</a>
のようにかなり自由なデータをインデクシングできるのが特徴です。</p>
</div>
<div class="paragraph">
<p>一方、Vespa では前述のような動的フィールドに対応する機能は現状では提供されていません。
そのため、ユーザは事前にスキーマ設計をしっかりと行うことが求められます。</p>
</div>
<div class="paragraph">
<p>サービスとして検索エンジンを使う場合、
一般的にスキーマ設計を行うはずなので双方であまり差異はありませんが、
データストアとして検索エンジンを使う場合は、
動的フィールドが可能な Solr/Elasticsearch の方が柔軟性が高いと考えられます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>データストア・アナリシス的な用途なら
<a href="https://www.elastic.co/jp/products">Elastic Stack</a>
が有名かと思います。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="comparing_update_type">7.1.2. データ型</h4>
<div class="paragraph">
<p>Vespa、Solr/Elasticsearch ともに基本的なデータ型については大きな差異はありません。
2つで動作が大きく異なるケースとして、配列のような多次元の値を扱う場合があげられます。</p>
</div>
<div class="paragraph">
<p>Vespa では
<a href="#config_file_searchdefinitions">searchdefinitions</a>
で述べたように、<code>array</code> と <code>weightedset</code> という2つの型をサポートしています。
Vespa での複数値は、
<a href="#ranking_expression_feature_attribute">attribute</a>
といった関数を用いてインデックスやキーで各値に個別アクセスができ、
値の順序 (例えば階層構造とか) に意味を持たせることができます。
また、Vespa では
<a href="#ranking_other_tensor">テンソルを用いたスコア計算</a>
で述べたテンソル型という高次元のデータ型を保持することができ、
近年注目を集めている分散表現やディープライーニングといった先進技術との親和性が高いことも大きなポイントです。</p>
</div>
<div class="paragraph">
<p>一方、Solr/Elasticsearch の場合、配列型以外については設計を工夫する必要があります。
チュートリアルの例では、前述の動的フィールドを用いてマッピングを行うことで Vespa の <code>weightedset</code> の代替としています。
この方法では、キーとなる新しい値が登録されるたびに裏側では新しいフィールドが定義されることとなるため、
キーのバリエーションが非常に多いケースを扱うことが困難です。
また、高次元ベクトルを検索で扱う場合に、Solr/Elasticsearch ではまだ適切なデータ型がないように感じます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Solr/Elasticsearch の配列は、インデックス上では投入順序が保持されないという特徴があります。
これは、内部で利用している Lucene の <code>docValues</code> というデータストアが、
複数値を登録する時にソートして値を保持するという制約があるためです。
そのため、Vespa のようにインデックス指定で値を取得する、ということができません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Solr/Elasticsearch でも拡張フィールドを独自実装すれば、<code>weightedset</code> のような型を作ることは一応可能です。
ただし、スコア計算との連携なども考えた場合、ランキング部分についても拡張が必要になります。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="comparing_update_realtime">7.1.3. リアルタイム性</h4>
<div class="paragraph">
<p>Solr/Elasticsearch の基盤となっている Lucene では、
<code>softCommit</code> と <code>hardCommit</code> という2つのコミットによってインデックスを管理します。
前者は更新内容を検索できるようにするもの、後者は更新内容をディスクに永続化するものに対応します。
Solr/Elasticsearch では、この <code>softCommit</code> の間隔を制御することで Near Real Time (NRT) 検索を実現しています (
<a href="https://lucene.apache.org/solr/guide/7_2/near-real-time-searching.html">Solr</a>、
<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/near-real-time.html">Elasticsearch</a>
)。
より高いリアルタイム性が必要な場合、この <code>softCommit</code> の間隔をチューニングすることになりますが、
<code>softCommit</code> では <code>Searcher</code> と呼ばれる検索を担当するインスタンスの再生成が走るため、
実行にある程度のコストがかかります。
そのため、<code>softCommit</code> の頻度が検索などのパフォーマンスに影響を与え、
性能要件によっては短い時間を設定することが困難な場合が多いです。</p>
</div>
<div class="paragraph">
<p>Vespa では公式ドキュメントの
<a href="http://docs.vespa.ai/documentation/features.html">Features</a>
や
<a href="http://docs.vespa.ai/documentation/content/consistency.html">Vespa consistency model</a>
で述べられているように、
更新リクエストのレスポンスが返ったタイミングで検索の対象となるように設計されています。
そのため、ドキュメント更新のリアルタイム性が非常に高い検索エンジンといえます。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vespa のインデクシングの中身の詳細については公式ドキュメントが特になかったため、
ここでは上記 Vespa のドキュメントでの謳い文句と運用での経験ベースに話をしています。</p>
</div>
<div class="paragraph">
<p>Vespa のインデックスのざっくりとした流れは
<a href="http://docs.vespa.ai/documentation/performance/sizing-search.html">Vespa search sizing guide</a>
の <code>Search/Content Node</code> で議論されており、
新規ドキュメントはオンメモリ上のインデックス (<code>memory index</code>) に追加され、
サイズや時間経過を条件に適宜ディスク上のインデックスに書き出される、という動作をします。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing_search">7.2. 検索周り</h3>
<div class="sect3">
<h4 id="comparing_search_aggregation">7.2.1. 集約処理</h4>
<div class="paragraph">
<p>単純な検索機能については Vespa と Solr/Elasticsearch では大きな差はないですが、
集約処理については Vespa と Solr/Elasticsearch で差異があります。</p>
</div>
<div class="paragraph">
<p>検索結果を羅列する <code>grouping</code> という観点では、
Vespa と Elasticsearch については大きく差異はない印象です。
Vespa なら
<a href="#search_grouping">グルーピング検索</a>
で紹介したように、
<a href="http://docs.vespa.ai/documentation/reference/grouping-syntax.html">Query result grouping reference</a>
に記載された DSL を用いて多段グルーピングができ、
Elasticsearch も
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">Aggregations</a>
の
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html">top_hits</a>
を組み合わせることで多段グルーピングが可能です。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Solr は多段グルーピングをサポートしていません。
また、
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-collapse.html">Field Collapsing</a>
については集約処理とは若干用途が異なるので議論の対象から外しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>一方、グループ内でのソートでは、Vespa は
<a href="#ranking">Vespa とランキング</a>
で紹介した <code>rank-profile</code> の定義をそのままグループ内のリランキングに適用できるため、
Solr/Elasticsearch に比べてグループ内の上位をより精度よく選択することができます。</p>
</div>
<div class="paragraph">
<p>各グループの統計値といった特定の側面を計算する <code>faceting</code> という観点では、
Solr/Elasticsearch の方が Vespa に比べて機能が豊富のように感じます。
前述の DSL のお陰で Vespa は <code>faceting</code> でも様々な集約条件を定義できます。
一方、Solr では
<a href="https://lucene.apache.org/solr/guide/7_2/streaming-expressions.html">Streaming Expressions</a>
を用いることで、検索結果をストリーミング処理の要領で細かく加工することが可能です。
また、Elasticsearch も
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">Aggregations</a>
で紹介されているような多くの集約処理があったり、
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html">Scripting</a>
で細かい調整が可能だったりと高機能です。</p>
</div>
</div>
<div class="sect3">
<h4 id="comparing_search_advanced">7.2.2. 高度な検索機能</h4>
<div class="paragraph">
<p><a href="#search_other">その他の検索</a>
で紹介したように、
WAND 検索、Predicate フィールド
と Vespa には Solr/Elasticsearch にはない検索機能があります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>位置検索は Solr/Elasticsearch にもあります。
また、ストリーミング検索については Solr/Elasticsearch のワイルドカードクエリと対応します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Predicate フィールドについては、Elasticsearch では
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-percolate-query.html">Percolate Query</a>
という似た機能が存在しますが、Percolate Query ではクエリをインデックスに登録して入力ドキュメントに対して当てるという動作なのに対し、
Vespa の Predicate フィールドは各ドキュメントのフィールド値として条件式を埋め込むため、
各ドキュメントを個別に制御できる点が異なります。</p>
</div>
<div class="paragraph">
<p>これらの機能は単純な全文検索ではなかなか使うタイミングがありませんが、
レコメンド、広告、メールなど具体的にターゲットを絞った場合に恩恵を受けられるケースがあるかもしれません。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing_ranking">7.3. ランキング</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ランキングは OSS で利用できる範囲での比較になります。
そのため、Solr の有償プロダクトである
<a href="https://lucidworks.com/products/">Fusion</a>
や、Elasticsearch の有償の
<a href="https://www.elastic.co/jp/products/x-pack">X-PACK</a>
で提供されている機能については対象外としています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="comparing_ranking_phase">7.3.1. フェーズ分け</h4>
<div class="paragraph">
<p>検索エンジンのコア機能を使って任意のスコア式を記述する場合、
Solr は
<a href="https://lucene.apache.org/solr/guide/7_2/function-queries.html">FunctionQuery</a>
を、Elasticsearch は
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#score-functions">FunctionScoreQuery</a>
を用いてスコアを定義します。
また、最近では上位の結果をリランキングするプラグインとして Solr と Elasticsearch それぞれで
LTR (Learning To Rank) プラグインが提供されています (
<a href="https://lucene.apache.org/solr/guide/7_2/learning-to-rank.html">Solr</a>、
<a href="http://elasticsearch-learning-to-rank.readthedocs.io/en/latest/">Elasticsearch</a>
)。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Solr ではこれに加えて
<a href="https://lucene.apache.org/solr/guide/7_2/query-re-ranking.html">ReRakQParserPlugin</a>
と <code>FunctionQuery</code> を組み合わせる方法もあります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vespa の
<a href="#ranking_phase">ランキングの流れ</a>
と対応させると、
Solr の <code>FunctionQuery</code> および Elasticsearch の <code>FunctionScoreQuery</code> が <code>first-phase</code> に、
LTRプラグインが <code>second-phase</code> に対応します。</p>
</div>
<div class="paragraph">
<p>このように、Solr と Elasticsearch では2つのフェーズのランキングが別の機能として提供されます。
そのため、2つのフェーズでスコア式を記述する場合、別々に定義を書かなくてはならないというのがネックです。
それに対して、Vespa は <code>rank-profile</code> に全てまとめて定義できるため、
ランキングの定義は Vespa の方がスッキリしています。</p>
</div>
</div>
<div class="sect3">
<h4 id="comparing_ranking_dsl">7.3.2. 記述の自由度</h4>
<div class="paragraph">
<p>単純な記述の自由度という観点では、
最も自由度が高いのは
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html">Scripting</a>
を用いて Groovy ライクに書ける Elasticsearch の <code>Function Score Query</code> かと思います。
ただし、<code>Scripting</code> ではいわゆる素性が扱えないため、
高度なモデルを定義したい場合にネックになると考えられます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Scripting</code> は
<a href="http://asm.ow2.org/">ASM</a>
を用いてバイトコードを動的に生成することで高速動作させています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>一方、Solr と Elasticsearch の LTR プラグインでは、
検索クエリを素性として定義できるため、より精度の高いモデルを定義できます。
ただ、こちらはデフォルトで利用できるモデルの型が線形モデルとアンサンブル木に限定されており、
チュートリアルの <code>price_boost</code> のような独自の数式を書きたい場合は、
別途対応するモデルを実装する必要があるというのが難点です。</p>
</div>
<div class="paragraph">
<p>Vespa はランク式を DSL として提供しつつ、
<a href="#ranking_expression_feature">組み込み素性</a>
で紹介したように様々なランク素性が利用できるため、自由に高度なモデルの記述が可能です。
また、検索クエリを使う LTR プラグインと異なり、これらランク素性はコードとして実装されているため動作が速いのも特徴です。
ただし、組み込みの素性以外を使いたいという場合、<code>rank-profile</code> のマクロとして数式の定義はできますが、
全く新しい素性を実装して追加するためには検索コアの実装に手を加える必要があり、難易度が高いです。</p>
</div>
</div>
<div class="sect3">
<h4 id="comparing_ranking_advanced">7.3.3. 高度なランキング</h4>
<div class="paragraph">
<p><a href="#ranking_other_tensor">テンソルを用いたスコア計算</a>
で紹介したテンソルへの対応は、Vespa がもつ非常に強力な機能です。
内積や行列演算は state-of-the-art な手法をランキングで用いたい場合に必要になる機能なので、
検索エンジンが標準でそれをサポートしている意味は大きいです。</p>
</div>
<div class="paragraph">
<p>また、
<a href="#search_other_wand">WAND 検索</a>
もランキングの視点で見ると疎ベクトルの内積計算に対応しており、
Vespa の持つ高度なランキング機能の一つと捉えることができます。</p>
</div>
<div class="paragraph">
<p>WAND 検索については、
Solr/Elasticsearch でも payload でテキストの単語に重みを埋め込み、
検索クエリにブースト値を付与してスコア計算に組み込めば似たようなことは可能です。
ただし、WAND 検索のような賢い枝刈りアルゴリズムがないため、Vespa より速度がでないと思います。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>最近では Solr コミュニティで
<a href="https://deeplearning4j.org/">DL4J</a>
を LTR プラグインに組み込もうという動きもあります (
<a href="https://issues.apache.org/jira/browse/SOLR-11838">SOLR-11838</a>
)。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing_scalability">7.4. スケーラビリティ</h3>
<div class="sect3">
<h4 id="comparing_scalability_distrib">7.4.1. 分散インデクシング</h4>
<div class="paragraph">
<p>Vepsa は
<a href="#clustering_distrib">ドキュメントの分散</a>
でも述べたように、ドキュメントを <code>bucket</code> という細かい粒度で分散させるのが特徴で、
ここは Solr/Elasticsearch と大きく異なる点の一つです。</p>
</div>
<div class="paragraph">
<p>Solr/Elasticsearch では、クラスタ上でのインデックスの分割数 (シャード数) を事前に決めて分散インデクシングを行います。
このシャード数は、一度決めると容易にその数を変更することができず、
変更する場合はシャードの分割やインデックスの再構築が必要となります。</p>
</div>
<div class="paragraph">
<p>一方、Vespa は <code>bucket</code> というより細かい粒度でドキュメントを管理しており、
その分割数も状況によって増減します。
そのため、ユーザはインデックスの冗長数 (Solr/Elasticsearch のレプリカ数) だけを意識すればよく、
分散インデクシングの管理が非常に容易かつ効率的に行うことができます。</p>
</div>
<div class="paragraph">
<p>ドキュメントを細かい粒度で分散させることは、障害時のパフォーマンスという観点でも有意性があります。
Solr/Elasticsearch の場合、特定のノードがダウンすると、
本来そのノードが処理するはずだったリクエストを対応するレプリカを持つノード群が肩代わりします。
そのため、障害時に特定のノードのリクエスト数が <code>1 + 1/#replicas</code> 倍に増加することになります。
一方、Vespa の場合、特定のノードがダウンしたとしても、対になる <code>bucket</code> はクラスタ全体に分散しているため、
ダウンしたノードのリクエストをクラスタ全体でカバーすることができ、
リクエスト数の増加を <code>1 + 1/#nodes</code> 倍に抑えることができます。
基本的に <code>#nodes &gt; #replicas</code> となるため、障害時の負荷増加は Vespa の方が小さくなります。</p>
</div>
</div>
<div class="sect3">
<h4 id="comparing_scalability_node">7.4.2. ノードの追加・削除</h4>
<div class="paragraph">
<p>クラスタへのノードの追加・削除も、
Vespa では非常に簡単に行うことができます。</p>
</div>
<div class="paragraph">
<p>Solr/Elasticsearch の場合、前述のようにシャード数が変更できないため、
ノードの増減にあわせてシャード/レプリカ単位での再分配を行うことになります。
この作業は、Elasticsearch の場合、再分配は自動で行われますが、Solr の場合は現状手作業で行う必要があります。
シャード自体の分割が困難なため、ノード追加・削除が発生した場合、
場合によってはシャード数を再設計して再インデックスする必要があります。</p>
</div>
<div class="paragraph">
<p>Vespa では、
<a href="#clustering_setup_deploy">クラスタ設定の反映</a>
の例で示したように、<code>services.xml</code> と <code>hosts.xml</code> に追加・削除するノードの情報を追記して反映させるだけで、
Vespa が <code>bucket</code> の再分配を行ってくれます。
また、Solr/Elasticsearch のようにシャード数を気にする必要もないため、
カジュアルにノードの増減を行うことが可能です。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing_extensibility">7.5. 拡張性</h3>
<div class="sect3">
<h4 id="comparing_extensibility_language">7.5.1. 多言語対応</h4>
<div class="paragraph">
<p>多言語対応という点では、現状 Vespa は Solr/Elasticsearch に比べると大きく差があります。</p>
</div>
<div class="paragraph">
<p>Solr/Elasticsearch は世界的に利用実績があるため、現状で多くの言語をサポートしています。
また、Solr/Elasticsearch の言語処理は、
入力文字列の1文字1文字に変換を加える <code>CharFilter</code>、
文字列をトークン分けする <code>Tokenizer</code>、
トークン毎に変換を加える <code>TokenFilter</code>
の3つのクラスの組み合わせによって定義されます (
<a href="https://lucene.apache.org/solr/guide/7_2/understanding-analyzers-tokenizers-and-filters.html">Solr</a>、
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer-anatomy.html">Elasticsearch</a>
)。
そのため、これらの組み合わせ方によって言語処理フローを柔軟に構築できるというのも特徴の一つです。</p>
</div>
<div class="paragraph">
<p>一方、Vespa は OSS としてまだ若いこともあり、公式でサポートしている言語は今のところ英語圏に限られています。
Vespa では
<a href="http://docs.vespa.ai/documentation/linguistics.html">Linguistics</a>
というクラスを拡張することで対応言語を増やすことができます。
Solr/Elasticsearch とは異なり、
Vespa ではステミングや正規化といった処理も <code>Lingusitics</code> の中に内包させます。
幸い、今回使用した <code>KuromojiLinguistics</code> のように、
既存のパッケージを組み合わせれば対応自体はそこまで難しくはないので、
今後ユーザが増えていって多言語対応の差自体が埋まっていくことを期待します。</p>
</div>
</div>
<div class="sect3">
<h4 id="comparing_extensibility_plugin">7.5.2. プラグインの追加</h4>
<div class="paragraph">
<p>Solr/Elasticsearch は、
世の中にサードパーティ製のプラグインがたくさんあることからも分かるように、
拡張性が高い検索エンジンとなっています。
また、Solr/Elasticsearch は Pure Java で実装された検索エンジンなので、
機能開発の敷居も比較的低いといえます。</p>
</div>
<div class="paragraph">
<p>Vespa でプラグインを追加する場合は、基本的に
<a href="#config_file_services_container">container</a>
にプラグインを追加していく形になります。
典型的な拡張は、
検索リクエスト/レスポンスの加工を行う <code>Searcher</code>、
更新リクエストの加工を行う <code>DocumentProcessor</code> の追加です。
これらはサーブレット・フィルタのようにチェインさせてパイプライン処理させるように利用します(
<a href="http://docs.vespa.ai/documentation/component-types.html">Container component types</a>
)。
また、Vespa の <code>container</code> は
<a href="http://docs.vespa.ai/documentation/jdisc/">JDisc</a>
(Java Data Intensive Serving Container) というフレームワークの上で動作しており、
内部で独自のサーバを立てたり、DI コンテナでインジェクトするインスタンスを差し替えたりと、
色々自由に動作を変えることができます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>前述の <code>Linguistics</code> も JDisc の DI コンテナ経由で独自実装をインジェクトすることで動作を差し替えています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>一方、Vespa の検索コアは
<a href="http://docs.vespa.ai/documentation/proton.html">proton</a>
と呼ばれる C++ のパッケージとなっており、
こちらに機能を追加したい場合はコードを実装して再ビルドする必要があります。
そのため、検索コアの深いところまで手を加えたい場合、
Vespa は Solr/Elasticsearch に比べると実装難易度が高いです。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing_summary">7.6. まとめ</h3>
<div class="paragraph">
<p>ここまで述べてきた Vespa と Solr/Elasticsearch の特徴を、
<a href="http://vespa.ai/">公式サイト</a>
の表のようにまとめると以下のようになります。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 50.0002%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">特徴</th>
<th class="tableblock halign-center valign-top">Vespa</th>
<th class="tableblock halign-center valign-top">Solr/Elasticsearch</th>
<th class="tableblock halign-center valign-top">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">データ解析</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆☆</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Solr/Elasticsearch は動的フィールドが使える</p>
</li>
<li>
<p>Solr/Elasticsearch の方が解析処理が充実してる印象</p>
</li>
<li>
<p>Elastic Stack のように周辺パッケージも充実</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">全文検索</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆☆</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>両方とも検索・集約の基本機能はカバー</p>
</li>
<li>
<p>Vespa では WAND 検索のような高度な検索機能を提供</p>
</li>
<li>
<p>インデクシングが Vespa の方が優秀</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">ランキング</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆☆</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Vespa は標準機能でランキングをフルサポート</p>
</li>
<li>
<p>フェーズ制御が Vespa の方がしっかりしてる</p>
</li>
<li>
<p>テンソルが使えるなど Vespa の方が先進的</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">スケーラビリティ</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆☆</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Vespa の方が分散粒度が細かく柔軟性が高い</p>
</li>
<li>
<p>ノード増減時のインデックス調整が Vespa の方が楽</p>
</li>
<li>
<p>Solr/Elasticsearch はシャード数が変更しづらい</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">拡張性</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">☆☆☆</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Solr/Elasticsearch の方が敷居は低め</p>
</li>
<li>
<p>Vespa も自由度は高いが検索コアがいじりにくい</p>
</li>
<li>
<p>多言語対応などの既存遺産の差が大きい</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>見解としては公式サイトでの表と同じで、全文検索がしたいなら Vespa はよい選択肢になると思います。
逆に、データ解析での利用を検討している場合は、Elastic Stack のようなパッケージを利用した方が効率的かと思います。</p>
</div>
<div class="paragraph">
<p>機能面では、まずランキング機能が Solr/Elasticsearch と比べてかなり先進的で、
特にテンソルが扱えることで、近年話題の Deep Learning 系の技術を取り込める点は大きな強みです。
また、ドキュメント分散の仕組みが賢く、スケールアウトが容易な点も、
特に大規模なクラスタを組むようなケースで大きなポイントになるかと思います。</p>
</div>
<div class="paragraph">
<p>一方、拡張性という観点では、OSS としてまだ若いこともあり、
Solr/Elasticsearch に比べてサードパーティ製のプラグインなどのオプションが少ないところはネックかと思います。
Vespa 自体の拡張性は JDisc のおかげで非常に高いのですが、
個人的には検索コアに手が入れにくいところが気になる部分で、
このため拡張性については公式サイトと優劣を逆につけています。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.1.0<br>
Last updated 2018-03-14 09:42:54 JST
</div>
</div>
<!--
  Copyright 2018 Yahoo Japan Corporation.
  Licensed under the terms of the MIT license.
  See LICENSE in the project root.
-->
<p align="center">
Copyright (C) 2018 Yahoo Japan Corporation. All Rights Reserved.
</p>
</body>
</html>